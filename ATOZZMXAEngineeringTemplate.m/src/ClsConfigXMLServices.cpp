//===================================================================
// COPYRIGHT ATOZ 2020/05/28
//===================================================================
// ClsConfigXMLServices.cpp
// Header definition of class ClsConfigXMLServices
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2020/05/28 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ClsConfigXMLServices.h"

HMODULE GetCurrentModuleHandle()
{
	MEMORY_BASIC_INFORMATION mbi;
	::VirtualQuery((LPVOID)GetCurrentModuleHandle, &mbi, sizeof(mbi));
	return (HMODULE)mbi.AllocationBase;
}
//-----------------------------------------------------------------------------
// ClsConfigXMLServices : constructor
//-----------------------------------------------------------------------------
ClsConfigXMLServices::ClsConfigXMLServices()
{
//
//TODO: Add the constructor code here
//
}

//-----------------------------------------------------------------------------
// ClsConfigXMLServices : destructor
//-----------------------------------------------------------------------------

ClsConfigXMLServices::~ClsConfigXMLServices()
{
//
// TODO: Place code here.
//
}

//get dllPath
HRESULT ClsConfigXMLServices::Get_ComputeDataExePath(CATUnicodeString &strExePath)
{
	char chCurrentWorkDirectory[1024] = { 0 };//当前路径
	GetModuleFileNameA(GetCurrentModuleHandle(), chCurrentWorkDirectory, 1024);
	if (chCurrentWorkDirectory == '\0')
	{
		return E_FAIL;
	}

	strExePath = chCurrentWorkDirectory;

	int nKeyWordsPosition = 0;
	nKeyWordsPosition = strExePath.SearchSubString("bin", 0, CATUnicodeString::CATSearchModeForward);
	if (-1 == nKeyWordsPosition)
	{
		cout << "ERROR InstallPath Changed!" << endl;
		return E_FAIL;
	}

	strExePath.Remove(nKeyWordsPosition, strExePath.GetLengthInChar() - nKeyWordsPosition);
	return S_OK;
}

//open xml 
HRESULT ClsConfigXMLServices::OpenXMLByfullName(CATUnicodeString istrXMLPath,
	                                            CATIDOMDocument_var &ospDOMDocument)
{
	if (CATUnicodeString("") == istrXMLPath) return E_FAIL;

	HRESULT rc(E_FAIL);

	CATIXMLDOMDocumentBuilder_var builder = NULL_var;
	rc = ::CreateCATIXMLDOMDocumentBuilder(builder);
	if (FAILED(rc) || NULL_var == builder) return E_FAIL;

	//CATIXMLSAXFactory_var spIXMLSAXFactory(NULL_var);
	//rc = ::CreateCATIXMLSAXFactory(spIXMLSAXFactory);

	CATIXMLSAX2Factory_var   spIXMLSAXFactory(NULL_var);
	rc = ::CreateCATIXMLSAX2Factory(spIXMLSAXFactory);
	if (FAILED(rc) || NULL_var == spIXMLSAXFactory)
		return E_FAIL;

	CATListOfCATUnicodeString strListOfReadOption(1);
	strListOfReadOption.Append(CATUnicodeString("CATDoValidation"));
	CATListOfCATUnicodeString strListOfReadOptionValue(1);
	strListOfReadOptionValue.Append(CATUnicodeString("false"));

	rc = builder->Parse(istrXMLPath, ospDOMDocument, strListOfReadOption, strListOfReadOptionValue);
	if (FAILED(rc) || NULL_var == ospDOMDocument) return E_FAIL;

	return S_OK;
}
//获取配置的CUPS 名称
HRESULT ClsConfigXMLServices::GetCUPSConfigData(const CATUnicodeString &istrXMLPath,
	                                            const CATUnicodeString &istrType,
	                                            CATUnicodeString &ostrProdIDName,
	                                            CATUnicodeString &ostrActionName,
	                                            CATUnicodeString &ostrModelViewName,
	                                            CATUnicodeString &ostrModelViewVersion)
{
	if (CATUnicodeString("") == istrXMLPath) return E_FAIL;
	if (CATUnicodeString("") == istrType) return E_FAIL;

	CATIDOMDocument_var spXMLDocument = NULL_var;
	HRESULT rc = ClsConfigXMLServices::OpenXMLByfullName(istrXMLPath, spXMLDocument);
	if (FAILED(rc) || (NULL_var == spXMLDocument))
	{
		cout << "ERROR:ClsCUPSConfigFunc::GetCUPSConfigData()-NULL_var == spXMLDocument" << endl;
		return rc;
	}

	CATIDOMElement_var spRootElement = NULL_var;
	spXMLDocument->GetDocumentElement(spRootElement);
	if (NULL_var == spRootElement)
	{
		cout << "ERROR:ClsCUPSConfigFunc::GetCUPSConfigData()-NULL_var == spRootElement" << endl;
		return E_FAIL;
	}

	CATIDOMNodeList_var spChildNodeList = NULL_var;
	spRootElement->GetChildNodes(spChildNodeList);
	if (NULL_var == spChildNodeList) return E_FAIL;

	CATIDOMElement_var spTemplateNode = NULL_var;
	unsigned int iLength = 0;
	spChildNodeList->GetLength(iLength);
	for (int i = 0; i < iLength; i++)
	{
		CATIDOMNode_var spChildNode = NULL_var;
		spChildNodeList->Item(i, spChildNode);
		if (NULL_var == spChildNode) continue;

		CATIDOMElement_var spChildElement = spChildNode;
		if (NULL_var == spChildElement) continue;

		CATUnicodeString strTemplateType("");
		spChildElement->GetAttribute("Type", strTemplateType);
		if (istrType == strTemplateType)
		{
			spTemplateNode = spChildNode;
			break;
		}
	}

	if (NULL_var == spTemplateNode)
	{
		return E_FAIL;
	}

	spChildNodeList = NULL_var;
	spTemplateNode->GetElementsByTagName("EKLModel", spChildNodeList);
	if (NULL_var == spChildNodeList) return E_FAIL;

	rc = E_FAIL;
	iLength = 0;
	spChildNodeList->GetLength(iLength);
	for (int i = 0; i < iLength; i++)
	{
		CATIDOMNode_var spChildNode = NULL_var;
		spChildNodeList->Item(i, spChildNode);
		if (NULL_var == spChildNode) continue;

		CATIDOMElement_var spChildElement = spChildNode;
		if (NULL_var == spChildElement) continue;

		rc = S_OK;
		spChildElement->GetAttribute("PLM_ExternalID", ostrProdIDName);
		spChildElement->GetAttribute("ActionName", ostrActionName);
		break;
	}

	spChildNodeList = NULL_var;
	spTemplateNode->GetElementsByTagName("ModelView", spChildNodeList);
	if (NULL_var == spChildNodeList) return E_FAIL;

	spChildNodeList->GetLength(iLength);
	for (int i = 0; i < iLength; i++)
	{
		CATIDOMNode_var spChildNode = NULL_var;
		spChildNodeList->Item(i, spChildNode);
		if (NULL_var == spChildNode) continue;

		CATIDOMElement_var spChildElement = spChildNode;
		if (NULL_var == spChildElement) continue;
	
		CATUnicodeString strModelName("");
		spChildElement->GetAttribute("ModelName", strModelName);
		if (CATUnicodeString("刮板输送机模型") == strModelName)
		{
			spChildElement->GetAttribute("PLM_ExternalID", ostrModelViewName);
			spChildElement->GetAttribute("ModelVersion", ostrModelViewVersion);
			rc = S_OK;
			break;
		}
		
	}
	return rc;
}
//读取模板说明文件
HRESULT ClsConfigXMLServices::ReadTemplateText(CATUnicodeString strfilePath,
	                                           CATLISTV(CATUnicodeString) &olistTextContent)
{
	char cbuf[512] = { 0 };
	char *chName = (char *)strfilePath.ConvertToChar();
	ifstream fcur(chName, ios::out);

	if (fcur.is_open())
	{

		fcur.getline(cbuf, 512);

		while (!fcur.fail())
		{
			CATUnicodeString strContent(cbuf, 512);
			olistTextContent.Append(strContent);

			fcur.getline(cbuf, 512);
		}

		fcur.close();
	}
	return S_OK;
}