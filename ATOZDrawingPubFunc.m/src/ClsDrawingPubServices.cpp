//===================================================================
// COPYRIGHT ATOZ 2020/11/18
//===================================================================
// ClsDrawingPubServices.cpp
// Header definition of class ClsDrawingPubServices
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2020/11/18 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ClsDrawingPubServices.h"

//-----------------------------------------------------------------------------
// ClsDrawingPubServices : constructor
//-----------------------------------------------------------------------------
ClsDrawingPubServices::ClsDrawingPubServices()
{
//
//TODO: Add the constructor code here
//
}

//-----------------------------------------------------------------------------
// ClsDrawingPubServices : destructor
//-----------------------------------------------------------------------------

ClsDrawingPubServices::~ClsDrawingPubServices()
{
//
// TODO: Place code here.
//
}
//获取当前二维图激活页
HRESULT ClsDrawingPubServices::RetrieveCurrentDftSheet(CATIDftSheet_var &ospDftSheet)
{

	CATIDftDrawing* pDftDrawing = NULL;
	HRESULT rc = GetCurrentDrawing(pDftDrawing);
	if (FAILED(rc) || (NULL == pDftDrawing))
	{
		cout << "ERROR:ClsSetSamePositionViewsFunction::RetrieveCurrentDftSheet()-NULL == pDftDrawing" << endl;
		return E_FAIL;
	}

	CATIDftSheet* piDftSheet = NULL;
	pDftDrawing->GetActiveSheet(&piDftSheet);
	if (NULL == piDftSheet) return E_FAIL;

	ospDftSheet = piDftSheet;

	piDftSheet->Release();
	piDftSheet = NULL;

	pDftDrawing->Release();
	pDftDrawing = NULL;
	return S_OK;
}
//获取当前drawing对象
HRESULT ClsDrawingPubServices::GetCurrentDrawing(CATIDftDrawing * &piDftDrawing)
{
	HRESULT rc(S_OK);

	CATFrmEditor *pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor)
	{
		cout << "Error:CopyComponentFunction::GetCurrentDrawing() - pFrmEditor is NULL!" << endl;
		return E_FAIL;
	}

	CATPathElement ActivePathElement = pFrmEditor->GetUIActiveObject();
	piDftDrawing = (CATIDftDrawing *)ActivePathElement.FindElement(IID_CATIDftDrawing);
	if (NULL == piDftDrawing)
	{
		rc = E_FAIL;
	}
	else
	{
		rc = S_OK;
	}

	return rc;
}
//获取所有视图，不包括主视图和背景视图
//V6 有自带API 直接获取所有视图对象（不包括主视图和辅助视图
HRESULT ClsDrawingPubServices::RetrieveOtherViews(const CATIDftSheet_var &spDftSheet,
	                                              CATLISTV(CATBaseUnknown_var) &olistOtherViews)
{
	if (NULL_var == spDftSheet) return E_FAIL;

	CATIUnknownList* piListViews = NULL;
	HRESULT rc = spDftSheet->GetViews(&piListViews);
	if (FAILED(rc) || (NULL == piListViews))
	{
		cout << "ERROR:ClsDrawingPubServices::RetrieveOtherViews()-NULL == piListViews" << endl;
		return rc;
	}

	unsigned int iViewCount = 0;
	piListViews->Count(&iViewCount);
	for (int i = 0; i < iViewCount; i++)
	{
		IUnknown* piUnknown = NULL;
		piListViews->Item(i, &piUnknown);
		if (NULL == piUnknown) continue;

		CATIDftView* piCurrentView = NULL;
		rc = piUnknown->QueryInterface(IID_CATIDftView, (void**)&piCurrentView);
		if (FAILED(rc) || (NULL == piCurrentView)) continue;

		CATIDftView_var spCurrentDftView = piCurrentView;

		piCurrentView->Release();piCurrentView = NULL;
		piUnknown->Release();piUnknown = NULL;

		olistOtherViews.Append(spCurrentDftView);
	}
	return S_OK;
}
//获取视图中几何元素关联的Instance Product对象
HRESULT ClsDrawingPubServices::RetrieveRelatedInsProOfDftGeo(const CATIDftGenGeom_var &ispDftGenGeom,
	                                                         CATIPLMNavInstance_var &ospPLMNavInstance)
{
	if (NULL_var == ispDftGenGeom) return E_FAIL;

	CATOmbObjectInContext *oRepInstance = NULL;
	HRESULT rc = ispDftGenGeom->GetRepInstance(&oRepInstance);
	if (FAILED(rc) || NULL == oRepInstance)
	{
		cout << "ERROR:ClsDrawingPubServices::RetrieveRelatedInsProOfDftGeo()-oRepInstance is NULL!" << endl;
		return rc;
	}

	//cout << "获取到的对象为: " << CATIAlias_var(oRepInstance)->GetAlias() << endl;

	CATLISTP(CATIPLMComponent) listPathOfInstances = NULL;
	rc = oRepInstance->GetPathOfInstances(listPathOfInstances);
	oRepInstance->Release();oRepInstance = NULL;
	if (FAILED(rc) || (0 == listPathOfInstances.Size()))
	{
		cout << "ERROR:ClsDrawingPubServices::RetrieveRelatedInsProOfDftGeo()-listPathOfInstances.Size()==0!" << endl;
		return rc;
	}
	rc = E_FAIL;
	int listSize = listPathOfInstances.Size();
	CATIPLMComponent *piNavInsComponent = listPathOfInstances[listSize];
	if (NULL != piNavInsComponent)
	{
		rc = S_OK;
		ospPLMNavInstance = piNavInsComponent;
		piNavInsComponent->Release(); piNavInsComponent = NULL;
	}
	return rc;
}
//获取二维视图中的所有几何元素特征
HRESULT ClsDrawingPubServices::GetViewAllGenElems(const CATIDftView_var &ispDftView,
	                                              CATLISTV(CATBaseUnknown_var) &olistGenElems)
{
	if (NULL_var == ispDftView) return E_FAIL;

	IUnknown *piGenViewAccess = NULL;
	HRESULT rc = ispDftView->GetApplicativeExtension(IID_CATIDftGenGeomAccess, &piGenViewAccess);
	if (NULL == piGenViewAccess) return rc;

	CATIDftGenGeomAccess *piGenGeomAccess = NULL;
	rc = piGenViewAccess->QueryInterface(IID_CATIDftGenGeomAccess, (void**)&piGenGeomAccess);
	piGenViewAccess->Release(); piGenViewAccess = NULL;
	if (NULL == piGenGeomAccess) return rc;

	CATIUnknownList* pListGeo = NULL;
	piGenGeomAccess->GetAllGeneratedItems(IID_CATIDftGenGeom, &pListGeo);
	piGenGeomAccess->Release(); piGenGeomAccess = NULL;
	if (NULL == pListGeo) return E_FAIL;

	unsigned int GeoSize = 0;
	pListGeo->Count(&GeoSize);
	for (int i = 0; i < GeoSize; i++)
	{
		IUnknown * GeoItem = NULL;
		pListGeo->Item(i, &GeoItem);
		if (NULL == GeoItem) continue;

		CATIDftGenGeom* piGenGeom = NULL;
		rc = GeoItem->QueryInterface(IID_CATIDftGenGeom, (void**)&piGenGeom);
		GeoItem->Release(); GeoItem = NULL;
		if (FAILED(rc) || (NULL == piGenGeom)) continue;

		CATIDftGenGeom_var spGenItemGeom = piGenGeom;
		piGenGeom->Release(); piGenGeom = NULL;
		olistGenElems.Append(spGenItemGeom);
	}
	pListGeo->Release(); pListGeo = NULL;
	return S_OK;
}
//获取二维视图关联的文档节点
HRESULT ClsDrawingPubServices::GetProductFromView(const CATIDftView_var &spDftView,
	                                              CATIPLMNavReference_var &ospNavRef)
{
	if (NULL_var == spDftView) return E_FAIL;

	CATIADrawingView* piDrawingView = NULL;
	HRESULT rc = spDftView->QueryInterface(IID_CATIADrawingView, (void**)&piDrawingView);
	if (FAILED(rc) || NULL == piDrawingView)
	{
		cout << "ERROR:ClsDrawingPubServices::GetProductFromView() - piDrawingView is NULL!" << endl;
		return E_FAIL;
	}

	CATIABase *piGenViewBase = NULL;
	rc = piDrawingView->get_DrawingGenView(piGenViewBase);
	piDrawingView->Release();piDrawingView = NULL;
	if (FAILED(rc) || NULL == piGenViewBase)
	{
		cout << "ERROR:ClsDrawingPubServices::GetProductByView() - piGenViewBase is NULL!" << endl;
		return E_FAIL;
	}

	CATIADrawingGenView *piDrawingGenView = NULL;
	rc = piGenViewBase->QueryInterface(IID_CATIADrawingGenView, (void**)&piDrawingGenView);
	piGenViewBase->Release();piGenViewBase = NULL;
	if (FAILED(rc) || NULL == piDrawingGenView)
	{
		cout << "ERROR:ClsDrawingPubServices::GetProductByView() - piDrawingGenView is NULL!" << endl;
		return E_FAIL;
	}

	CATIABase *piRootPrdBase = NULL;
	rc = piDrawingGenView->GetAssociatedRootProduct(piRootPrdBase); //最高节点
	piDrawingGenView->Release();
	piDrawingGenView = NULL;
	if (FAILED(rc) || NULL == piRootPrdBase)
	{
		cout << "Error:ClsOfUniversalOperation::GetProductByView() - piRootPrdBase is NULL!" << endl;
		return E_FAIL;
	}

	cout << "获取到视图关联的节点为" << CATIAlias_var(piRootPrdBase)->GetAlias() << endl;
	CATIPLMNavReference_var spNavRef = piRootPrdBase;
	if (NULL_var != spNavRef)
	{
		ospNavRef = spNavRef;
	}
	piRootPrdBase->Release();piRootPrdBase = NULL;
	return rc;
}
//获取Drawing对象下所有详细页下的组件模板
HRESULT ClsDrawingPubServices::GetAllDrawingComponents(const CATIDftDrawing_var &ispDftDrawing,
	                                                   CATLISTV(CATBaseUnknown_var) &olistComponents)
{
	if (NULL_var == ispDftDrawing) return E_FAIL;

	CATIUnknownList* pUnknownList = NULL;
	HRESULT rc = ispDftDrawing->GetSheets(&pUnknownList);
	if (NULL == pUnknownList) return E_FAIL;

	unsigned int iSheetCounts(0);
	pUnknownList->Count(&iSheetCounts);
	for (int i = 0; i < iSheetCounts; i++)
	{
		IUnknown* pSheetUnknown = NULL;
		pUnknownList->Item(i, &pSheetUnknown);
		if (NULL == pSheetUnknown) continue;

		CATIDftSheet* piDftSheet = NULL;
		rc = pSheetUnknown->QueryInterface(IID_CATIDftSheet, (void**)&piDftSheet);
		if (SUCCEEDED(rc) && (NULL != piDftSheet))
		{
			boolean IsDetSheet(FALSE);
			piDftSheet->IsDetail(&IsDetSheet);
			if (IsDetSheet)
			{
				CATIUnknownList *oListOfViewResult = NULL;
				rc = piDftSheet->GetViews(&oListOfViewResult);
				if (SUCCEEDED(rc) && (NULL != oListOfViewResult))
				{
					unsigned int iViewCounts(0);
					rc = oListOfViewResult->Count(&iViewCounts);
					for (int ViewIndex = 0; ViewIndex < iViewCounts; ViewIndex++)
					{
						IUnknown* pViewUnknown = NULL;
						oListOfViewResult->Item(i, &pViewUnknown);
						if (NULL == pViewUnknown) continue;

						CATIDftView* piDftView = NULL;
						rc = pViewUnknown->QueryInterface(IID_CATIDftView, (void**)&piDftView);
						if (SUCCEEDED(rc) && (NULL != piDftView))
						{
							CATIDftView_var spDftView = piDftView;
							olistComponents.Append(spDftView);

							piDftView->Release(); piDftView = NULL;
						}
					}
					oListOfViewResult->Release(); oListOfViewResult = NULL;
				}
			}
			piDftSheet->Release(); piDftSheet = NULL;
		}
		pSheetUnknown->Release(); pSheetUnknown = NULL;
	}
	pUnknownList->Release(); pUnknownList = NULL;

	return S_OK;
}
//视图添加实例化组件
HRESULT ClsDrawingPubServices::AddViewComponent(CATBaseUnknown_var spTargetViewBU, CATBaseUnknown_var spSourceViewBU,
	double xPosition, double yPosition, CATBaseUnknown_var &spInstanteComponentBU)
{
	if (NULL_var == spTargetViewBU)
	{
		cout << "Error:ClsForUniversalOperation::AddViewComponent() - spTargetViewBU is NULL!" << endl;
		return E_FAIL;
	}
	if (NULL_var == spSourceViewBU)
	{
		cout << "Error:ClsForUniversalOperation::AddViewComponent() - spSourceViewBU is NULL!" << endl;
		return E_FAIL;
	}

	HRESULT rc(S_OK);

	CATIADrawingView *piTargetDrawingView = NULL;
	rc = spTargetViewBU->QueryInterface(IID_CATIADrawingView, (void**)&piTargetDrawingView);
	if (FAILED(rc) || NULL == piTargetDrawingView)
	{
		cout << "Error:ClsForUniversalOperation::AddComponentFromExistsView() - piTargetDrawingView is NULL!" << endl;
		return E_FAIL;
	}

	CATIADrawingComponents *piDrawingComponents = NULL;
	rc = piTargetDrawingView->get_Components(piDrawingComponents);
	if (SUCCEEDED(rc) && NULL != piDrawingComponents)
	{
		CATIADrawingView *piSourceDrawingView = NULL;
		rc = spSourceViewBU->QueryInterface(IID_CATIADrawingView, (void**)&piSourceDrawingView);
		if (SUCCEEDED(rc) && NULL != piSourceDrawingView)
		{
			CATIADrawingComponent *piDrawingComponent = NULL;
			rc = piDrawingComponents->Add(piSourceDrawingView, xPosition, yPosition, piDrawingComponent);
			if (SUCCEEDED(rc) && NULL != piDrawingComponent)
			{
				spInstanteComponentBU = piDrawingComponent;

				piDrawingComponent->Release();
				piDrawingComponent = NULL;
			}

			piSourceDrawingView->Release();
			piSourceDrawingView = NULL;
		}

		piDrawingComponents->Release();
		piDrawingComponents = NULL;
	}

	piTargetDrawingView->Release();
	piTargetDrawingView = NULL;

	return rc;
}
//获取视图下的所有的组件实例
HRESULT ClsDrawingPubServices::GetAllComponentsOnView(const CATIDftView_var &ispDftView,
	                                                  CATLISTV(CATBaseUnknown_var) &olist2DComponent)
{
	if (NULL_var == ispDftView) return E_FAIL;

	CATIADrawingView* piDrawingView = NULL;
	HRESULT rc = ispDftView->QueryInterface(IID_CATIADrawingView, (void**)&piDrawingView);
	if (FAILED(rc) || NULL == piDrawingView)
	{
		cout << "Error:ClsDrawingPubServices::GetAllComponentsOnView() - piDrawingView is NULL!" << endl;
		return rc;
	}

	CATIADrawingComponents *piDrawingComponents = NULL;
	rc = piDrawingView->get_Components(piDrawingComponents);
	if (NULL != piDrawingComponents)
	{
		CATLONG ComponentCount = 0;
		piDrawingComponents->get_Count(ComponentCount);
		for (CATLONG i = 1; i <= ComponentCount; i++)
		{
			CATVariant oVariant;
			rc = ::BuildVariant(i, oVariant);
			if (FAILED(rc)) continue;

			CATIADrawingComponent* piDrawingComponent = NULL;
			piDrawingComponents->Item(oVariant, piDrawingComponent);

			olist2DComponent.Append((CATBaseUnknown*)piDrawingComponent);
		}
	}
	piDrawingComponents->Release(); piDrawingComponents = NULL;

	return rc;
}
//获取View的投影平面信息，输出结果为转换矩阵
HRESULT ClsDrawingPubServices::RetrieveProjectPlaneInView(const CATIDftView_var &ispDftView,
	                                                      CATMathTransformation &oMathTrans,
	                                                      CATMathDirection &oProjectDirection)
{
	if (NULL_var == ispDftView)
	{
		cout << "ERROR:ClsDrawingPubServices::RetrieveProjectPlaneInView()-NULL == ispDftView" << endl;
		return E_FAIL;
	}

	CATIDftGenerSpec* piDftGeneSpec = NULL;
	ispDftView->GetGenerSpec(&piDftGeneSpec);
	if (NULL == piDftGeneSpec) return E_FAIL;

	CATMathPlane* pMathPlane = NULL;
	piDftGeneSpec->GetProjectionPlane(&pMathPlane);

	CATMathPoint OriginMathPt = pMathPlane->GetOrigin();
	CATMathDirection FirstMathDir = pMathPlane->GetFirstDirection();
	CATMathDirection SecondMathDir = pMathPlane->GetSecondDirection();
	CATMathDirection ThirdMathDir = FirstMathDir^SecondMathDir;

	CATMathAxis CurrentMathAxis(OriginMathPt, FirstMathDir, SecondMathDir, ThirdMathDir);
	oMathTrans = CATMathTransformation(CATMathOIJK, CurrentMathAxis);
	oProjectDirection = ThirdMathDir;

	//cout<<"oMathTrans.Dump();"<<endl;
	//oMathTrans.Dump();

	return S_OK;
}

//从视图坐标转换到全局坐标
void ClsDrawingPubServices::GetGlobalMathPt(const CATIDftView_var &ispActiveView,
	                                        double         iOriginScale,
	                                        CATMathPoint2D iLocalMathPt2D,
	                                        CATMathPoint2D &oGolobalMathPt2D)
{
	if (NULL_var == ispActiveView)
	{
		cout << "ERROR:ClsDrawingPubServices::GetGlobalMathPt()-NULL_var == ispActiveView" << endl;
		return;
	}

	CATIADrawingView *pDrawingView = NULL;
	ispActiveView->QueryInterface(IID_CATIADrawingView, (void**)&pDrawingView);
	if (NULL == pDrawingView)
	{
		cout << "ERROR:ClsDrawingPubServices::GetGlobalMathPt() - pDrawingView is NULL!" << endl;
		return;
	}

	double iX = 0;
	double iY = 0;
	pDrawingView->get_xAxisData(iX);
	pDrawingView->get_yAxisData(iY);

	double iScale = 0.0;
	pDrawingView->get_Scale(iScale);

	iX = iX / iOriginScale;
	iY = iY / iOriginScale;


	double iAngle = 0;
	pDrawingView->get_Angle(iAngle);

	pDrawingView->Release();
	pDrawingView = NULL;

	CATMathAxis2D TargetAxis2D;
	TargetAxis2D.Set(CATMathPoint2D(iX, iY),
		CATMathVector2D(CATCos(iAngle), CATSin(iAngle)),
		CATMathVector2D(-CATSin(iAngle), CATCos(iAngle)));

	CATMathAxis2D OriginAxis2D(CATMathPoint2D(0, 0),
		CATMathVector2D(1, 0),
		CATMathVector2D(0, 1));

	CATMathTransformation2D CurrentTrans(OriginAxis2D, TargetAxis2D);

	//cout<<"CurrentTrans.Dump();"<<endl;
	//CurrentTrans.Dump();

	double iLocalXCoord = iLocalMathPt2D.GetX();
	double iLocalYCoord = iLocalMathPt2D.GetY();

	iLocalXCoord = iLocalXCoord*iScale / iOriginScale;
	iLocalYCoord = iLocalYCoord*iScale / iOriginScale;

	iLocalMathPt2D.SetX(iLocalXCoord);
	iLocalMathPt2D.SetY(iLocalYCoord);

	//cout<<"iLocalXCoord == "<<iLocalXCoord<<endl;
	//cout<<"iLocalYCoord == "<<iLocalYCoord<<endl;

	oGolobalMathPt2D = CurrentTrans*iLocalMathPt2D;

}

//获取ROOT下的所有SHEETS
HRESULT ClsDrawingPubServices::GetAllSheets(const CATIDftDrawing_var &ispDftDrawing,
	CATLISTV(CATBaseUnknown_var) &olistSheets)
{
	if (NULL_var == ispDftDrawing) return E_FAIL;

	CATIUnknownList* pUnknownList = NULL;
	HRESULT rc = ispDftDrawing->GetSheets(&pUnknownList);
	if (NULL == pUnknownList) return E_FAIL;

	unsigned int iSheetCounts(0);
	pUnknownList->Count(&iSheetCounts);
	for (int i = 0; i < iSheetCounts; i++)
	{
		IUnknown* pSheetUnknown = NULL;
		pUnknownList->Item(i, &pSheetUnknown);
		if (NULL == pSheetUnknown) continue;

		CATIDftSheet* piDftSheet = NULL;
		rc = pSheetUnknown->QueryInterface(IID_CATIDftSheet, (void**)&piDftSheet);
		if (SUCCEEDED(rc) && (NULL != piDftSheet))
		{
			CATIDftSheet_var spOnSheet = piDftSheet;
			piDftSheet->Release(); piDftSheet = NULL;
			olistSheets.Append(spOnSheet);
		}
		pSheetUnknown->Release(); pSheetUnknown = NULL;
	}
	pUnknownList->Release(); pUnknownList = NULL;
	cout << "图纸个数为:" << olistSheets.Size() << endl;
	return S_OK;
}

//处理所有尺寸标注
HRESULT ClsDrawingPubServices::ManageAllDims(CATLISTV(CATBaseUnknown_var) &ilistDimElems)
{
	CATIDftSheet_var spCurrentDftSheet = NULL_var;
	HRESULT rc = S_OK;

	for (int i = 1; i <= ilistDimElems.Size(); i++)
	{
		spCurrentDftSheet = ilistDimElems[i];
		CATLISTV(CATBaseUnknown_var) listDftViews = NULL;
		RetrieveOtherViews(spCurrentDftSheet, listDftViews);
		if (0 == listDftViews.Size())
		{
			cout << "ERROR:ProsBatAnnotationsCmd::BatCreateTextAnnotations()-listDftViews.Size() == 0" << endl;
			return rc;
		}

		for (int i = 1; i <= listDftViews.Size(); i++)
		{
			CATIDftView_var spDftView = listDftViews[i];
			if (NULL_var == spDftView) continue;

			CATLISTV(CATBaseUnknown_var) listDim = NULL;
			GetViewAllDimElems(spDftView, listDim);
			cout << "listGenGeo.Size() == " << listDim.Size() << endl;

			int targetVlaue{ 0 };
			for (int DimIndex = 1; DimIndex <= listDim.Size(); DimIndex++)
			{
				CATIDrwDimDimension_var spOnDim = listDim[DimIndex];
				CATIDrwDimValue_var spOnValue = spOnDim->GetValue();
				double currentValue{ spOnValue->GetValue() };

				if (currentValue <= 3.1415926)
					//currentValue = currentValue * 57.29578;
					continue;

				targetVlaue = (int)currentValue;

				CATIDrwDimFakeComponent_var spOnFake = spOnValue->GetFakeComponent();
				if (NULL_var == spOnFake)	return E_FAIL;

				CATUnicodeString fakeValue("");
				fakeValue.BuildFromNum(targetVlaue);

				spOnFake->SetFakeMode(1);
				spOnFake->SetMainFakeValue(fakeValue);

				CATIDrwTextProperties_var spProperties = spOnDim;
				if (NULL_var != spProperties)
					spProperties->Refresh();
				else
					cout << "CATIDrwTextProperties_var获取失败" << endl;

			}


		}
	}
	return S_OK;
}

//获取视图中的所有尺寸标注
HRESULT ClsDrawingPubServices::GetViewAllDimElems(const CATIDftView_var &ispDftView,
	CATLISTV(CATBaseUnknown_var) &olistDimElems)
{
	if (NULL_var == ispDftView) return E_FAIL;

	CATIUnknownList *piDimList = NULL;
	HRESULT rc = ispDftView->GetComponents(IID_CATIDrwDimDimension, &piDimList); //获取成功
	if (NULL == piDimList)
	{
		cout << "未能获取IID_CATIDrwDimDimension" << endl;
		return E_FAIL;
	}

	unsigned int GeoSize = 0;
	piDimList->Count(&GeoSize);
	for (int i = 0; i < GeoSize; i++)
	{
		IUnknown * DimItem = NULL;
		piDimList->Item(i, &DimItem);
		if (NULL == DimItem) continue;

		CATIDrwDimDimension* piOnDim = NULL;
		rc = DimItem->QueryInterface(IID_CATIDrwDimDimension, (void**)&piOnDim);
		DimItem->Release(); DimItem = NULL;
		if (FAILED(rc) || (NULL == piOnDim)) continue;

		CATIDrwDimDimension_var spOnDim = piOnDim;
		piOnDim->Release(); piOnDim = NULL;
		olistDimElems.Append(spOnDim);
	}
	piDimList->Release(); piDimList = NULL;
	return S_OK;
}


HRESULT ClsDrawingPubServices::Link3DModel(CATIDftDrawing_var &ispDrawing, CATIDftView_var &ospActiveView)
{
	HRESULT rc(S_OK);
	CATIPsiRepresentationReference *pTobeLoaded(NULL);
	CATDftDrawingPLMServices::GetDrawingRepresentation(ispDrawing, &pTobeLoaded);
	if (NULL != pTobeLoaded)
	{
		rc = CATDftGenPLMServices::Load3DDataFromDrawing(pTobeLoaded);
		pTobeLoaded->Release(); pTobeLoaded = NULL;

		if (FAILED(rc)) {
			cout << "Load3DDataFromDrawing failed" << endl;
			return rc;
		}
	}

	CATIDftView  *piDftView = NULL;
	ispDrawing->GetActiveView(&piDftView);

	if (NULL != piDftView)
	{
		ospActiveView = piDftView;
		piDftView->Release(); piDftView = NULL;
	}
	else {
		cout << "GetActiveView failed" << endl;
		return E_FAIL;
	}

	IUnknown *piViewModif = NULL;
	ospActiveView->GetApplicativeExtension(IID_CATIDftGenViewModification, &piViewModif);
	CATIDftGenViewModification *piDftGenViewModif = NULL;
	CATIDftGenViewUpdate *piDftGenViewUpdate = NULL;
	if (piViewModif)
	{
		piViewModif->QueryInterface(IID_CATIDftGenViewModification, (void **)&piDftGenViewModif);
		piViewModif->QueryInterface(IID_CATIDftGenViewUpdate, (void **)&piDftGenViewUpdate);
		piViewModif->Release(); piViewModif = NULL;
	}

	if (piDftGenViewModif)
	{
		CATDftGenViewProperties theViewProperties;
		//theViewProperties.SetWireframeExtractionMode(TRUE, TRUE);  //修改隐藏线模式等
		if (SUCCEEDED(piDftGenViewModif->ModifyGenViewProperties(&theViewProperties)))
		{
			if (piDftGenViewUpdate && SUCCEEDED(piDftGenViewUpdate->Update()))
			{
				cout << " view update successful " << endl;
			}
		}
		piDftGenViewModif->Release(); piDftGenViewModif = NULL;
	}
	if (piDftGenViewUpdate) piDftGenViewUpdate->Release(), piDftGenViewUpdate = NULL;

	if (NULL_var == ospActiveView) {
		cout << "Link3DModel NULL_var == ospActiveView" << endl;
		return E_FAIL;
	}

	return S_OK;
}
