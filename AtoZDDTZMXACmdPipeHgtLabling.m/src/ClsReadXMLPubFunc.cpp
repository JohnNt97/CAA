//===================================================================
// COPYRIGHT ATOZ 2020/11/23
//===================================================================
// ClsReadXMLPubFunc.cpp
// Header definition of class ClsReadXMLPubFunc
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2020/11/23 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ClsReadXMLPubFunc.h"

HMODULE GetCurrentModuleHandle()
{
	MEMORY_BASIC_INFORMATION mbi;
	::VirtualQuery((LPVOID)GetCurrentModuleHandle, &mbi, sizeof(mbi));
	return (HMODULE)mbi.AllocationBase;
}
//-----------------------------------------------------------------------------
// ClsReadXMLPubFunc : constructor
//-----------------------------------------------------------------------------
ClsReadXMLPubFunc::ClsReadXMLPubFunc()
{
//
//TODO: Add the constructor code here
//
}

//-----------------------------------------------------------------------------
// ClsReadXMLPubFunc : destructor
//-----------------------------------------------------------------------------

ClsReadXMLPubFunc::~ClsReadXMLPubFunc()
{
//
// TODO: Place code here.
//
}
//get dllPath
HRESULT ClsReadXMLPubFunc::Get_ComputeDataExePath(CATUnicodeString &strExePath)
{
	char chCurrentWorkDirectory[1024] = { 0 };//当前路径
	GetModuleFileNameA(GetCurrentModuleHandle(), chCurrentWorkDirectory, 1024);
	if (chCurrentWorkDirectory == '\0')
	{
		return E_FAIL;
	}

	strExePath = chCurrentWorkDirectory;

	int nKeyWordsPosition = 0;
	nKeyWordsPosition = strExePath.SearchSubString("bin", 0, CATUnicodeString::CATSearchModeForward);
	if (-1 == nKeyWordsPosition)
	{
		cout << "ERROR InstallPath Changed!" << endl;
		return E_FAIL;
	}

	strExePath.Remove(nKeyWordsPosition, strExePath.GetLengthInChar() - nKeyWordsPosition);
	return S_OK;
}
//open xml 
HRESULT ClsReadXMLPubFunc::OpenXMLByfullName(CATUnicodeString istrXMLPath,
	                                         CATIDOMDocument_var &ospDOMDocument)
{
	if (CATUnicodeString("") == istrXMLPath) return E_FAIL;

	HRESULT rc(E_FAIL);

	CATIXMLDOMDocumentBuilder_var builder = NULL_var;
	rc = ::CreateCATIXMLDOMDocumentBuilder(builder);
	if (FAILED(rc) || NULL_var == builder) return E_FAIL;

	//CATIXMLSAXFactory_var spIXMLSAXFactory(NULL_var);
	//rc = ::CreateCATIXMLSAXFactory(spIXMLSAXFactory);

	CATIXMLSAX2Factory_var   spIXMLSAXFactory(NULL_var);
	rc = ::CreateCATIXMLSAX2Factory(spIXMLSAXFactory);
	if (FAILED(rc) || NULL_var == spIXMLSAXFactory)
		return E_FAIL;

	CATListOfCATUnicodeString strListOfReadOption(1);
	strListOfReadOption.Append(CATUnicodeString("CATDoValidation"));
	CATListOfCATUnicodeString strListOfReadOptionValue(1);
	strListOfReadOptionValue.Append(CATUnicodeString("false"));

	rc = builder->Parse(istrXMLPath, ospDOMDocument, strListOfReadOption, strListOfReadOptionValue);
	if (FAILED(rc) || NULL_var == ospDOMDocument) return E_FAIL;

	return S_OK;
}
//获取配置文件Drawing ID号、版本和高程名称
HRESULT ClsReadXMLPubFunc::GetDrawingTemplateInfo(const CATUnicodeString &istrXmlPath,
	                                              CATUnicodeString &ostrDrawingNum,
	                                              CATUnicodeString &ostrDrwVersion,
	                                              CATUnicodeString &ostrGaoChengName)
{
	if (CATUnicodeString("") == istrXmlPath) return E_FAIL;

	CATIDOMDocument_var spXMLDocument = NULL_var;
	HRESULT rc = ClsReadXMLPubFunc::OpenXMLByfullName(istrXmlPath, spXMLDocument);
	if (FAILED(rc) || (NULL_var == spXMLDocument))
	{
		cout << "ERROR:ClsReadXMLPubFunc::GetDrawingTemplateInfo()-NULL_var == spXMLDocument" << endl;
		return rc;
	}

	CATIDOMElement_var spRootElement = NULL_var;
	spXMLDocument->GetDocumentElement(spRootElement);
	if (NULL_var == spRootElement)
	{
		cout << "ERROR:ClsReadXMLPubFunc::GetDrawingTemplateInfo()-NULL_var == spRootElement" << endl;
		return E_FAIL;
	}

	CATIDOMNodeList_var spChildNodeList = NULL_var;
	spRootElement->GetChildNodes(spChildNodeList);
	if (NULL_var == spChildNodeList) return E_FAIL;

	CATIDOMElement_var spDrwNodeElem = NULL_var;
	unsigned int iLength = 0;
	spChildNodeList->GetLength(iLength);
	for (int i = 0; i < iLength; i++)
	{
		CATIDOMNode_var spChildNode = NULL_var;
		spChildNodeList->Item(i, spChildNode);
		if (NULL_var == spChildNode) continue;

		CATIDOMElement_var spChildElement = spChildNode;
		if (NULL_var == spChildElement) continue;

		CATUnicodeString strNodeName("");
		spChildElement->GetNodeName(strNodeName);
		if (CATUnicodeString("TemplateInfo") == strNodeName)
		{
			spDrwNodeElem = spChildElement;
			break;
		}
	}
	//找到TemplateInfo节点
	if (NULL_var == spDrwNodeElem)
	{
		cout << "ERROR:ClsReadXMLPubFunc::GetDrawingTemplateInfo()-NULL_var == spDrwNodeElem" << endl;
		return E_FAIL;
	}
	//获取二维图模板名称和版本
	spDrwNodeElem->GetAttribute("DrwName", ostrDrawingNum);
	spDrwNodeElem->GetAttribute("DrwVersion", ostrDrwVersion);

	spDrwNodeElem->GetChildNodes(spChildNodeList);
	if (NULL_var == spChildNodeList) return E_FAIL;

	spChildNodeList->GetLength(iLength);
	for (int i = 0; i < iLength; i++)
	{
		CATIDOMNode_var spChildNode = NULL_var;
		spChildNodeList->Item(i, spChildNode);
		if (NULL_var == spChildNode) continue;

		CATIDOMElement_var spChildElement = spChildNode;
		if (NULL_var == spChildElement) continue;

		CATUnicodeString strNodeName("");
		spChildElement->GetNodeName(strNodeName);
		if (CATUnicodeString("GAOChengSymbol") == strNodeName)
		{
			GetNodeText(spChildElement, ostrGaoChengName);
			break;
		}
	}

	return rc;
}
HRESULT ClsReadXMLPubFunc::GetNodeText(const CATIDOMElement_var &ispDomElem,
	                                   CATUnicodeString &ostrNodeText)
{
	if (NULL_var == ispDomElem) return E_FAIL;

	CATIDOMNodeList_var spChildNodeList = NULL_var;
	ispDomElem->GetChildNodes(spChildNodeList);
	if (NULL_var == spChildNodeList) return E_FAIL;

	unsigned int iLength = 0;
	spChildNodeList->GetLength(iLength);
	for (int i = 0; i < iLength; i++)
	{
		CATIDOMNode_var spChildNode = NULL_var;
		spChildNodeList->Item(i, spChildNode);
		if (NULL_var == spChildNode) continue;

		CATIDOMText_var spNodeText = spChildNode;
		if (NULL_var != spNodeText)
		{
			spNodeText->GetNodeValue(ostrNodeText);
			break;
		}
	}

	return S_OK;
}