//===================================================================
// COPYRIGHT atoz 2021/01/05
//===================================================================
// MouseSubsribingCmd.cpp
// Header definition of class MouseSubsribingCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2021/01/05 Creation: Code generated by the 3DS wizard
//===================================================================

#include "MouseSubsribingCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( MouseSubsribingCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
MouseSubsribingCmd::MouseSubsribingCmd() :
CATStateCommand ("MouseSubsribingCmd", CATDlgEngOneShot, CATCommandModeExclusive)
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
, _daIndicCircleCenter(NULL)
, _daIndicRadius(NULL)
, _spCATISktUse2DWFFactory(NULL_var)
, _spSketch(NULL_var)
{
	cout << "CAADegCreateCircleCmd constructor" << endl;

	Get2DWFFactory(_spCATISktUse2DWFFactory, _spSketch);
	
}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
MouseSubsribingCmd::~MouseSubsribingCmd()
{
	if (NULL != _daIndicRadius)
	{
		_daIndicRadius->RequestDelayedDestruction();
		_daIndicRadius = NULL;
	}

	if (NULL != _daIndicCircleCenter)
	{
		_daIndicCircleCenter->RequestDelayedDestruction();
		_daIndicCircleCenter = NULL;
	}

}


//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void MouseSubsribingCmd::BuildGraph()
{
	cout << "CAADegCreateCircleCmd BuildGraph" << endl;

	//indicate the circle center AND Radius

	_daIndicCircleCenter = new CATIndicationAgent("GetCircleCenter");
	_daIndicCircleCenter->SetBehavior(CATDlgEngWithUndo);

	_daIndicRadius = new CATIndicationAgent("GetRadiusPoint");
	_daIndicRadius->SetBehavior(CATDlgEngAcceptOnPrevaluate |CATDlgEngWithPrevaluation | CATDlgEngWithUndo);


	CATDialogState *stGetCircleCenter = GetInitialState("stGetCircleCenterId");
	stGetCircleCenter->AddDialogAgent(_daIndicCircleCenter);

	CATDialogState *stGetRadius = AddDialogState("stGetRadiusId");
	stGetRadius->AddDialogAgent(_daIndicRadius);

	CATDialogTransition *pSecondTransition = AddTransition
	(
		stGetCircleCenter,
		stGetRadius,
		AndCondition(IsOutputSetCondition(_daIndicCircleCenter),
			Condition((ConditionMethod)& MouseSubsribingCmd::CheckCircleCenter)),
		Action((ActionMethod)& MouseSubsribingCmd::CreateCircleCenter)
	);

	CATDialogTransition *pThirdTransition = AddTransition
	(
		stGetRadius,
		NULL,
		IsOutputSetCondition(_daIndicRadius),
		Action((ActionMethod)& MouseSubsribingCmd::NewCircle)
	);

	CATDialogTransition *pRubberTransition = AddTransition
	(
		stGetRadius,
		stGetRadius,
		IsLastModifiedAgentCondition(_daIndicRadius),
		Action((ActionMethod)& MouseSubsribingCmd::UpdateCircle)
	);
}


CATBoolean MouseSubsribingCmd::CheckCircleCenter(void * iDummy)
{
	cout << "CAADegCreateCircleCmd::CheckCircleCenter" << endl;

	CATBoolean rc = TRUE;


	return rc;
}


CATBoolean MouseSubsribingCmd::CreateCircleCenter(void * iData)
{
	cout << "CAADegCreateCircleCmd::CreateCircleCenter" << endl;

	// Gets the indicated center  
	StartPt = _daIndicCircleCenter->GetValue();
	_daIndicCircleCenter->InitializeAcquisition();


	double Cord[2]{ StartPt.GetX() ,StartPt.GetY() };
	_spCATISktUse2DWFFactory->CreatePoint(Cord);

	

	return TRUE;
}

CATBoolean MouseSubsribingCmd::UpdateCircle(void * iData)
{
	//cout << "CAADegCreateCircleCmd::UpdateCircle" << endl;
	
	/*CATMathPoint2D point2D = _daIndicRadius->GetValue();
	
	double Cord[2]{ point2D.GetX() ,point2D.GetY() };

	_spCATISktUse2DWFFactory->CreatePoint(Cord);

	_daIndicRadius->InitializeAcquisition();*/

	cout << "CAADegCreateCircleCmd::UpdateCircle" << endl;

	EndPt = _daIndicRadius->GetValue();
	_daIndicRadius->InitializeAcquisition();

	double Cord[2]{ EndPt.GetX() ,EndPt.GetY() };
	_spCATISktUse2DWFFactory->CreatePoint(Cord);

	double StrCord[2]{ StartPt.GetX() ,StartPt.GetY() };
	CATBaseUnknown_var spOnLine = _spCATISktUse2DWFFactory->CreateLine(Cord, StrCord);

	CATBaseUnknown* pOnOutput(NULL);
	_spCATISktUse2DWFFactory->CreateOutput(spOnLine, IID_CATBaseUnknown, &pOnOutput);

	pOnOutput->Release();
	pOnOutput = NULL;

	return TRUE;
}

CATBoolean MouseSubsribingCmd::NewCircle(void * iData)
{
	// Creation of the circle  by a factory 
	/*cout << "CAADegCreateCircleCmd::NewCircle" << endl;

	EndPt = _daIndicRadius->GetValue();
	_daIndicRadius->InitializeAcquisition();

	double Cord[2]{ EndPt.GetX() ,EndPt.GetY() };
	_spCATISktUse2DWFFactory->CreatePoint(Cord);

	double StrCord[2]{ StartPt.GetX() ,StartPt.GetY() };
	CATBaseUnknown_var spOnLine = _spCATISktUse2DWFFactory->CreateLine(Cord, StrCord);

	CATBaseUnknown* pOnOutput(NULL);
	_spCATISktUse2DWFFactory->CreateOutput(spOnLine, IID_CATBaseUnknown, &pOnOutput);

	pOnOutput->Release();
	pOnOutput = NULL;*/

	return TRUE;
}

CATStatusChangeRC MouseSubsribingCmd::Activate(CATCommand *iCmd, CATNotification *iNotif)
{
	cout << " CAADegCreateCircleCmd::Activate" << endl;
	// This command uses the cso as entry so we don't empty it. 
	// But see CATDegCreateCylinder1.cpp to see the contrary
	// 

	// Nothing to do here, just to see cout when you launch the command
	// and note order of method  
	return (CATStatusChangeRCCompleted);
}

//----------------------------------------------------------------------------

CATStatusChangeRC MouseSubsribingCmd::Desactivate(CATCommand *iCmd, CATNotification *iNotif)
{
	cout << " CAADegCreateCircleCmd::Desactivate" << endl;
	// Nothing to do here, just to see cout when you launch the command
	// and note order of method  
	return (CATStatusChangeRCCompleted);
}

//----------------------------------------------------------------------------
CATStatusChangeRC MouseSubsribingCmd::Cancel(CATCommand *iCmd, CATNotification *iNotif)
{
	cout << " CAADegCreateCircleCmd::Cancel" << endl;
	//ExecuteUndoAtEnd();
	return (CATStatusChangeRCCompleted);
}