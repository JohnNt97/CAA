//===================================================================
// COPYRIGHT atoz 2021/03/12
//===================================================================
// ATOZShowTurningPtCmd.cpp
// Header definition of class ATOZShowTurningPtCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2021/03/12 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ATOZShowTurningPtCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( ATOZShowTurningPtCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
ATOZShowTurningPtCmd::ATOZShowTurningPtCmd() :
CATStateCommand ("ATOZShowTurningPtCmd", CATDlgEngOneShot, CATCommandModeShared)
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
, _pATOZShowTurningPtDlg(NULL)
, _pSelPipePathElemAgent(NULL)
, _pSelPipeObjDlgAgent(NULL)
, _spRootNavRef(NULL_var)
, _spRootOccur(NULL_var)
, _spPipeInst(NULL_var)
{
	HRESULT rc = InitializeMainDialog();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}

	RetrieveRootProd(_spRootNavRef);
	if (NULL_var == _spRootNavRef) {
		cout << "failed to RetrieveRootProd" << endl;
		this->RequestDelayedDestruction();
		return;
	}

	CATIPrdOccurrenceMngt* occMngt(NULL);
	if (SUCCEEDED(CATPrdGetOccurrenceMngt(occMngt)) && occMngt)
	{
		occMngt->GetOrCreateRootOccurrence(_spRootNavRef, _spRootOccur);
		occMngt->Release();
		occMngt = NULL;
	}

	if (NULL_var == _spRootOccur) {
		cout << "failed to GetOrCreateRootOccurrence" << endl;
		this->RequestDelayedDestruction();
		return;
	}

}

HRESULT ATOZShowTurningPtCmd::InitializeMainDialog()
{
	_pATOZShowTurningPtDlg = new ATOZShowTurningPtDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
		"ATOZShowTurningPtDlg");

	_pATOZShowTurningPtDlg->Build();

	_pATOZShowTurningPtDlg->_SelectorListPipe->SetLine("No Selection");

	_pATOZShowTurningPtDlg->_EditorFund->SetText("0.0");

	int ArraySel[1] = { 0 };
	_pATOZShowTurningPtDlg->_SelectorListPipe->SetSelect(ArraySel, 1);

	_pATOZShowTurningPtDlg->SetVisibility(CATDlgShow);
	
	return S_OK;

}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
ATOZShowTurningPtCmd::~ATOZShowTurningPtCmd()
{
	if (NULL != _pSelPipeObjDlgAgent)
	{
		_pSelPipeObjDlgAgent->RequestDelayedDestruction();
		_pSelPipeObjDlgAgent = NULL;
	}

	if (NULL != _pSelPipePathElemAgent)
	{
		_pSelPipePathElemAgent->RequestDelayedDestruction();
		_pSelPipePathElemAgent = NULL;
	}

	if (NULL != _pATOZShowTurningPtDlg)
	{
		_pATOZShowTurningPtDlg->RequestDelayedDestruction();
		_pATOZShowTurningPtDlg = NULL;
	}
}


//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void ATOZShowTurningPtCmd::BuildGraph()
{
	_pSelPipePathElemAgent = new CATPathElementAgent("SelectPipe");
	_pSelPipePathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot);
	_pSelPipePathElemAgent->AddElementType(IID_CATIPipPipeInstance);

	_pSelPipeObjDlgAgent = new CATDialogAgent("SelPipeDlgAgent");
	_pSelPipeObjDlgAgent->AcceptOnNotify(_pATOZShowTurningPtDlg->_SelectorListPipe,
		_pATOZShowTurningPtDlg->_SelectorListPipe->GetListSelectNotification());

	CATDialogState * SelectPipeObjState = GetInitialState("SelectPipeObjState");
	SelectPipeObjState->AddDialogAgent(_pSelPipePathElemAgent);

	AddTransition(SelectPipeObjState, SelectPipeObjState,
		IsOutputSetCondition(_pSelPipePathElemAgent),
		Action((ActionMethod)&ATOZShowTurningPtCmd::SelectPipeObj));

	
	AddAnalyseNotificationCB(_pATOZShowTurningPtDlg->_MultiListPoints,
		_pATOZShowTurningPtDlg->_MultiListPoints->GetListSelectNotification(),
		(CATCommandMethod)&ATOZShowTurningPtCmd::OnSelect, NULL);


	//click OK button
	AddAnalyseNotificationCB(_pATOZShowTurningPtDlg,
		_pATOZShowTurningPtDlg->GetDiaOKNotification(),
		(CATCommandMethod)&ATOZShowTurningPtCmd::OKAction, NULL);

	//click Wndclose buttion
	AddAnalyseNotificationCB(_pATOZShowTurningPtDlg,
		_pATOZShowTurningPtDlg->GetWindCloseNotification(),
		(CATCommandMethod)&ATOZShowTurningPtCmd::ExitCmd, NULL);

	//click cancel button
	AddAnalyseNotificationCB(_pATOZShowTurningPtDlg,
		_pATOZShowTurningPtDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&ATOZShowTurningPtCmd::ExitCmd, NULL);


}

void ATOZShowTurningPtCmd::OKAction()
{
	ExecuteUndoAtEnd();
	this->RequestDelayedDestruction();
	return;
}

void ATOZShowTurningPtCmd::ExitCmd()
{
	ExecuteUndoAtEnd();
	this->RequestDelayedDestruction();
	return;
}


void ATOZShowTurningPtCmd::SelectPipeObj()
{
	cout << endl;
	cout << "ATOZShowTurningPtCmd::SelectPipeObj" << endl;
	_listOfGuidePts.RemoveAll();

	CATPathElement* pPathElem = _pSelPipePathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = pPathElem->GetCurrentObject();
	_pSelPipePathElemAgent->InitializeAcquisition();

	ClearSO();
	HighlightPathElemObj(pPathElem);

	_spPipeInst = pBaseUnknown;
	if (NULL_var == _spPipeInst)
	{
		::DisplayMessage("Error", "未获取管道!", "ERROR");
		return;
	}

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZShowTurningPtDlg->_SelectorListPipe;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}

	//找到引导点
	//CATLISTV(CATIMmiMechanicalFeature_var) listOfGuidePts;
	CATLISTP(CATMathPoint) ListPofCoordinateNode;

	CATBaseUnknown *pIUnkPipeRef = NULL;
	_spPipeInst->GetReference(pIUnkPipeRef);
	if (NULL != pIUnkPipeRef){
		CATIPipRigidPipeReference_var spPipRigidRef;
		spPipRigidRef = pIUnkPipeRef;
		if (NULL_var != spPipRigidRef) {
			spPipRigidRef->GetCoordinateofNode(ListPofCoordinateNode);
			spPipRigidRef->GetAllPoints(_listOfGuidePts);
		}
			

		pIUnkPipeRef->Release(); pIUnkPipeRef = NULL;
	}

	//获取转换矩阵
	CATMathTransformation AbsTransMatric;

	CATIMovable_var spMovable = pPathElem->CurrentElement();
	if (NULL_var != spMovable) 
		spMovable->GetAbsPosition(AbsTransMatric);


	//获取基准面高度
	CATUnicodeString strFoundation = _pATOZShowTurningPtDlg->_EditorFund->GetText();
	
	double iFoundation(0.0f);
	strFoundation.ConvertToNum(&iFoundation);


	//将点的信息显示到对话框中
	CATDlgMultiList* pDlgMultiSelList = _pATOZShowTurningPtDlg->_MultiListPoints;
	pDlgMultiSelList->ClearLine();

	pDlgMultiSelList->SetColumnItem(1, "拐点序号");
	pDlgMultiSelList->SetColumnItem(2, "拐点高度值");

	//const int SIZE = listOfGuidePts.Size();
	const int SIZE = ListPofCoordinateNode.Size();

	for (int i = 1; i <= SIZE; i++)
	{
		CATMathPoint retrievedMathPt;

		retrievedMathPt = (*ListPofCoordinateNode[i]);

		/*CATPoint_var spPoint = listOfGuidePts[i];
		if (NULL_var != spPoint) 
			spPoint->GetMathPoint(retrievedMathPt);*/

		cout << "转换前的坐标为:" << endl;
		retrievedMathPt.Dump();

		CATUnicodeString CurrentNum("");
		CurrentNum.BuildFromNum(i);


		CATMathPoint translated = AbsTransMatric*retrievedMathPt;
		cout << "测试函数转换后的全局坐标为：";
		cout << translated.GetX() << " " << translated.GetY() << " " << translated.GetZ() << endl;

		CATUnicodeString thisH("");
		thisH.BuildFromNum(translated.GetZ());

		pDlgMultiSelList->SetColumnItem(1, CurrentNum);
		pDlgMultiSelList->SetColumnItem(2, thisH);

	}



	return;
	//创建上下文occurrence
	CATIPLMNavOccurrence_var spOccurInCnt(NULL_var);
	//CreateContextOccurrence(pPathElem, spOccurInCnt);


	//==========================================================================
	//将所有引导点显示到对话框中

	//CATBaseUnknown *pIUnkPipeRef = NULL;
	//_spPipeInst->GetReference(pIUnkPipeRef);
	//if (NULL != pIUnkPipeRef)
	//{
	//	//to do:清理对话框多行多列表
	//	//

	//	//引导点获取
	//	CATIPipRigidPipeReference_var hPipRigidRef;
	//	hPipRigidRef = pIUnkPipeRef;
	//	if (NULL_var != hPipRigidRef)
	//	{
	//		CATLISTP(CATMathPoint) ListPofCoordinateNode;

	//		hPipRigidRef->GetCoordinateofNode(ListPofCoordinateNode);
	//	
	//		const int SIZE = ListPofCoordinateNode.Size();

	//		cout << "the root is " << CATIAlias_var(_spRootOccur)->GetAlias() << endl;
	//		for (int i = 1; i <= SIZE; i++)
	//		{
	//			CATMathPoint retrievedMathPt = *(ListPofCoordinateNode[i]);

	//			CATIMovable_var spMovable(NULL_var);
	//			CATMathTransformation oAbsTransMatric;
	//			spMovable = spOccurInCnt;
	//			if (NULL_var != spMovable) {
	//				if (SUCCEEDED(spMovable->GetAbsPosition(oAbsTransMatric)))
	//					cout << "GetAbsPosition excuted" << endl;
	//				else
	//					cout << "GetAbsPosition failed" << endl;
	//			}

	//			CATMathPoint translated = oAbsTransMatric*retrievedMathPt;
	//			cout << "测试函数转换后的全局坐标为：";
	//			cout << translated.GetX() << " " << translated.GetY() << " " << translated.GetZ() << endl;

	//			//测试是否需要再次获取OIC

	//			//将点的信息显示到对话框中

	//		}
	//	}

	//	pIUnkPipeRef->Release(); pIUnkPipeRef = NULL;
	//}




}

//HRESULT ATOZShowTurningPtCmd::CreateContextOccurrence(CATPathElement *&ithisPathElt, CATIPLMNavOccurrence_var &oOccurrence)
//{
//	
//	ithisPathElt->InitToLeafElement();
//	CATBaseUnknown_var spFatherNod = ithisPathElt->NextFatherElement();
//
//	CATLISTV(CATBaseUnknown_var) oPathOfInstances; //中转
//	CATListPtrCATIPLMNavInstance pathOfIns;
//
//	CATIPLMNavOccurrence_var thisOccur(NULL_var);
//	if (ithisPathElt)
//		while (spFatherNod != NULL_var)
//		{
//			thisOccur = spFatherNod;
//
//			CATIPLMNavInstance* piInstance(NULL);
//			thisOccur->GetRelatedInstance(piInstance);
//			if (NULL != piInstance) {
//				oPathOfInstances.Append(piInstance);
//				piInstance->Release(); piInstance = NULL;
//			}
//				
//			spFatherNod = ithisPathElt->NextFatherElement();
//		}
//
//	for (int i = oPathOfInstances.Size(); i >= 1; i--)
//	{
//		CATIPLMNavInstance_var spThisInst = oPathOfInstances[i];
//		cout << "name of instance is " << CATIAlias_var(spThisInst)->GetAlias() << endl;
//		pathOfIns.Append(spThisInst);
//	}
//	ithisPathElt->InitToLeafObject();
//
//	CATIPrdOccurrenceMngt* occMngt = NULL;
//	if (SUCCEEDED(CATPrdGetOccurrenceMngt(occMngt)) && (NULL != occMngt))
//		occMngt->GetOccurrence(_spRootOccur, pathOfIns, oOccurrence);
//
//	return S_OK;
//}

void ATOZShowTurningPtCmd::OnSelect()
{

	int _oSelectedRows[10];
	int oArraySize(1);
	int NumberOfSelectedRows;
	NumberOfSelectedRows = _pATOZShowTurningPtDlg->_MultiListPoints->GetSelect(
		_oSelectedRows,
		oArraySize);

	const int selected = _oSelectedRows[0];

	cout << "选中的元素为 ";
	cout << selected;
	cout << endl;

	CATIMmiMechanicalFeature_var spSelectedFeat = _listOfGuidePts[selected];
	if (NULL_var != spSelectedFeat) {
		::ClearSO();
		::SetSpecObjShowAttr(spSelectedFeat, CATUnicodeString("Show"));
		::AddHighlightRelatedObj(spSelectedFeat);
	}

}