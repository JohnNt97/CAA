//===================================================================
// COPYRIGHT ATOZ 2020/11/23
//===================================================================
// ClsUniversalOperationFunc.cpp
// Header definition of class ClsUniversalOperationFunc
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2020/11/23 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ClsUniversalOperationFunc.h"

ExportedByATOZDrawingPubFunc
void  Send_Message(CATUnicodeString strMessage, CATUnicodeString strTitle)
{
	CATDlgNotify *pDlgNotify = new CATDlgNotify((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(), "Message!", CATDlgNfyInformation | CATDlgNfyOK);
	pDlgNotify->SetVisibility(CATDlgShow);
	int iRet = pDlgNotify->DisplayBlocked(strMessage, strTitle);
	if (iRet == 1)
	{
		pDlgNotify->RequestDelayedDestruction();
		pDlgNotify = NULL;
	}
}
ExportedByATOZDrawingPubFunc
void Get_current_viewer(CATViewer *& pCurrentViewer)
{
	CATFrmLayout * pCurrentLayout = CATFrmLayout::GetCurrentLayout();
	if (NULL != pCurrentLayout)
	{
		CATFrmWindow * pCurrentWindow = pCurrentLayout->GetCurrentWindow();

		if (NULL != pCurrentWindow)
		{
			pCurrentViewer = pCurrentWindow->GetViewer();
		}
	}

}
//get RootNavRef
ExportedByATOZDrawingPubFunc
HRESULT RetrieveRootProd(CATIPLMNavReference_var &ospRootNavRef)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATLISTP(CATIPLMComponent) listComponent = NULL;
	HRESULT rc = CATPLMComponentInterfacesServices::GetEditedRootPLMComponents(pFrmEditor,
		listComponent);
	if (FAILED(rc) || (0 == listComponent.Size()))
	{
		cout << "ERROR:RetrieveRootProd()-0 == listComponent.Size()" << endl;
		return rc;
	}
	CATIPLMComponent* pRootComponent = listComponent[1];
	ospRootNavRef = pRootComponent;
	if (NULL_var == ospRootNavRef) return E_FAIL;
	return S_OK;
}
ExportedByATOZDrawingPubFunc
HRESULT GetPartObject(const CATIPLMNavReference_var &ispPLMNavRef, CATIMmiUsePrtPart_var &ospPrtPart)
{
	if (NULL_var == ispPLMNavRef) return E_FAIL;

	HRESULT rc = E_FAIL;
	CATIPLMNavRepInstance* piPLMNavRefIns = NULL;
	CATPLMCoreType TypeRepInstance = PLMCoreRepInstance;
	CATListPtrCATIPLMNavEntity listPLMNavEntity = NULL;

	ispPLMNavRef->ListChildren(listPLMNavEntity, 1, &TypeRepInstance);
	if (listPLMNavEntity.Size() == 0)
	{
		cout << "ERROR:GetPartObject()-listPLMNavEntity.Size() == 0" << endl;
		return E_FAIL;
	}
	else
	{
		CATIPLMNavEntity* piPLMNavEntity = listPLMNavEntity[1];
		if (NULL != piPLMNavEntity)
		{
			rc = piPLMNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void**)&piPLMNavRefIns);
		}
	}
	if (NULL == piPLMNavRefIns)
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRefIns" << endl;
		return E_FAIL;
	}
	CATIPLMNavRepReference* piPLMNavRepRef = NULL;
	rc = piPLMNavRefIns->GetRepReferenceInstanceOf(piPLMNavRepRef);
	piPLMNavRefIns->Release(); piPLMNavRefIns = NULL;
	if (FAILED(rc) || (NULL == piPLMNavRepRef))
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRepRef" << endl;
		return E_FAIL;
	}

	CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
	rc = piPLMNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&piRepLoadMode);
	if (SUCCEEDED(rc) && NULL != piRepLoadMode)
	{
		rc = piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
		piRepLoadMode->Release();
		piRepLoadMode = NULL;
	}

	CATIMmiPrtContainer * piPrtContainer = NULL;
	rc = piPLMNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&piPrtContainer);
	if (SUCCEEDED(rc) && (NULL != piPrtContainer))
	{
		CATIMmiMechanicalFeature_var spMechFeature = NULL_var;
		piPrtContainer->GetMechanicalPart(spMechFeature);
		piPrtContainer->Release();
		piPrtContainer = NULL;

		ospPrtPart = spMechFeature;
	}

	piPLMNavRepRef->Release();
	piPLMNavRepRef = NULL;
	return rc;
}

ExportedByATOZDrawingPubFunc
HRESULT CAAUpdateObject(CATBaseUnknown_var spUpdateObjectBU)
{
	if (NULL_var == spUpdateObjectBU)
	{
		cout << "ERROR:CAAUpdateObject() - spUpdateObjectBU is NULL!" << endl;
		return E_FAIL;
	}

	CATIUseEntity *piUseEntity = NULL;
	HRESULT rc = spUpdateObjectBU->QueryInterface(IID_CATIUseEntity, (void**)&piUseEntity);
	if (SUCCEEDED(rc))
	{
		rc = DataCommonProtocolServices::Update(piUseEntity);
		if (FAILED(rc))
		{
			CATError * pError = CATError::CATGetLastError(rc);
			if (NULL != pError)
			{
				cerr << "Error message is " << pError->GetNLSMessage() << endl;
				pError->Release();
				pError = NULL;
			}
		}
		piUseEntity->Release();
		piUseEntity = NULL;
	}

	return rc;
}
//add highlightObject
ExportedByATOZDrawingPubFunc
void AddHighlightRelatedObj(CATBaseUnknown* pObject)
{
	if (pObject == NULL) return;

	CATFrmEditor* pEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pEditor)
	{
		cout << "ERROR:RemoveHightlightObj-NULL == pEditor" << endl;
		return;
	}

	CATHSO* pHSO = pEditor->GetHSO();
	if (NULL == pHSO)
	{
		cout << "ERROR:RemoveHightlightObj-NULL == pHSO" << endl;
		return;
	}

	//pHSO->Empty();

	CATPathElement* pPathElement = ExtractPathElement(pObject);
	if (pPathElement != NULL)
	{
		pHSO->AddElements(pPathElement);
		pHSO->EndAddElements();
	}
}

ExportedByATOZDrawingPubFunc
HRESULT DeleteAnything(CATBaseUnknown_var spDeleteObjectBU)
{
	if (NULL_var == spDeleteObjectBU)
	{
		cout << "ERROR:DeleteAnything() - spDeleteObjectBU is NULL!" << endl;
		return E_FAIL;
	}

	CATIUseEntity *piUseEntity = NULL;
	HRESULT rc = spDeleteObjectBU->QueryInterface(IID_CATIUseEntity, (void**)&piUseEntity);
	if (SUCCEEDED(rc))
	{
		rc = DataCommonProtocolServices::Delete(piUseEntity);
		if (FAILED(rc))
		{
			CATError * pError = CATError::CATGetLastError(rc);
			if (pError != NULL)
			{
				cerr << "Error message is " << pError->GetNLSMessage() << endl;
				pError->Release();
				pError = NULL;
			}
		}

		piUseEntity->Release();
		piUseEntity = NULL;

	}

	return rc;
}
//get object fullpath
ExportedByATOZDrawingPubFunc
CATUnicodeString RetrievefullPathOfObj(CATBaseUnknown* pObject)
{
	CATUnicodeString  oPathName("");

	CATPathElement* pPathElement = ExtractPathElement(pObject);
	PathElementString(pPathElement, oPathName);

	return oPathName;
}
//extract object pathelement
ExportedByATOZDrawingPubFunc
CATPathElement* ExtractPathElement(CATBaseUnknown* pObject)
{
	HRESULT rc = S_OK;
	CATPathElement* pPathElement = NULL;

	do {

		if (!pObject) break;

		CATIBuildPath* pBuildPath = NULL;

		rc = pObject->QueryInterface(IID_CATIBuildPath, (void**)&pBuildPath);
		if (FAILED(rc))
		{
			break;
		}

		CATPathElement activePath = CATFrmEditor::GetCurrentEditor()->GetUIActiveObject();
		rc = pBuildPath->ExtractPathElement(&activePath, &pPathElement);
		if (pBuildPath)
		{
			pBuildPath->Release();
			pBuildPath = NULL;
		}

		if (FAILED(rc) || !pPathElement) break;

	} while (0);

	if (FAILED(rc)) pPathElement = NULL;

	return pPathElement;

}
//printf object fullpath
ExportedByATOZDrawingPubFunc
void PathElementString(CATPathElement * ipPath, CATUnicodeString & oPathName)
{

	oPathName = "";
	if (NULL != ipPath)
	{
		int sizeOfThePath = ipPath->GetSize();

		for (int i = sizeOfThePath - 1; i >= 0; i--)
		{
			CATBaseUnknown * pElt = (*ipPath)[i];
			if (NULL != pElt)
			{
				CATIAlias * pIAliasOnElt = NULL;
				HRESULT rc = pElt->QueryInterface(IID_CATIAlias, (void**)&pIAliasOnElt);
				if (SUCCEEDED(rc))
				{
					CATUnicodeString Name = pIAliasOnElt->GetAlias();
					oPathName.Append(Name);

					if (i > 0)
					{
						oPathName.Append("/"); ;
					}

					pIAliasOnElt->Release();
					pIAliasOnElt = NULL;
				}
			}
		}
	}
}
//redraw spectree
ExportedByATOZDrawingPubFunc
HRESULT RedrawSpecTree(const CATIPLMNavReference_var &iNodeProd)
{
	if (NULL_var == iNodeProd)return E_FAIL;

	CATIModelEvents_var spModelEventOnProduct(iNodeProd);

	CATModify event((CATBaseUnknown*)iNodeProd);
	spModelEventOnProduct->Dispatch(event);

	CATIRedrawEvent_var spRedrawEventOnProduct(iNodeProd);
	spRedrawEventOnProduct->Redraw();

	return S_OK;
}

//Check reference is parttype
ExportedByATOZDrawingPubFunc
HRESULT Check3DPart(const CATIPLMNavReference_var ispNavReference, CATBoolean & oIsA3DPart)
{
	HRESULT rc = E_INVALIDARG;
	if (NULL_var != ispNavReference)
	{
		oIsA3DPart = FALSE;

		CATICkeObject_var spCkeObjectOnProduct = ispNavReference;
		if (NULL_var != spCkeObjectOnProduct)
		{
			CATUnicodeString AttributeName = "V_usage";
			CATUnicodeString Usage;
			rc = CATCkeObjectAttrReadServices::GetValueAsString(spCkeObjectOnProduct, AttributeName, Usage);
			//cout << "current V_usage is " << Usage << endl;
			if (SUCCEEDED(rc) && Usage == "3DPart")  oIsA3DPart = TRUE;
		}
		else  rc = E_NOINTERFACE;

	}
	return rc;
}
//get PLMComponent type
ExportedByATOZDrawingPubFunc
HRESULT RetrieveComponentType(const CATBaseUnknown_var &ispPLMObject, CATUnicodeString &ostrType)
{
	if (NULL_var == ispPLMObject)
	{
		cout << "ERROR:RetrieveComponentType()-NULL_var == ispPLMObject" << endl;
		return E_FAIL;
	}

	CATIPLMComponent_var spPLMComponent = ispPLMObject;
	if (NULL_var == spPLMComponent)
	{
		cout << "ERROR:RetrieveComponentType()-NULL_var == spPLMComponent" << endl;
		return E_FAIL;
	}
	//Type
	CATIAdpType *piAdpType = NULL;
	HRESULT rc = spPLMComponent->GetAdpType(piAdpType);
	if (FAILED(rc) || NULL == piAdpType)
	{
		cout << "ERROR:RetrieveComponentType()-NULL == piAdpType" << endl;
		return E_FAIL;
	}
	CATUnicodeString strProductTypeValue("");
	CATIType *piCkeType = NULL;
	rc = CATPLMTypeServices::GetKweTypeFromAdpType(piAdpType, piCkeType);
	if (SUCCEEDED(rc))
	{
		CATUnicodeString CurrentCustoName = piCkeType->Name();
		cout << "Current Type Name is :" << CurrentCustoName.ConvertToChar() << endl;

		//CATUnicodeString CurrentUserName = piCkeType->UserName();
		//cout << "Current User Name is :" << CurrentUserName.ConvertToChar() << endl;
		ostrType = CurrentCustoName;

		piAdpType->Release();
		piAdpType = NULL;

		piCkeType->Release();
		piCkeType = NULL;
	}

	return rc;
}
//get component attrValues
ExportedByATOZDrawingPubFunc
HRESULT GetAttributes(CATIPLMComponent* ipPLMComp,
	CATListOfCATUnicodeString &strListOfName,
	CATListOfCATUnicodeString &strListOfValue)
{
	HRESULT rc(S_OK);

	if (NULL == ipPLMComp)
	{
		cout << "ERROR::GetAttributes() - ipPLMComp is NULL!" << endl;
		return E_FAIL;
	}

	int iCounts = strListOfName.Size();
	if (0 == iCounts)
	{
		cout << "ERROR:GetAttributes() - iCounts is 0!" << endl;
		return E_FAIL;
	}

	CATICkeObject_var spCkeObjectOnComp = ipPLMComp;
	if (NULL_var == spCkeObjectOnComp)
	{
		cout << "ERROR::GetAttributes() - spCkeObjectOnComp is NULL!" << endl;
		return E_FAIL;
	}

	strListOfValue.RemoveAll();

	CATListValCATAttributeInfos ListOfAttributes;
	rc = CATCkePLMNavPublicServices::ListAttributesFromObject(CATCkePLMTypeAttrServices::All,
		spCkeObjectOnComp,
		ListOfAttributes,
		FALSE);

	for (int i = 1; i <= iCounts; i++)
	{
		CATUnicodeString strCurrentName(strListOfName[i]);
		CATUnicodeString strValue("");

		for (int j = 1; j <= ListOfAttributes.Size(); j++)
		{
			CATAttributeInfos AttributeInfos(ListOfAttributes[j]);
			CATUnicodeString ValueAsString;
			CATUnicodeString NameAsString = AttributeInfos.Name();
			CATCkeObjectAttrReadServices::GetValueAsString(spCkeObjectOnComp, NameAsString, ValueAsString);
			CATUnicodeString NLSNameAsString;
			CATCkeObjectAttrReadServices::GetAttributeNLSNameFromObject(spCkeObjectOnComp, NameAsString, NLSNameAsString);

			if (strCurrentName == NameAsString)
			{
				//cout<<" name is "<< NameAsString.ConvertToChar()<<",nlsname is "<<NLSNameAsString<<",value is "<<ValueAsString.ConvertToChar()<<endl;
				strValue = ValueAsString;
				break;
			}
		}

		strListOfValue.Append(strValue);
	}

	return S_OK;
}
//get component allAttrs
ExportedByATOZDrawingPubFunc
HRESULT DisplayAttributes(CATIPLMComponent* ipPLMComp)
{
	if (NULL == ipPLMComp) return E_INVALIDARG;
	CATICkeObject_var spCkeObjectOnComp = ipPLMComp;
	if (NULL_var == spCkeObjectOnComp) return E_INVALIDARG;

	HRESULT rc = S_OK;

	//Test
	/*CATIAdpType *piAdpType = NULL;
	rc = ipPLMComp->GetAdpType(piAdpType);
	if(NULL!=piAdpType)
	{
	CATUnicodeString strType(""),strAlias("");
	rc = piAdpType->GetAlias(strAlias);
	rc = piAdpType->GetPLMModeler(strType);

	cout<<strType<<" "<<strAlias<<endl;
	}*/

	CATListValCATAttributeInfos ListOfAttributes;
	rc = CATCkePLMNavPublicServices::ListAttributesFromObject(CATCkePLMTypeAttrServices::All, spCkeObjectOnComp, ListOfAttributes, FALSE);//TRUE    
	for (int i = 1; i <= ListOfAttributes.Size(); i++)
	{
		CATAttributeInfos AttributeInfos(ListOfAttributes[i]);
		CATUnicodeString ValueAsString;
		CATUnicodeString NameAsString = AttributeInfos.Name();
		CATCkeObjectAttrReadServices::GetValueAsString(spCkeObjectOnComp, NameAsString, ValueAsString);

		CATUnicodeString attrNLSName;
		CATCkeObjectAttrReadServices::GetAttributeNLSNameFromObject(spCkeObjectOnComp, NameAsString, attrNLSName);

		cout << " name is " << NameAsString.ConvertToChar() << " nls is " << attrNLSName << " value is " << ValueAsString.ConvertToChar() << endl;
	}
	cout << endl;
	return rc;
}

//Create geoSet under the part
ExportedByATOZDrawingPubFunc
HRESULT CAAGsiCreateGeometricFeatureSets(CATIMmiUsePrtPart_var spPrtPart,
	CATUnicodeString strGSMName,
	CATIMmiMechanicalFeature_var &ospGsmTool)
{
	if (NULL_var == spPrtPart)
		return E_FAIL;

	HRESULT rc = E_FAIL;

	CATIMmiMechanicalFeature_var spMechFeatOnMainTool = spPrtPart;
	if (NULL_var != spMechFeatOnMainTool)
	{
		//Get container
		CATIMmiPrtContainer_var spPrtCont = NULL_var;
		rc = spMechFeatOnMainTool->GetPrtContainer(spPrtCont);
		if (SUCCEEDED(rc) && spPrtCont != NULL_var)
		{
			CATIMmiUseSetFactory_var spMechanicalRootFactory = spPrtCont;
			if (spPrtCont != NULL_var)
			{
				CATIMmiMechanicalFeature_var spGSMTool;
				rc = spMechanicalRootFactory->CreateGeometricalSet(strGSMName, spMechFeatOnMainTool, spGSMTool);

				ospGsmTool = spGSMTool;
			}
		}
	}

	return rc;
}
//Create geoSet under the GeoSet
ExportedByATOZDrawingPubFunc
HRESULT CAAGsiCreateSonGeometricFeatureSets(CATIMmiUsePrtPart_var spPrtPart,
	const CATIMmiMechanicalFeature_var &spParentGSMTool,
	CATUnicodeString strGSMName,
	CATIMmiMechanicalFeature_var &ospGsmTool)
{
	if ((NULL_var == spPrtPart) || (NULL_var == spParentGSMTool))
		return E_FAIL;

	//激活几何集
	spPrtPart->SetInWorkObject(spParentGSMTool);

	HRESULT rc = E_FAIL;

	CATIMmiMechanicalFeature_var spMechFeatOnMainTool = spPrtPart;
	if (NULL_var != spMechFeatOnMainTool)
	{
		//Get container
		CATIMmiPrtContainer_var spPrtCont = NULL_var;
		rc = spMechFeatOnMainTool->GetPrtContainer(spPrtCont);
		if (SUCCEEDED(rc) && spPrtCont != NULL_var)
		{
			CATIMmiUseSetFactory_var spMechanicalRootFactory = spPrtCont;
			if (spPrtCont != NULL_var)
			{
				CATIMmiMechanicalFeature_var spGSMTool;
				rc = spMechanicalRootFactory->CreateGeometricalSet(strGSMName, spParentGSMTool, spGSMTool, 0);

				ospGsmTool = spGSMTool;
			}
		}

	}
	return rc;
}
//get the geoset under the part
ExportedByATOZDrawingPubFunc
HRESULT CAAGsiGetGeometricFeatureSets(CATIMmiUsePrtPart_var spPrtPart,
	CATUnicodeString strGSMName,
	CATIMmiMechanicalFeature_var &ospGsmTool)
{
	if (NULL_var == spPrtPart)return E_FAIL;

	CATIPartRequest_var spPartRequest = spPrtPart;
	if (NULL_var == spPartRequest)
	{
		cout << "ERROR:ClsCreateShipLinesPubFunc::CAAGsiGetGeometricFeatureSets()-NULL_var == spPartRequest" << endl;
		return E_FAIL;
	}

	const CATUnicodeString stdContext(" ");

	CATLISTV(CATBaseUnknown_var) SurfacicSetList;
	spPartRequest->GetSurfBodies(stdContext, SurfacicSetList);

	//遍历Part下第一层几何图形集
	for (int i = 1; i <= SurfacicSetList.Size(); i++)
	{
		CATIMmiMechanicalFeature_var spGSMTool = SurfacicSetList[i];
		if (NULL_var == spGSMTool) continue;

		CATIAlias_var spAliasName = spGSMTool;
		if (NULL_var == spAliasName) continue;

		CATUnicodeString strGSMToolName = spAliasName->GetAlias();
		if (strGSMToolName == strGSMName)
		{
			ospGsmTool = spGSMTool;
			break;
		}
	}

	return S_OK;
}
//get the geoset under the geoset
ExportedByATOZDrawingPubFunc
HRESULT CAAGsiGetSonGeometricFeatureSets(const CATIMmiMechanicalFeature_var &ispParentTool,
	CATUnicodeString strGSMName,
	CATIMmiMechanicalFeature_var &ospGsmTool)
{
	if (NULL_var == ispParentTool) return E_FAIL;

	CATIBodyRequest_var spBodyRequest = ispParentTool;
	if (NULL_var == spBodyRequest) return E_FAIL;

	CATLISTV(CATBaseUnknown_var) ListResult;
	spBodyRequest->GetDirectBodies(ListResult);
	for (int i = 1; i <= ListResult.Size(); i++)
	{
		CATIMmiMechanicalFeature_var spSonGSMTool = ListResult[i];
		if (NULL_var == spSonGSMTool) continue;

		CATIAlias_var spAliasName = spSonGSMTool;
		if (NULL_var == spAliasName) continue;

		CATUnicodeString strGSMToolName = spAliasName->GetAlias();
		if (strGSMToolName == strGSMName)
		{
			ospGsmTool = spSonGSMTool;
			break;
		}
	}

	return S_OK;
}

ExportedByATOZDrawingPubFunc
void ViewReframe(CAT3DViewer* p3DViewer, CAT3DRep* p3DBagRep)
{
	//Retrieving of the main 3D viewpoint:
	CAT3DViewpoint &vp3d = p3DViewer->GetMain3DViewpoint();

	//Retrieving of the window dimensions:
	float windowWidth(0), windowHeight(0);
	p3DViewer->GetGraphicSize(&windowWidth, &windowHeight);

	//If the window is not square, we can distinguish two different
	//angles in our view pyramid.
	//Usually we work with the teta angle, but, if our window height is greater
	//than our window width, that means that we must take care of the smallest
	//dimension (i.e the window width), and so, work with the other angle.

	float ratio;
	if (windowHeight > windowWidth) //that means that we must take care
									//of the other angle of the frustum
									//which can be approximated by teta*(windowWidth/windowHeight)
	{
		ratio = windowHeight / windowWidth;
	}
	else
	{
		ratio = 1.0f;
	}

	//To reframe the view, we also need the representation bounding volume.
	// CAT3DBagRep * rootBag = (CAT3DBagRep *)(vp3d.GetBag());
	CAT3DRep * rootBag = p3DBagRep;


	if (NULL != rootBag)
	{

		//If the bounding element is invalid, let's force its calculation:
		if (rootBag->IsInvalid())
			rootBag->ComputeBoundingElement(1);

		//Retrieving of the bounding element:
		const CAT3DBoundingSphere &bs3d = rootBag->GetBoundingElement();

		//Retrieving of the bounding element radius:
		float radius = bs3d.GetRadius();

		if (radius == 0.f)
			radius = bs3d.GetRadiusMM(); //Returns the radius for fixed objects
										 //on which zoom has no effect.

										 //We also need to know the opening angle of our frustum to calculate
										 //the distance to the object the eye must be to view it completely.
										 //This angle is the "teta" we dealt with just above:
		float angle = vp3d.GetAngle();

		//Some tools are available for conversions:
		angle = (float)CATDegreeToRadian*angle;

		//The focus is the eye-target distance.
		float focus = 1.05f * (radius / tan(angle)) * ratio;
		//float focus = 1.5f * (radius/tan(angle)) * ratio;

		//Calculation of the new eye position:
		CATMathPointf eyePosition = bs3d.GetCenter() - vp3d.GetSightDirection()*focus;


		//Setting of the viewpoint's changed parameters:
		// - Focus
		// - Eye position
		vp3d.SetFocus(focus);
		vp3d.SetOrigin(eyePosition);
	}
}

//get topbody of the feature
ExportedByATOZDrawingPubFunc
CATBody_var GetBodyFromFeature(const CATIMmiMechanicalFeature_var& ispFeature)
{

	CATBody_var spBody = NULL_var;

	do {
		if (!ispFeature) {
			break;
		}
		CATIMmiUseMfBRep_var spBRepOnFeature = ispFeature;
		if (spBRepOnFeature != NULL_var) {
			spBRepOnFeature->GetBody(spBody);
		}
		else {
			CATIMmiUseGeometricalElement_var spGeometricalElementOnFeature = ispFeature;
			if (spGeometricalElementOnFeature != NULL_var) {
				spGeometricalElementOnFeature->GetBodyResult(spBody);
			}
			else {
				CATIBodyRequest_var spBodyRequestOnModel = ispFeature;
				if (!spBodyRequestOnModel) {
					break;
				}
				CATListValCATBaseUnknown_var listResult;
				HRESULT rc = spBodyRequestOnModel->GetResults("MfDefault3DView", listResult);
				if (FAILED(rc)) {
					break;
				}
				if (listResult.Size() == 0) {
					break;
				}
				CATIMmiUseGeometricalElement_var spGeometricalElementOnBody = listResult[1];
				if (!spGeometricalElementOnBody) {
					break;
				}
				spGeometricalElementOnBody->GetBodyResult(spBody);
			}
		}

		if (!spBody) {
			break;
		}
	} while (FALSE);

	return spBody;
}
//reframe specobject center
ExportedByATOZDrawingPubFunc
void ReFrameSpecObjCenter(const CATIMmiMechanicalFeature_var &ispSpecObject)
{
	double oBoxCord[6];
	BoundingShape(ispSpecObject, oBoxCord);

	CATMathPointf _ViewOrigin;
	_ViewOrigin.x = (oBoxCord[0] + oBoxCord[1]) / 2;
	_ViewOrigin.y = (oBoxCord[2] + oBoxCord[3]) / 2;
	_ViewOrigin.z = (oBoxCord[4] + oBoxCord[5]) / 2;


	CATViewer *  _pCurrentViewer;
	Get_current_viewer(_pCurrentViewer);

	CAT3DViewpoint * pMain3DViewpoint = &(_pCurrentViewer->GetMain3DViewpoint());


	double temp = ((oBoxCord[0] - oBoxCord[1]) / 2)*((oBoxCord[0] - oBoxCord[1]) / 2) +
		((oBoxCord[2] - oBoxCord[3]) / 2)*((oBoxCord[2] - oBoxCord[3]) / 2) +
		((oBoxCord[4] - oBoxCord[5]) / 2)*((oBoxCord[4] - oBoxCord[5]) / 2);

	float Radius = sqrt(temp);

	CATSupport & Support = _pCurrentViewer->GetSupport();
	float width, height, MMInSupportUnit, RatioWH;
	Support.GetWidthAndHeight(width, height);
	MMInSupportUnit = Support.GetMMInSupportUnit();
	RatioWH = Support.GetRatioWH();
	CAT3DBoundingSphere BoundingSphere(_ViewOrigin, Radius * 2);

	pMain3DViewpoint->Reframe(width, height, MMInSupportUnit, RatioWH, BoundingSphere);
}
//get the Feature BoundingBox
ExportedByATOZDrawingPubFunc
HRESULT BoundingShape(const CATIMmiMechanicalFeature_var &ispSpecObject, double oBoxCord[6])
{
	HRESULT rc = S_OK;

	memset(oBoxCord, 0, sizeof(double) * 6);

	CATBody_var spResultBody = GetBodyFromFeature(ispSpecObject);
	if (NULL_var == spResultBody) return E_FAIL;

	CATMathBox oBox;
	spResultBody->GetBoundingBox(oBox);

	double  ioXMin, ioXMax, ioYMin, ioYMax, ioZMin, ioZMax;
	oBox.GetExtremities(ioXMin, ioXMax, ioYMin, ioYMax, ioZMin, ioZMax);

	if (oBoxCord[0] == oBoxCord[1])
	{
		oBoxCord[0] = ioXMin;
		oBoxCord[1] = ioXMax;
	}
	else
	{
		if (oBoxCord[0]>ioXMin)
			oBoxCord[0] = ioXMin;
		if (oBoxCord[1]<ioXMax)
			oBoxCord[1] = ioXMax;
	}

	if (oBoxCord[2] == oBoxCord[3])
	{
		oBoxCord[2] = ioYMin;
		oBoxCord[3] = ioYMax;
	}
	else
	{
		if (oBoxCord[2]>ioYMin)
			oBoxCord[2] = ioYMin;
		if (oBoxCord[3]<ioYMax)
			oBoxCord[3] = ioYMax;
	}

	if (oBoxCord[4] == oBoxCord[5])
	{
		oBoxCord[4] = ioZMin;
		oBoxCord[5] = ioZMax;
	}
	else
	{
		if (oBoxCord[4]>ioZMin)
			oBoxCord[4] = ioZMin;
		if (oBoxCord[5]<ioZMax)
			oBoxCord[5] = ioZMax;
	}

	return S_OK;
}
//get the Feature BoundingBox
ExportedByATOZDrawingPubFunc
CATBoolean CenterGraphOnObject()
{
	// Retrieves the current window 
	CATFrmLayout * pLayout = CATFrmLayout::GetCurrentLayout();
	if (NULL == pLayout) return TRUE;

	CATFrmWindow * pCurrentWindow = pLayout->GetCurrentWindow();
	if (NULL == pCurrentWindow) return TRUE;

	// If it is a CATFrmNavigGraphicWindow, it is possible to
	// retrieve a CATNavigBox pointer
	//
	if (1 != pCurrentWindow->IsAKindOf("CATFrmNavigGraphicWindow")) return TRUE;

	CATFrmNavigGraphicWindow * pFrmNavigGraphicWindow =
		(CATFrmNavigGraphicWindow*)pCurrentWindow;

	CATNavigBox * pNavigBox = NULL;
	pNavigBox = pFrmNavigGraphicWindow->GetNavigBox();

	if (NULL == pNavigBox) return TRUE;

	// Perform center graph action on highlighted object
	//
	CATCafCenterGraph CenterGraphObj;
	CenterGraphObj.CenterGraph("OnHSO", pNavigBox);

	return TRUE;
}
//Copy 
ExportedByATOZDrawingPubFunc
HRESULT CopyObjectIntoSpecGeoTool(CATIMmiMechanicalFeature_var  spGeometryTool, CATBaseUnknown_var ispSelSketchReferPlaneBU, CATIMmiMechanicalFeature_var &ospResult)
{
	HRESULT rc(E_FAIL);
	CATIMmiUseCreateImport* pCreateImport = NULL;
	CATMmiUseServicesFactory::CreateMmiUseCreateImport(pCreateImport);

	pCreateImport->SetObject(ispSelSketchReferPlaneBU);
	pCreateImport->SetTarget(spGeometryTool);//a mechanical part, solid or surfacic feature set 

	CATIMmiMechanicalFeature_var spResult(NULL_var);
	pCreateImport->Run(spResult);
	if (NULL_var == spResult)
	{
		return E_FAIL;
	}
	ospResult = spResult;


	//隐藏几何图形集	
	CATIVisProperties    *    piVisP(NULL);
	rc = spGeometryTool->QueryInterface(IID_CATIVisProperties, (void**)&piVisP);
	if (FAILED(rc) || piVisP == NULL)
	{
		return E_FAIL;
	}

	CATVisPropertiesValues Attribut;
	Attribut.SetShowAttr(CATNoShowAttr);
	rc = piVisP->SetPropertiesAtt(Attribut, CATVPShow, CATVPGlobalType, 0, 0);
	if (FAILED(rc))
	{
		return E_FAIL;
	}
	piVisP->Release();
	piVisP = NULL;
	CATIModelEvents *piME(NULL);
	rc = spGeometryTool->QueryInterface(IID_CATIModelEvents, (void **)&piME);
	if (FAILED(rc) || piME == NULL)
	{
		return E_FAIL;
	}
	CATModifyVisProperties notif(spGeometryTool, CATPathElement(spGeometryTool), CATVPGlobalType, CATVPShow, Attribut);
	piME->Dispatch(notif);

	//Redraw
	CATIRedrawEvent_var pRedraw(NULL_var);
	rc = piME->QueryInterface(IID_CATIRedrawEvent, (void **)&pRedraw);
	if (FAILED(rc) || NULL_var == pRedraw)
	{
		return E_FAIL;
	}
	pRedraw->Redraw();
	piME->Release();
	piME = NULL;


	return S_OK;
}
ExportedByATOZDrawingPubFunc
HRESULT SetSpecLineObjColor(const CATIMmiMechanicalFeature_var &ispFeature, int iColor)
{
	if (NULL_var == ispFeature) return E_FAIL;

	CATIVisProperties *piGraphProp = NULL;
	HRESULT rc = ispFeature->QueryInterface(IID_CATIVisProperties, (void**)&piGraphProp);
	if (FAILED(rc) || piGraphProp == NULL) return rc;

	CATVisPropertiesValues Attribut;
	switch (iColor)
	{
	case 0: {Attribut.SetColor(255, 0, 0); break; }    //红
	case 1: {Attribut.SetColor(0, 255, 0); break; }    //绿
	case 2: {Attribut.SetColor(0, 0, 255); break; }    //蓝
	case 3: {Attribut.SetColor(255, 255, 0); break; }  //黄
	case 4: {Attribut.SetColor(255, 0, 255); break; }   //紫
	case 5: {Attribut.SetColor(0, 255, 255); break; }   //青
	case 6: {Attribut.SetColor(100, 100, 255); break; }//
	case 7: {Attribut.SetColor(0, 0, 0); break; }      //黑
	case 8: {Attribut.SetColor(255, 255, 255); break; }//白
	default: {Attribut.SetColor(255, 255, 0); break; }  //黄
	}

	piGraphProp->SetPropertiesAtt(Attribut, CATVPColor, CATVPLine, 0, 0);
	piGraphProp->Release();
	piGraphProp = NULL;

	CATIModelEvents *piME = NULL;
	rc = ispFeature->QueryInterface(IID_CATIModelEvents, (void **)&piME);
	if (FAILED(rc) || piME == NULL) return rc;
	CATModifyVisProperties notif(ispFeature, CATPathElement(ispFeature), CATVPLine, CATVPColor, Attribut);
	piME->Dispatch(notif);
	piME->Release();
	piME = NULL;

	return rc;
}
ExportedByATOZDrawingPubFunc
HRESULT SetSpecObjShowAttr(const CATIMmiMechanicalFeature_var &ispFeature, CATUnicodeString iShowOrHide)
{
	if (NULL_var == ispFeature) return E_FAIL;

	CATIVisProperties *piVisP = NULL;
	HRESULT rc = ispFeature->QueryInterface(IID_CATIVisProperties, (void**)&piVisP);
	if (FAILED(rc) || piVisP == NULL) return rc;


	CATVisPropertiesValues Attribut;
	if (iShowOrHide == "Show")
	{
		Attribut.SetShowAttr(CATShowAttr);
	}
	else
	{
		Attribut.SetShowAttr(CATNoShowAttr);
	}

	piVisP->SetPropertiesAtt(Attribut, CATVPShow, CATVPGlobalType, 0, 0);
	piVisP->Release();
	piVisP = NULL;

	CATIModelEvents *piME = NULL;
	rc = ispFeature->QueryInterface(IID_CATIModelEvents, (void **)&piME);
	if (FAILED(rc) || piME == NULL) return rc;
	CATModifyVisProperties notif(ispFeature, CATPathElement(ispFeature), CATVPGlobalType, CATVPShow, Attribut);
	piME->Dispatch(notif);
	piME->Release();
	piME = NULL;

	return S_OK;
}
//消息类型：Error、Information、Warning
ExportedByATOZDrawingPubFunc
int DisplayMessage(const CATString &istrMsgType,
	               const CATUnicodeString &iusMsgToDisplay,
	               const CATUnicodeString &iusDlgTitle)
{

	int RetUserReply = 0;

	CATDlgStyle Dlgstyle;
	CATUnicodeString usDlgTitle = "";

	if (istrMsgType == "Error")
	{
		Dlgstyle = CATDlgNfyError | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Error";
	}
	else if (istrMsgType == "Information")
	{
		Dlgstyle = CATDlgNfyInformation | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Information";
	}
	else if (istrMsgType == "Warning")
	{
		Dlgstyle = CATDlgNfyWarning | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Warning";
	}

	if (iusDlgTitle != "")usDlgTitle = iusDlgTitle;

	CATDlgNotify* pDlgNotify = new CATDlgNotify((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(), istrMsgType, Dlgstyle);
	if (!pDlgNotify) return 0;

	RetUserReply = pDlgNotify->DisplayBlocked(iusMsgToDisplay, usDlgTitle); // Get the User selected button
	return RetUserReply;
}

//清空所有高亮
ExportedByATOZDrawingPubFunc
void ClearSO()
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL != pFrmEditor)
	{
		CATHSO* pHSO = pFrmEditor->GetHSO();
		pHSO->Empty();
	}
}
//高亮CATPathElement对象
ExportedByATOZDrawingPubFunc
void HighlightPathElemObj(CATBaseUnknown* pObject)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL != pFrmEditor)
	{
		CATHSO* pHSO = pFrmEditor->GetHSO();
		pHSO->AddElements(pObject);
		pHSO->EndAddElements();
	}
}

ExportedByATOZDrawingPubFunc
HRESULT OpenPLMComponent(const CATUnicodeString &istrPLMType,
	const CATListOfCATString &listAttrName,
	const CATLISTV(CATUnicodeString) &ListAttrValue,
	const IID& iIID,
	void **opiPLMComp,
	CATOmbLifeCycleRootsBag &iBag,
	CATBoolean iExpandAll)
{
	HRESULT hr = S_OK;
	if (CATUnicodeString("") == istrPLMType) return E_FAIL;
	if (0 == listAttrName.Size()) return E_FAIL;
	if (0 == ListAttrValue.Size()) return E_FAIL;

	int iListSize = listAttrName.Size();

	CATListPtrCATAdpQueryResult listQueryResult = NULL;
	hr = GetPLMObjectsFromAttrAndFromType(listAttrName, ListAttrValue, istrPLMType, listQueryResult);
	if (FAILED(hr) || (0 == listQueryResult.Size()))
	{

		cout << "ERROR:ClsPLMUtilities::OpenPLMComponent()-0 == listQueryResult.Size()" << endl;
		return hr;
	}

	CATIAdpPLMIdentificator* piAdpPLMIdentificator = NULL;
	listQueryResult[1]->GetIdentifier(piAdpPLMIdentificator);
	if (NULL == piAdpPLMIdentificator)
	{
		cout << "ERROR:ClsPLMUtilities::OpenPLMComponent()-NULL == piAdpPLMIdentificator" << endl;
		return E_FAIL;
	}

	if (TRUE == iExpandAll)
	{
		CATAdpOpenParameters params_Auth(CATAdpExpandParameters::Authoring);
		CATAdpOpener opener_Auth(iBag, params_Auth);
		// 5.2. Open the Retrieved Component by using CATAdpOpener
		hr = opener_Auth.CompleteAndOpen(piAdpPLMIdentificator, iIID, opiPLMComp);
	}
	else
	{
		CATAdpOpenParameters params_Nav(CATAdpExpandParameters::OneLevelRepresentations);
		CATAdpOpener opener_Nav(iBag, params_Nav);
		hr = opener_Nav.CompleteAndOpen(piAdpPLMIdentificator, iIID, opiPLMComp);
	}
	piAdpPLMIdentificator->Release();
	piAdpPLMIdentificator = NULL;

	return S_OK;
}

ExportedByATOZDrawingPubFunc
HRESULT GetPLMObjectsFromAttrAndFromType(const CATListOfCATString &listOfAttribute,
	const CATListOfCATUnicodeString &listOfValues,
	const CATUnicodeString &iStrPLMType,
	CATListPtrCATAdpQueryResult & opQueryResults)
{
	HRESULT hr = S_OK;
	//cout << "   GetPLMObjectsFromAttrAndFromType " << endl;

	if ((0 == listOfAttribute.Size()) || (0 == listOfValues.Size())) return E_INVALIDARG;
	if (listOfAttribute.Size() != listOfValues.Size()) return E_INVALIDARG;
	if (0 < opQueryResults.Size())return E_INVALIDARG;


	int iListSize = listOfAttribute.Size();

	CATAdpAttributeSet iAttributeSet;
	//cout << "   Build an Attribute set with inputs from user, for query into db" << endl;
	int i = 1;
	while ((i <= iListSize) && (SUCCEEDED(hr)))
	{
		CATUnicodeString Name = listOfAttribute[i].CastToCharPtr();
		const CATString AttributeINPUT = CATCkePLMNavPublicServices::RetrieveBasicAttributeNameFromPreviousOne(NULL_var, Name).CastToCharPtr();
		CATUnicodeString AttrValue = listOfValues[i];

		hr = iAttributeSet.AddAttribute(AttributeINPUT, AttrValue);
		i++;
	}

	CATIType_var spTypeObj = NULL_var;
	hr = RetrievePLMType(iStrPLMType, spTypeObj);
	if (FAILED(hr) || (NULL_var == spTypeObj))
	{
		cout << "ERROR:ClsPLMUtilities::GetPLMObjectsFromAttrAndFromType()-NULL_var == spTypeObj" << endl;
		return E_FAIL;
	}


	hr = CATAdpPLMQueryServices::GetElementsFromAttributes(spTypeObj,
		iAttributeSet,
		opQueryResults);

	return hr;
}

ExportedByATOZDrawingPubFunc
HRESULT RetrievePLMType(const CATUnicodeString & isPLMType,
	CATIType_var & ospType)
{
	HRESULT rc = E_INVALIDARG;
	if (isPLMType != "")
	{
		// For DS type
		rc = CATCkePLMNavPublicServices::RetrieveKnowledgeType(isPLMType, ospType);
		// For Specialization Type
		if (FAILED(rc))  rc = CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType(isPLMType, ospType);
	}
	return rc;
}

ExportedByATOZDrawingPubFunc
HRESULT OpenUniquePLMComponent(const CATUnicodeString &istrPLMType,
	const CATUnicodeString& iPLM_ExternalIDValue,
	const CATUnicodeString& iV_versionValue,
	const IID& iIID,
	void **opiPLMComp,
	CATOmbLifeCycleRootsBag &iBag,
	CATBoolean iExpandAll)
{
	// 1. Initialize the Return Value
	HRESULT hr = E_INVALIDARG;

	// 2. Build The Attribute Set
	CATAdpAttributeSet iAttributeSet;
	CATAdpPLMQueryAttributeSet iAttributeSetForFilter;

	CATUnicodeString V_versionName = CATCkePLMNavPublicServices::GetMajorRevisionAttributeName(NULL_var).CastToCharPtr();

	// CATAdpAttributeSet is formed for the query by GetElementFromAttributes
	hr = iAttributeSet.AddAttribute("PLM_ExternalID", iPLM_ExternalIDValue);
	hr = iAttributeSet.AddAttribute(V_versionName.ConvertToChar(), iV_versionValue);

	hr = iAttributeSetForFilter.AddStringAttribute("PLM_ExternalID", iPLM_ExternalIDValue);
	hr = iAttributeSetForFilter.AddStringAttribute(V_versionName.ConvertToChar(), iV_versionValue);


	// 3. Retrieve the Type by using the input String PLM Type
	CATIType_var spCATITypeOnPLMType;
	CATBoolean bPLMType = FALSE;
	if (SUCCEEDED(hr))
	{
		hr = CATCkePLMNavPublicServices::RetrieveKnowledgeType(istrPLMType, spCATITypeOnPLMType);
		if (NULL_var == spCATITypeOnPLMType)
		{
			hr = CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType(istrPLMType, spCATITypeOnPLMType);
			if (SUCCEEDED(hr) && (NULL_var != spCATITypeOnPLMType))
			{
				bPLMType = TRUE;
				cout << "   Success CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType " << (spCATITypeOnPLMType->Name()).ConvertToChar() << endl;
			}
		}
		else
		{
			bPLMType = TRUE;
			cout << "   Success CATCkePLMNavPublicAccessServices ::RetrieveKnowledgeType non Specializatio type  " << (spCATITypeOnPLMType->Name()).ConvertToChar() << endl;
		}
	}
	if (bPLMType == FALSE)
		cout << "   RetrieveSpecializationType AND RetrieveKnowledgeType are Failed, Invalid PLMType : Identify the Correct PLMType in Modeler" << endl;


	// 4. Retrieve the Element From Database by using the PLM Type and Attribute Set
	CATBoolean bMultipleElementAttrSet = FALSE;
	CATBoolean bUniqueKeyDefOnObject = TRUE;
	CATBoolean bIsUnique = TRUE;
	CATBoolean bUniqueObjectFromKey = TRUE;
	CATBoolean bMultipleElementFromQuery = FALSE;
	CATAdpPLMComponentsInfos oComponentsInfos;

	CATIAdpPLMIdentificator *piIdentOnPLMComp = NULL;

	// 4.1. Create the Filter Consists of PLMType and Attribute Set
	CATAdpPLMQueryFilter iQueryFilter(spCATITypeOnPLMType, iAttributeSetForFilter);

	// 4.2. Retrieve the Element from Database By using Filter , If Multiple elements are retrieved then Query Fails
	if (SUCCEEDED(hr)) hr = CATAdpPLMExtendedQueryServices::GetElementsFromQueryFilter(iQueryFilter, oComponentsInfos);

	if (SUCCEEDED(hr) && oComponentsInfos.Size() != 0)
	{
		if (oComponentsInfos.Size() != 1)
		{
			cout << "\n\t GetElementsFromQueryFilter Returns Multiple Elements. Please Provide Attribute For Identifying the Unique object from Database. Use PLM_EXTERNAL ID + Version" << endl;
			bMultipleElementAttrSet = TRUE;
		}
		// 4.3. Retrieve the Iterator for Attribute Set
		CATAdpPLMComponentsInfosIter iterator = oComponentsInfos.GetIterator();
		CATIAdpPLMIdentificator *oComponent = NULL;
		CATAdpPLMComponentInfos oInfos;
		CATAdpPLMComponentUniqueKey oUniqueKey;
		// 4.4. Retrieve the Attributes from iterator : Identificator of First PLM Object
		hr = iterator.NextInfos(oComponent, oInfos);

		// 4.5. Retrieve the Unique Key for PLM Object from Identificator
		if (SUCCEEDED(hr) && NULL != oComponent)
			hr = CATAdpPLMQueryServices::GetUniqueKey(oComponent, oUniqueKey);

		if (NULL != oComponent)
		{
			oComponent->Release(); oComponent = NULL;
		}

		if (FAILED(hr)) bUniqueKeyDefOnObject = FALSE;

		// 4.6. Display the Value of Unique Key
		CATUnicodeString oDisplayed;
		if (SUCCEEDED(hr))  hr = oUniqueKey.Display(oDisplayed);
		if (S_OK == hr)	 cout << "\n\t Unique Key is :" << oDisplayed.ConvertToChar() << endl;

		// 4.7. Insure the Unicity of Unique Key
		if (SUCCEEDED(hr))  hr = oUniqueKey.UnicityGuarantee();

		if (S_OK == hr)   cout << "\n\t Unicity Guranteed" << endl;
		else
		{
			cout << "\n\t Unicity of Unique Key is not Guranteed" << endl;
			bIsUnique = FALSE;
		}

		if (TRUE == bIsUnique)
		{
			CATListPtrCATIAdpPLMIdentificator oComponentsIdentifiers;
			// 4.8. Retrieve the Elements from Database by using Unique Key
			if (SUCCEEDED(hr))  hr = CATAdpPLMQueryServices::GetElementsByUniqueKey(oUniqueKey, oComponentsIdentifiers);
			// 4.9. If single element is retrieved return it, if mulitple elements are retrieved then Query Fails.
			if (SUCCEEDED(hr) && oComponentsIdentifiers.Size() != 0)  piIdentOnPLMComp = oComponentsIdentifiers[1];
			else if (oComponentsIdentifiers.Size() != 1)
			{
				cout << "\n\t GetElementsByUniqueKey Returns Multiple Elements." << endl;
				bUniqueObjectFromKey = FALSE;
			}
		}

		// 4.10. If unique Key is not implemented on the Object then Retrieve the Object By using GetElementFromAttributes
		CATListPtrCATAdpQueryResult opQueryResults;
		if (bUniqueKeyDefOnObject == FALSE || bIsUnique == FALSE)
		{
			cout << "\n\t Unique Key is not Defined on PLM Object or Unique Key is not Unique Use GetElementFromAttributes" << endl;
			hr = CATAdpPLMQueryServices::GetElementsFromAttributes(spCATITypeOnPLMType, iAttributeSet, opQueryResults);
		}

		// 4.11. If multiple elements areretrieved by above query then Query Fails  Return the identifier for first Object only
		if (SUCCEEDED(hr) && opQueryResults.Size() != 0)
		{
			CATAdpQueryResult *res = opQueryResults[1];
			if (res)
			{
				res->GetIdentifier(piIdentOnPLMComp);
				delete res;
				res = NULL;
			}

			if (opQueryResults.Size() != 1)
			{
				cout << "\n\t\t GetElementFromAttributes Returns Mulitple Elements. Use Attributes which are unique" << endl;
				bMultipleElementFromQuery = TRUE;
			}
		}
	}

	// 5. Open the Element in Session
	if (NULL != piIdentOnPLMComp)
	{
		// 5.1. Create opener dpendening on the input mode
		if (TRUE == iExpandAll)
		{
			CATAdpOpenParameters params_Auth(CATAdpExpandParameters::Authoring);
			CATAdpOpener opener_Auth(iBag, params_Auth);
			// 5.2. Open the Retrieved Component by using CATAdpOpener
			hr = opener_Auth.CompleteAndOpen(piIdentOnPLMComp, iIID, opiPLMComp);
		}
		else
		{
			CATAdpOpenParameters params_Nav(CATAdpExpandParameters::Navigation);
			CATAdpOpener opener_Nav(iBag, params_Nav);
			hr = opener_Nav.CompleteAndOpen(piIdentOnPLMComp, iIID, opiPLMComp);
		}
		piIdentOnPLMComp->Release();
		piIdentOnPLMComp = NULL;
	}


	// 5. Check for the Conditional Variable 
	if (bPLMType == FALSE || bMultipleElementAttrSet == TRUE || bUniqueObjectFromKey == FALSE || bMultipleElementFromQuery == TRUE)
		hr = E_FAIL;

	return hr;
}

ExportedByATOZDrawingPubFunc
HRESULT OpenPLMComponent(const CATUnicodeString &istrPLMType,
	const CATUnicodeString &iPLM_ExternalIDValue,
	const CATUnicodeString &iV_versionValue,
	const IID& iIID,
	void **opiPLMComp,
	CATOmbLifeCycleRootsBag &iBag,
	CATBoolean iExpandAll)
{
	CATLISTV(CATString)        listAttrName;
	CATLISTV(CATUnicodeString) listAttrValue;
	listAttrName.Append("PLM_ExternalID");
	listAttrName.Append("revision");

	listAttrValue.Append(iPLM_ExternalIDValue);
	listAttrValue.Append(iV_versionValue);
	return ::OpenPLMComponent(istrPLMType, listAttrName, listAttrValue, iIID, opiPLMComp, iBag, iExpandAll);
}

ExportedByATOZDrawingPubFunc
HRESULT GetCurrentPart(CATIMmiUsePrtPart_var &ospPrtPart,
	CATIPLMNavOccurrence_var &ospParentOccurr)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATPathElement& CurrentElemPath = pFrmEditor->GetUIActiveObject();
	CATBaseUnknown* pCurrentObject = CurrentElemPath.FindElement(IID_CATIMmiUsePrtPart);
	if (NULL != pCurrentObject)
	{
		ospPrtPart = pCurrentObject;
	}

	CATBaseUnknown* pOccurrObj = CurrentElemPath.FindElement(IID_CATIPLMNavOccurrence);
	if (NULL != pOccurrObj)
	{
		CATIPLMNavOccurrence_var spCurrentOccurr = pOccurrObj;
		if (NULL_var != spCurrentOccurr)
		{
			CATIPLMNavOccurrence* piParentOccurr = NULL;
			spCurrentOccurr->GetFather(piParentOccurr);
			if (NULL != piParentOccurr)
			{
				ospParentOccurr = piParentOccurr;
				piParentOccurr->Release(); piParentOccurr = NULL;
			}
			/*else
				spRootOccurrence = spCurrentOccurr;*/
		}

		//CATIPLMNavOccurrence_var spCurrentOccurr = pOccurrObj;
		//CATIAlias_var spAliasName = spCurrentOccurr;
		//cout << "pCurrentObject == " << spAliasName->GetAlias() << endl;
	}
	return S_OK;
}

ExportedByATOZDrawingPubFunc
HRESULT OpenObjInSession(CATBaseUnknown_var& ispTargetObj)
{
	CATIPLMOpenServices* pOpenService(NULL);
	CATPLMOpenServicesFactory::GetPLMOpenServices(pOpenService);
	if (NULL == pOpenService)
	{
		cout << "CATPLMOpenServicesFactory failed" << endl;
		return E_FAIL;
	}

	CATIPLMComponent* pPLMComponent(NULL);
	if (FAILED(ispTargetObj->QueryInterface(IID_CATIPLMComponent, (void**)&pPLMComponent)))
	{
		cout << " QueryInterface IID_CATIPLMComponent failed" << endl;
		return E_FAIL;
	}
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	pOpenService->PLMOpenInNewWindow(pPLMComponent, pFrmEditor);

	pPLMComponent->Release(); pPLMComponent = NULL;

	return S_OK;
}

ExportedByATOZDrawingPubFunc
HRESULT Get2DWFFactory(CATISktUse2DWFFactory_var &ospCATISktUse2DWFFactory, CATISktUseSketch_var &ospSketch)
{
	HRESULT rc = S_OK;
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATPathElement& CurrentElemPath = pFrmEditor->GetUIActiveObject();
	CATBaseUnknown* pCurrentObject = CurrentElemPath.FindElement(IID_CATISktUse2DWFFactory);
	if (NULL == pCurrentObject)
	{
		DisplayMessage("Error", "请进入草图环境!", "ERROR");
		cout << "pCurrentObject is NULL" << endl;
		return E_FAIL;
	}
	cout << " pCurrentObject IID_CATISktUse2DWFFactory" << endl;

	CATISktUse2DWFFactory* opCATISktUse2DWFFactory(NULL);
	rc = pCurrentObject->QueryInterface(IID_CATISktUse2DWFFactory, (void**)&opCATISktUse2DWFFactory);
	if (FAILED(rc) || (NULL == opCATISktUse2DWFFactory))
		cout << "opCATISktUse2DWFFactory is null" << endl;
	
	CATISktUseSketch* opSketch(NULL);
	rc = opCATISktUse2DWFFactory->QueryInterface(IID_CATISktUseSketch, (void**)&opSketch);
	if (NULL == opSketch || (FAILED(rc)))
	{
		cout << "QueryInterface IID_CATISktUseSketch失败" << endl;
		return E_FAIL;
	}

	ospCATISktUse2DWFFactory = opCATISktUse2DWFFactory;
	ospSketch = opSketch;

	opCATISktUse2DWFFactory->Release();
	opCATISktUse2DWFFactory = NULL;

	opSketch->Release();
	opSketch = NULL;

	return rc;
}

ExportedByATOZDrawingPubFunc
HRESULT GetPartRepRef(const CATIPLMNavReference_var &ispPLMNavRef, CATIPLMNavRepReference_var &ospPrtRepRef)
{
	if (NULL_var == ispPLMNavRef) return E_FAIL;

	HRESULT rc = E_FAIL;
	CATIPLMNavRepInstance* piPLMNavRefIns = NULL;
	CATPLMCoreType TypeRepInstance = PLMCoreRepInstance;
	CATListPtrCATIPLMNavEntity listPLMNavEntity = NULL;

	ispPLMNavRef->ListChildren(listPLMNavEntity, 1, &TypeRepInstance);
	if (listPLMNavEntity.Size() == 0)
	{
		cout << "ERROR:GetPartObject()-listPLMNavEntity.Size() == 0" << endl;
		return E_FAIL;
	}
	else
	{
		CATIPLMNavEntity* piPLMNavEntity = listPLMNavEntity[1];
		if (NULL != piPLMNavEntity)
		{
			rc = piPLMNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void**)&piPLMNavRefIns);
		}
	}
	if (NULL == piPLMNavRefIns)
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRefIns" << endl;
		return E_FAIL;
	}
	CATIPLMNavRepReference* piPLMNavRepRef = NULL;
	rc = piPLMNavRefIns->GetRepReferenceInstanceOf(piPLMNavRepRef);
	piPLMNavRefIns->Release(); piPLMNavRefIns = NULL;
	if (FAILED(rc) || (NULL == piPLMNavRepRef))
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRepRef" << endl;
		return E_FAIL;
	}

	CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
	rc = piPLMNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&piRepLoadMode);
	if (SUCCEEDED(rc) && NULL != piRepLoadMode)
	{
		rc = piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
		piRepLoadMode->Release();
		piRepLoadMode = NULL;
	}
	
	ospPrtRepRef = piPLMNavRepRef;

	piPLMNavRepRef->Release();
	piPLMNavRepRef = NULL;
	return rc;
}

//=============================================================================
// This method retrieves publication from its name 
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT GetPublicationByName(const CATIPrdObject_var ispProduct, const CATUnicodeString iPublicationName, CATBaseUnknown_var &ospPublication)
{
	HRESULT hr = E_FAIL;

	if (NULL_var == ispProduct) return E_FAIL;

	//Retrieve the set of publications
	CATIPrdPublications_var ports(ispProduct);
	if (ports == NULL_var)
	{
		cout << "    Failed to retrieve the product publication collection" << endl;
		return E_FAIL;
	}

	// Retrieve publication
	CATIPrdPublication_var port = NULL_var;
	hr = ports->GetByName(iPublicationName, port);
	ospPublication = port;
	if (FAILED(hr) || NULL_var == ospPublication)
	{
		cout << "    Failed to retrieve the publication" << endl;
		return E_FAIL;
	}

	return S_OK;
}

//=============================================================================
// This method verifies whether the representation is a 3DShape
//=============================================================================
ExportedByATOZDrawingPubFunc
CATBoolean IsA3DShape(CATBaseUnknown_var ispRepresentation)
{
	HRESULT hr = E_FAIL;

	CATIPLMNavEntity_var spPLMNavEntity(ispRepresentation);
	if (spPLMNavEntity == NULL_var) return FALSE;

	CATPLMCoreType lPLMCoreType;
	hr = spPLMNavEntity->GetPLMCoreType(lPLMCoreType);

	CATIPLMNavRepInstance_var spNavRepInstance(ispRepresentation);
	if (spNavRepInstance == NULL_var) return FALSE;

	CATIPLMNavRepReference * piNavRepReference = NULL;
	hr = spNavRepInstance->GetRepReferenceInstanceOf(piNavRepReference);
	if (FAILED(hr) || !piNavRepReference) return FALSE;

	CATIPsiRepresentationReference_var spRepRef(piNavRepReference);
	if (!!piNavRepReference) { piNavRepReference->Release(); piNavRepReference = NULL; }
	if (spRepRef == NULL_var) return FALSE;

	CATUnicodeString usMainDataType = "";
	hr = spRepRef->GetMainDataType(usMainDataType);
	if (FAILED(hr) || usMainDataType != "CATPart") return FALSE;

	CATBoolean lIs3DShape = spRepRef->Is3DGeometry();

	return lIs3DShape;
}

//=============================================================================
// This method finds all 3D Shapes within a product
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT Get3DShapes(CATIPrdObject_var ispProduct, CATFmtListOfPath &oList3DShapes)
{
	HRESULT hr = E_FAIL;

	//Retrieve the product reference
	CATIPrdObject_var spRefProduct = NULL_var;
	CATBaseUnknown * pRef = NULL;
	hr = ispProduct->GetReferenceObject(pRef);
	if (FAILED(hr) || pRef == NULL) return E_FAIL;
	spRefProduct = pRef;
	if (!!pRef) { pRef->Release(); pRef = NULL; }

	//Retrieve the instances of the current product
	CATIPLMRepInstances_var spPLMRepInstances(spRefProduct);
	if (spPLMRepInstances == NULL_var) return E_FAIL;
	CATIPrdIterator * piPrdIterator = NULL;
	hr = spPLMRepInstances->Iterator(piPrdIterator);
	if (FAILED(hr) || piPrdIterator == NULL) return E_FAIL;

	//Loop on the instances to find the 3D Shapes
	CATBaseUnknown_var spRepUnk = NULL_var;
	while (SUCCEEDED(piPrdIterator->Next(spRepUnk)))
	{
		if (!IsA3DShape(spRepUnk)) continue;

		CATFmtPath * pSupport = CATFmtPathFactory::BuildFromObject(spRepUnk);
		oList3DShapes.Append(pSupport);
		if (!!pSupport) pSupport->Release();
	}

	if (!!piPrdIterator) { piPrdIterator->Release(); piPrdIterator = NULL; }

	//search recursively
	CATIPLMProducts_var spPLMProducts(spRefProduct);
	if (spPLMProducts == NULL_var) return S_OK;

	CATIPrdIterator * piPrdChildrenIterator = NULL;
	hr = spPLMProducts->Iterator(piPrdChildrenIterator);
	if (FAILED(hr) || piPrdChildrenIterator == NULL_var) return S_OK;

	CATBaseUnknown * pChildRepUnk = NULL;
	while (SUCCEEDED(piPrdChildrenIterator->Next(pChildRepUnk)) && !!pChildRepUnk)
	{
		CATIPrdObject_var spChild(pChildRepUnk);
		if (spChild == NULL_var) continue;

		pRef = NULL;
		hr = spChild->GetReferenceObject(pRef, IID_CATIPrdObject);
		if (FAILED(hr) || pRef == NULL) continue;

		CATIPrdObject_var spChildRef(pRef);
		if (spChildRef == NULL_var) continue;

		CATFmtListOfPath lSons3DShapes;
		hr = Get3DShapes(spChildRef, lSons3DShapes);
		pRef->Release();

		for (int i = 1; i <= lSons3DShapes.Size(); i++)
		{
			CATFmtPath * pSupport = lSons3DShapes[i];
			if (!pSupport) continue;

			CATFmtPath * pFatherSupport = CATFmtPathFactory::BuildFromObject(spChild);
			hr = pSupport->ConcatenateWith(pFatherSupport);
			if (!!pFatherSupport) { pFatherSupport->Release(); pFatherSupport = NULL; }

			oList3DShapes.Append(pSupport);
		}

		if (!!pChildRepUnk) { pChildRepUnk->Release(); pChildRepUnk = NULL; }
	}

	if (!!piPrdChildrenIterator) { piPrdChildrenIterator->Release(); piPrdChildrenIterator = NULL; }

	return hr;
}

//=============================================================================
// This method return a CATIPLMNavReference of a part by its name
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT GetPartReferenceByName(CATIPLMNavReference *ipNavRef, const CATUnicodeString iPrdInstanceName, CATIPLMNavReference *&oPartReference)
{
	HRESULT hr = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		hr = E_FAIL;
		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			for (int j = 1; j <= nbChildren; j++)
			{
				CATIPrdObject_var spPrd(childrenList[j]);
				if (NULL_var != spPrd && hr != S_OK)
				{
					CATIAlias_var spAlias(spPrd);
					if (NULL_var != spAlias)
					{
						CATUnicodeString usPrdInstanceName = spAlias->GetAlias();
						if (iPrdInstanceName == usPrdInstanceName)
						{
							spPrd->GetReferenceObject((CATBaseUnknown*&)oPartReference, IID_CATIPLMNavReference);
							hr = S_OK;
						}
					}
				}
				CATIPLMNavEntity * pChild = childrenList[j];
				if (NULL != pChild)
				{
					pChild->Release();
					pChild = NULL;
				}
			}
		}
	}
	return hr;
}


//=============================================================================
// This method return a CATIMmiPrtContainer from a CATIPLMNavReference
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT GetAppContainerFromPLMNavRef(CATIPLMNavReference * ipiPLMNavReference, CATIMmiPrtContainer *& opiPartContainer, CATIPrdObject *& opiRepInstanceAsPrdObj)
{
	HRESULT hr = E_FAIL;

	// Input test
	if (!ipiPLMNavReference) return E_FAIL;

	CATListPtrCATIPLMNavEntity childrenList;
	CATPLMCoreType coreType = PLMCoreRepInstance;
	hr = ipiPLMNavReference->ListChildren(childrenList, 1, &coreType);
	if (FAILED(hr)) return E_FAIL;
	CATIPLMNavEntity * pChild = NULL;
	int nbChildren = childrenList.Size();
	for (int idx = 1; idx <= nbChildren; idx++)
	{
		pChild = childrenList[idx];
		if (!pChild) return E_FAIL;
		CATIPLMNavRepInstance * piNavRepInst = NULL;
		hr = pChild->QueryInterface(IID_CATIPLMNavRepInstance, (void **)&piNavRepInst);
		if (SUCCEEDED(hr) && !!piNavRepInst)
		{
			hr = piNavRepInst->QueryInterface(IID_CATIPrdObject, (void**)&opiRepInstanceAsPrdObj);

			CATIPLMNavRepReference * piNavRepRef = NULL;
			hr = piNavRepInst->GetRepReferenceInstanceOf(piNavRepRef);
			if (SUCCEEDED(hr) && !!piNavRepRef)
			{
				piNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void**)&opiPartContainer);
				if (opiPartContainer == NULL) return E_FAIL;

				piNavRepRef->Release();
				piNavRepRef = NULL;
			}
			piNavRepInst->Release();
			piNavRepInst = NULL;
		}

		// Release list item
		if (NULL != pChild)
		{
			pChild->Release();
			pChild = NULL;
		}
	}
	return hr;
}

//=====================================================================================
// This method returns the main body of an product instance. 
// The instance product is identified by its alias and its path will be returned too.
//=====================================================================================
ExportedByATOZDrawingPubFunc
CATBaseUnknown_var GetMainBodyPath(CATIPLMNavReference * ipNavRootRef, const CATUnicodeString iPrdInstanceName, CATIPrdObject *& opiRepInstanceAsPrdObj, CATLISTP(CATIPLMComponent) &oPathOfInstance)
{
	CATBaseUnknown_var spReturn = NULL_var;

	if (NULL != ipNavRootRef)
	{
		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreInstance;
		if (SUCCEEDED(ipNavRootRef->ListChildren(childrenList, 1, &coreType)))
		{
			CATIPLMNavEntity * pChild = NULL;
			int nbChildren = childrenList.Size();
			for (int j = 1; j <= nbChildren; j++)
			{
				pChild = childrenList[j];
				if (!pChild) return NULL_var;
				CATIPrdObject_var spPrd(pChild);
				CATIAlias_var spAlias(spPrd);
				CATUnicodeString usPrdInstanceName = spAlias->GetAlias();
				if (iPrdInstanceName == usPrdInstanceName)
				{
					CATIPLMNavInstance * piPLMNavInst = NULL;
					if (SUCCEEDED(pChild->QueryInterface(IID_CATIPLMNavInstance, (void **)&piPLMNavInst)) && !!piPLMNavInst)
					{
						CATIPLMComponent * piPLMComponent = NULL;
						HRESULT hr = piPLMNavInst->QueryInterface(IID_CATIPLMComponent, (void**)&piPLMComponent);
						oPathOfInstance.Append(piPLMComponent);

						CATIPLMNavReference * piPLMNavRef = NULL;
						if (SUCCEEDED(piPLMNavInst->GetReferenceInstanceOf(piPLMNavRef)) && !!piPLMNavRef)
						{
							CATIMmiPrtContainer * piPartContainer = NULL;
							if (SUCCEEDED(GetAppContainerFromPLMNavRef(piPLMNavRef, piPartContainer, opiRepInstanceAsPrdObj)))
							{
								CATIMmiMechanicalFeature_var spMechFeatOnPart;
								if (SUCCEEDED(piPartContainer->GetMechanicalPart(spMechFeatOnPart)))
								{
									CATBaseUnknown_var spMainBodyUnk;
									CATIPartRequest_var spPartRequest(spMechFeatOnPart);
									spPartRequest->GetMainBody("MfDefault3DView", spReturn);
								}
								if (!!piPartContainer) piPartContainer->Release();
								piPartContainer = NULL;
							}
						}
						if (!!piPLMNavRef) piPLMNavRef->Release();
						piPLMNavRef = NULL;
					}
					if (!!piPLMNavInst) piPLMNavInst->Release();
					piPLMNavInst = NULL;
				}
				if (!!pChild) pChild->Release();
				pChild = NULL;
			}
		}
	}
	return spReturn;
}

//=============================================================================
// This method prints object in context
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT Print_OmbObjectInContext(CATUnicodeString Title, CATOmbObjectInContext * piOmbObjectInContext)
{
	HRESULT hr = S_OK;
	printf("  ----------- %s -------------- \n", Title.ConvertToChar());
	if (piOmbObjectInContext)
	{

		// reading the CATOmbObjectInContext
		CATLISTP(CATIPLMComponent) pathOfInstances;
		if (SUCCEEDED(piOmbObjectInContext->GetPathOfInstances(pathOfInstances)))
		{
			for (int j = 1; j <= pathOfInstances.Size(); j++)
			{
				CATIAlias_var spAlias = pathOfInstances[j];
				if (NULL_var != spAlias)
				{
					CATUnicodeString usAlias = spAlias->GetAlias();
					printf(" pathOfInstances(%d) =%s\n", j, usAlias.ConvertToChar());
				}
				CATIPLMComponent * piPLMComponent = pathOfInstances[j];
				if (piPLMComponent)
				{
					piPLMComponent->Release();
					piPLMComponent = NULL;
				}
			}

		}
		CATIPLMComponent * piRepresentationInstance = NULL;
		if (SUCCEEDED(piOmbObjectInContext->GetInstanceOfRepresentation(piRepresentationInstance)) && piRepresentationInstance)
		{
			CATIAlias_var spAlias = piRepresentationInstance;
			if (NULL_var != spAlias)
			{
				CATUnicodeString usAlias = spAlias->GetAlias();
				printf(" piRepresentationInstance =%s\n", usAlias.ConvertToChar());
			}
			piRepresentationInstance->Release();
			piRepresentationInstance = NULL;
		}

		CATBaseUnknown * piObject = NULL;
		if (SUCCEEDED(piOmbObjectInContext->GetObjectOutOfContext(piObject)) && piObject)
		{
			CATIAlias_var spAlias = piObject;
			if (NULL_var != spAlias)
			{
				CATUnicodeString usAlias = spAlias->GetAlias();
				printf(" Alias =%s\n", usAlias.ConvertToChar());
			}
			piObject->Release();
			piObject = NULL;
		}

		CATIPLMComponent * piContextRootReference = NULL;
		if (SUCCEEDED(piOmbObjectInContext->GetContextRootReference(piContextRootReference)) && piContextRootReference)
		{
			CATIAlias_var spAlias = piContextRootReference;
			if (NULL_var != spAlias)
			{
				CATUnicodeString usAlias = spAlias->GetAlias();
				printf(" piContextRootReference =%s\n", usAlias.ConvertToChar());
			}
			piContextRootReference->Release();
			piContextRootReference = NULL;
		}
	}
	return hr;
}

//=============================================================================
// This method constructs object in context from the publication name
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT GetObjectInContextFromPublicationName(const CATIPrdObject_var ispProduct, const CATUnicodeString iPublicationName, CATISimObjectInContext *&opiObjectInContext)
{
	HRESULT hr = E_FAIL;

	if (NULL_var == ispProduct) return E_FAIL;

	//Retrieve the set of publications
	CATIPrdPublications_var ports(ispProduct);
	if (ports == NULL_var)
	{
		cout << "    Failed to retrieve the product publication collection" << endl;
		return E_FAIL;
	}

	// Retrieve publication
	CATIPrdPublication_var port = NULL_var;
	hr = ports->GetByName(iPublicationName, port);
	if (FAILED(hr) || NULL_var == port)
	{
		cout << "    Failed to retrieve the publication" << endl;
		return E_FAIL;
	}

	//Retrieve the object in context contained by the publication
	CATFmtPath * pPath = CATFmtPathFactory::BuildFromObject(port);
	if (NULL == pPath)
	{
		cout << "   Failed to create the path to the object contained by the publication" << endl;
		return E_FAIL;
	}
	opiObjectInContext = pPath->GetObjectInContext();
	if (!!pPath) { pPath->Release(); pPath = NULL; }

	return S_OK;
}

//=============================================================================
// This method searches for a child product with a given name
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT SearchChildProductByName(CATIPLMProducts * ipPLMProduct, CATUnicodeString & iName, CATPathOfFirstInstances & oPFI)
{
	HRESULT hReturn = E_FAIL;
	HRESULT hr = E_FAIL;
	if (NULL != ipPLMProduct)
	{
		CATIPrdIterator* pListFirstChild = NULL;
		ipPLMProduct->Iterator(pListFirstChild);
		if (NULL != pListFirstChild)
		{
			CATBaseUnknown_var  spChild;
			hr = pListFirstChild->Next(spChild);
			while ((S_OK == hr) && (E_FAIL == hReturn) && (NULL_var != spChild))
			{
				// retrieve reference of the current child
				CATIPrdObject_var   spPrdObjectOnChild = spChild;
				CATIAlias_var spAlias = spChild;
				CATUnicodeString usInstanceName = spAlias->GetAlias();
				if (usInstanceName.SearchSubString(iName) >= 0)
				{
					oPFI.Append(spPrdObjectOnChild);
					hReturn = S_OK;
				}
				if (S_OK != hReturn)
				{
					CATBaseUnknown * pRef = NULL;
					hr = spPrdObjectOnChild->GetReferenceObject(pRef, IID_CATIPLMProducts);
					if (NULL != pRef)
					{
						CATIPLMProducts * pPLMProductsOnRef = NULL;
						if (SUCCEEDED(pRef->QueryInterface(IID_CATIPLMProducts, (void**)&pPLMProductsOnRef)) && pPLMProductsOnRef)
						{
							// recursivity
							CATPathOfFirstInstances newPFI = oPFI;
							newPFI.Append(spPrdObjectOnChild);
							hReturn = SearchChildProductByName(pPLMProductsOnRef, iName, newPFI);
							if (S_OK == hReturn)
							{
								oPFI = newPFI;
							}
							pPLMProductsOnRef->Release();
							pPLMProductsOnRef = NULL;
						}
						pRef->Release();
						pRef = NULL;
					}
					// next child 
					hr = pListFirstChild->Next(spChild);
				}
			}
			pListFirstChild->Release();
			pListFirstChild = NULL;
		}
	}
	return hReturn;
}

//=====================================================================================
// This method loads in session all the sub-products and parts under the root product
//=====================================================================================
ExportedByATOZDrawingPubFunc
HRESULT RecursiveLoad(CATIPLMNavReference *ipNavRef)
{
	HRESULT hr = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			hr = S_OK;
			CATIPLMNavEntity * pChild = NULL;
			for (int j = 1; j <= nbChildren; j++)
			{
				CATBaseUnknown_var spNavEntity = childrenList[j];
				if (NULL_var != spNavEntity)
				{

					CATIPrdObject_var spPrd(childrenList[j]);
					if (NULL_var != spPrd)
					{
						CATIPLMNavReference * oReference = NULL;
						if (SUCCEEDED(spPrd->GetReferenceObject((CATBaseUnknown*&)oReference, IID_CATIPLMNavReference)))
						{
							CATIAlias_var spAlias;
							spAlias = oReference;
							if (NULL_var != spAlias) printf("oReference =%s \n", spAlias->GetAlias().ConvertToChar());

							if (FAILED(LoadRepresentations(oReference)))
							{
								hr = E_FAIL;
							}
							else
							{
								RecursiveLoad(oReference);
							}
							oReference->Release(); oReference = NULL;
						}
					}
				}
				else
					hr = E_FAIL;

				pChild = childrenList[j];
				if (NULL != pChild)
				{
					pChild->Release();
					pChild = NULL;
				}
			}
		}
	}
	return hr;
}

//=============================================================================
// This method loads in session all the representation of a PLM reference 
//=============================================================================
ExportedByATOZDrawingPubFunc
HRESULT LoadRepresentations(CATIPLMNavReference *ipNavRef)
{
	HRESULT rc = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		rc = E_FAIL;

		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreRepInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			HRESULT hr = E_FAIL;
			rc = S_OK;
			for (int j = 1; j <= nbChildren; j++)
			{
				hr = E_FAIL;
				CATIPLMNavEntity * pNavEntity = childrenList[j];
				if (NULL != pNavEntity)
				{
					CATIPLMNavRepInstance * pNavRepInst = NULL;
					if (SUCCEEDED(pNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void **)&pNavRepInst)))
					{
						CATIPLMNavRepReference * pNavRepRef = NULL;
						if (SUCCEEDED(pNavRepInst->GetRepReferenceInstanceOf(pNavRepRef)))
						{
							CATIPsiRepresentationLoadMode * pRepLoadMode = NULL;
							if (SUCCEEDED(pNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&pRepLoadMode)))
							{
								cout << "加载的3DShape 为" << CATIAlias_var(pRepLoadMode)->GetAlias() << endl;
								hr = pRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
								pRepLoadMode->Release();
								pRepLoadMode = NULL;
							}
							pNavRepRef->Release();
							pNavRepRef = NULL;
						}
						pNavRepInst->Release();
						pNavRepInst = NULL;
					}

					pNavEntity->Release();
					pNavEntity = NULL;
				}
				if (FAILED(hr))    rc = hr;
			}
		}
	}

	return rc;
}


ExportedByATOZDrawingPubFunc
HRESULT GetMechanicalPartFromProduct(const CATIPLMNavOccurrence_var &ispOriginOccurrence, CATIMmiMechanicalFeature_var &ospMechanicalPart)
{
	ospMechanicalPart = NULL_var;
	if (!ispOriginOccurrence) return E_INVALIDARG;

	// Get the reference out of the occurrence
	CATIPLMRepInstances_var spReference;
	CATIPLMNavReference* piReference = NULL;
	if (SUCCEEDED(ispOriginOccurrence->GetRelatedReference(piReference)) && piReference)
		spReference = piReference;
	if (piReference) piReference->Release(); piReference = NULL;
	if (!spReference) return E_FAIL;

	// Find all the representations under the current product
	CATIMmiMechanicalFeature_var spMechanicalPart;
	CATIPrdIterator* piIterator = NULL;
	if (SUCCEEDED(spReference->Iterator(piIterator)) && piIterator)
	{
		CATBaseUnknown_var spNext;
		while (!spMechanicalPart && SUCCEEDED(piIterator->Next(spNext)))
		{
			CATIPLMNavRepInstance_var spRepInstance = spNext;
			if (!spRepInstance) continue;

			// Switch each representation references to edit mode
			CATIPLMNavRepReference_var spRepReference;
			CATIPsiRepresentationLoadMode_var spPsiRepresentationLoadMode;
			CATIPLMNavRepReference* piRepReference = NULL;
			if (SUCCEEDED(spRepInstance->GetRepReferenceInstanceOf(piRepReference)) && !!(spPsiRepresentationLoadMode = piRepReference))
				spPsiRepresentationLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
			spRepReference = piRepReference;
			if (piRepReference) piRepReference->Release(); piRepReference = NULL;
			if (!spRepReference) continue;

			CATIMmiPrtContainer* piPrtContainer = NULL;
			if (SUCCEEDED(spRepReference->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void**)&piPrtContainer)))
				piPrtContainer->GetMechanicalPart(spMechanicalPart);
			if (piPrtContainer) piPrtContainer->Release(); piPrtContainer = NULL;
		}
	}
	if (piIterator) piIterator->Release(); piIterator = NULL;

	if (!spMechanicalPart) return E_FAIL;
	ospMechanicalPart = spMechanicalPart;
	return S_OK;
}

ExportedByATOZDrawingPubFunc
HRESULT UpdateAll(const CATIPLMNavOccurrence_var &ispRootProduct)
{
	if (!ispRootProduct) return E_INVALIDARG;

	CATIPLMNavReference_var spRootProductReference;
	CATIPLMNavReference* piRootProductReference = NULL;
	if (SUCCEEDED(ispRootProduct->GetRelatedReference(piRootProductReference)) && piRootProductReference)
		spRootProductReference = piRootProductReference;
	if (piRootProductReference) piRootProductReference->Release(); piRootProductReference = NULL;
	if (!spRootProductReference) return E_FAIL;

	CATBaseUnknown_var spRootActor = spRootProductReference;

	HRESULT updRc = E_FAIL;
	CATIPLMUpdateEngine* piEngine = NULL;
	if (SUCCEEDED(CATPLMUpdateFactory::InstantiateUpdateEngine(piEngine)) && piEngine)
	{
		CATIPLMUpdateEngine::CATPLMUpdateStatus status = CATIPLMUpdateEngine::Status_UndefinedStatus;
		if (SUCCEEDED(piEngine->Init(spRootActor)) && SUCCEEDED(piEngine->GetGlobalPLMStatus(status)))
		{
			switch (status)
			{
			case CATIPLMUpdateEngine::Status_UpToDate:
			case CATIPLMUpdateEngine::Status_UpToDateWithWarnings:
				updRc = S_OK;
				break; // Already up to date.
			case CATIPLMUpdateEngine::Status_OutOfDate:
			case CATIPLMUpdateEngine::Status_OutOfDateDateWithWarnings:
				updRc = piEngine->GlobalPLMUpdate();
				break;
			case CATIPLMUpdateEngine::Status_Error:
			case CATIPLMUpdateEngine::Status_UndefinedStatus:
				updRc = E_FAIL;
				break;
			}
		}
	}
	if (piEngine) piEngine->Release(); piEngine = NULL;

	return updRc;
}

ExportedByATOZDrawingPubFunc
void PrintAllComponentsInSession(CATLISTV(CATIPLMComponent_var) &oList)
{
	CATPLMComponentInterfacesServices::GetPLMComponentsInSession(oList);

	CATIAlias_var spAlias(NULL_var);
	CATIPLMComponent_var currentCom(NULL_var);
	const int SIZE = oList.Size();
	CATUnicodeString adpType("");
	CATIAdpType *piAdpPLMComp = NULL;
	for (int i = 1; i <= SIZE; i++)
	{
		currentCom = oList[i];
		spAlias = currentCom;
		if (spAlias != NULL_var)
		{
			cout << spAlias->GetAlias() << " ";
			oList[i]->GetAdpType(piAdpPLMComp);
			piAdpPLMComp->GetAlias(adpType);
			cout << adpType << endl;
		}

	}

	//只获取根节点
	cout << "\nGetEditedRootPLMComponents\n";
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return;
	CATListPtrCATIPLMComponent oRoots;
	CATPLMComponentInterfacesServices::GetEditedRootPLMComponents(pFrmEditor, oRoots);

	for (int i = 1; i <= oRoots.Size(); i++)
	{
		currentCom = oRoots[i];
		spAlias = currentCom;
		if (spAlias != NULL_var)
		{
			cout << spAlias->GetAlias() << " ";
			oList[i]->GetAdpType(piAdpPLMComp);
			piAdpPLMComp->GetAlias(adpType);
			cout << adpType << endl;

		}

	}
}

ExportedByATOZDrawingPubFunc
bool IsSameComponent(CATBaseUnknown_var &ispInterface1, CATBaseUnknown_var &ispInterface2)
{
	IUnknown *pI1 = NULL;
	IUnknown *pI2 = NULL;

	ispInterface1->QueryInterface(IID_IUnknown, (void**)&pI1);
	ispInterface1->QueryInterface(IID_IUnknown, (void**)&pI2);

	return pI1 == pI2;
}

ExportedByATOZDrawingPubFunc
HRESULT GetContainer(const CATIPLMNavReference_var &ispPLMNavRef, CATIMmiPrtContainer_var &iospCont)
{
	if (NULL_var == ispPLMNavRef) return E_FAIL;

	HRESULT rc = E_FAIL;
	CATIPLMNavRepInstance* piPLMNavRefIns = NULL;
	CATPLMCoreType TypeRepInstance = PLMCoreRepInstance;
	CATListPtrCATIPLMNavEntity listPLMNavEntity = NULL;

	ispPLMNavRef->ListChildren(listPLMNavEntity, 1, &TypeRepInstance);
	if (listPLMNavEntity.Size() == 0)
	{
		cout << "ERROR:GetPartObject()-listPLMNavEntity.Size() == 0" << endl;
		return E_FAIL;
	}
	else
	{
		CATIPLMNavEntity* piPLMNavEntity = listPLMNavEntity[1];
		if (NULL != piPLMNavEntity)
		{
			rc = piPLMNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void**)&piPLMNavRefIns);
		}
	}
	if (NULL == piPLMNavRefIns)
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRefIns" << endl;
		return E_FAIL;
	}
	CATIPLMNavRepReference* piPLMNavRepRef = NULL;
	rc = piPLMNavRefIns->GetRepReferenceInstanceOf(piPLMNavRepRef);
	piPLMNavRefIns->Release(); piPLMNavRefIns = NULL;
	if (FAILED(rc) || (NULL == piPLMNavRepRef))
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRepRef" << endl;
		return E_FAIL;
	}

	CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
	rc = piPLMNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&piRepLoadMode);
	if (SUCCEEDED(rc) && NULL != piRepLoadMode)
	{
		rc = piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
		piRepLoadMode->Release();
		piRepLoadMode = NULL;
	}

	CATIMmiPrtContainer*  piPrtContainer = NULL;
	rc = piPLMNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&piPrtContainer);

	iospCont = piPrtContainer;

	piPrtContainer->Release();
	piPrtContainer = NULL;

	piPLMNavRepRef->Release();
	piPLMNavRepRef = NULL;
	return rc;
}

ExportedByATOZDrawingPubFunc
HRESULT BrowseOccurrences(CATIPLMNavOccurrence_var &spPLMNavOccOnCurrentNode, CATListPtrCATIPLMNavOccurrence &ChildrenList)
{

	if (NULL_var == spPLMNavOccOnCurrentNode)
	{
		return E_INVALIDARG;
	}

	//
	// Now browse the child components
	//
	CATListPtrCATIPLMNavOccurrence ListChildOccurrences;
	HRESULT rc = spPLMNavOccOnCurrentNode->ListChildren(ListChildOccurrences);
	if (SUCCEEDED(rc))
	{
		int i = 1;
		while (SUCCEEDED(rc) && (i <= ListChildOccurrences.Size()))
		{
			CATIPLMNavOccurrence_var spCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL_var != spCurrentChildOccurrence)
			{
				/*if (CATIPipPipeInstance_var(spCurrentChildOccurrence) != NULL_var)
					ChildrenList.Append(spCurrentChildOccurrence);*/
				//附加条件区域
				rc = BrowseOccurrences(spCurrentChildOccurrence, ChildrenList);
			}

			CATIPLMNavOccurrence * pCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL != pCurrentChildOccurrence)
			{
				pCurrentChildOccurrence->Release();
				pCurrentChildOccurrence = NULL;
			}

			i++;
		}
	}

	return rc;
}

ExportedByATOZDrawingPubFunc
HRESULT CreatePartUnderRoot(const CATIPLMNavReference_var &ispParentRef, CATIPLMNavInstance_var &ospNewPartInst, CATOmbLifeCycleRootsBag &ibag)
{
	CATIPrd3DPartReferenceFactory* pIPLM3DPartFactory = NULL;
	CATPrdFactory::CreatePrdFactory(IID_CATIPrd3DPartReferenceFactory, (void **)& pIPLM3DPartFactory);
	if (NULL == pIPLM3DPartFactory) return E_FAIL;

	CATIType_var spRefType;
	CATCkePLMNavPublicServices::RetrieveKnowledgeType("VPMReference", spRefType);

	CATIPLMProducts * pCreated3DPart = NULL;
	CATLISTV(CATICkeParm_var) EmptyAttrListForRef;
	CATLISTV(CATICkeParm_var) EmptyAttrListForRepRef;
	pIPLM3DPartFactory->Create3DPart(NULL, spRefType, EmptyAttrListForRef, EmptyAttrListForRepRef, pCreated3DPart);
	pIPLM3DPartFactory->Release();
	pIPLM3DPartFactory = NULL;

	if (pCreated3DPart == NULL)	return E_FAIL;

	ibag.InsertRoot(pCreated3DPart);

	CATIPLMProducts_var spPrdsRoot = ispParentRef;

	CATBaseUnknown* piUnkNewPart(NULL);
	if (NULL_var != spPrdsRoot)
		spPrdsRoot->AddProduct(pCreated3DPart, piUnkNewPart);

	pCreated3DPart->Release(); pCreated3DPart = NULL;
	if (NULL == piUnkNewPart) return E_FAIL;

	ospNewPartInst = piUnkNewPart;
	piUnkNewPart->Release(); piUnkNewPart = NULL;
	return S_OK;

}

ExportedByATOZDrawingPubFunc
HRESULT CAAMmrGetPartFromProduct(CATIPLMNavInstance_var   spNavInstance, CATIPartRequest_var  & ospPartFromProduct)

{
	HRESULT rc = E_FAIL;

	if (NULL_var == spNavInstance) return E_FAIL;

	// Retrieve the reference of the current instance
	CATIPLMNavReference *pReferenceOfInstance = NULL;
	rc = spNavInstance->GetReferenceInstanceOf(pReferenceOfInstance);

	// Retrieve the first inst rep ref
	CATIPLMNavRepInstance * pNavRepInst = NULL;
	if (NULL != pReferenceOfInstance)
	{
		CATListPtrCATIPLMNavEntity ListNavEntity = NULL;
		CATPLMCoreType TypeRepInstance = PLMCoreRepInstance;
		pReferenceOfInstance->ListChildren(ListNavEntity, 1, &TypeRepInstance);

		if (ListNavEntity.Size() >= 1)
		{
			CATIPLMNavEntity *pCurrent = ListNavEntity[1];
			rc = pCurrent->QueryInterface(IID_CATIPLMNavRepInstance, (void**)& pNavRepInst);
		}
		for (int i = 1; i <= ListNavEntity.Size(); i++)
		{
			CATIPLMNavEntity *pCurrent = ListNavEntity[1];
			if (NULL != pCurrent)
			{
				pCurrent->Release(); pCurrent = NULL;
			}
		}
		pReferenceOfInstance->Release(); pReferenceOfInstance = NULL;
	}

	// Retrieve the reference of the first inst rep ref
	CATIPLMNavRepReference *pNavRepRef = NULL;
	if (NULL != pNavRepInst)
	{
		rc = pNavRepInst->GetRepReferenceInstanceOf(pNavRepRef);
		pNavRepInst->Release(); pNavRepInst = NULL;
	}

	// change the loading mode
	if (NULL != pNavRepRef)
	{
		CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
		rc = pNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&piRepLoadMode);

		if (SUCCEEDED(rc) && NULL != piRepLoadMode)
		{
			rc = piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
			piRepLoadMode->Release();
			piRepLoadMode = NULL;
		}
	}

	//Retrieve the applicative container
	CATIMmiPrtContainer * pContainer = NULL;
	if (SUCCEEDED(rc) && (NULL != pNavRepRef))
	{
		rc = pNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&pContainer);
	}

	if (SUCCEEDED(rc) && (NULL != pContainer))
	{
		CATIMmiMechanicalFeature_var spMechFeatOnPart;
		rc = pContainer->GetMechanicalPart(spMechFeatOnPart);

		if (SUCCEEDED(rc) && (NULL_var != spMechFeatOnPart))
			ospPartFromProduct = spMechFeatOnPart;
	}

	if (NULL != pContainer)
	{
		pContainer->Release();  pContainer = NULL;
	}

	if (NULL != pNavRepRef)
	{
		pNavRepRef->Release(); pNavRepRef = NULL;
	}


	if (NULL_var == ospPartFromProduct)
		return E_FAIL;
	else return S_OK;

}