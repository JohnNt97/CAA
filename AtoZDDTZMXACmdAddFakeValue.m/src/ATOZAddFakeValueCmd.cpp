//===================================================================
// COPYRIGHT atoz 2021/03/18
//===================================================================
// ATOZAddFakeValueCmd.cpp
// Header definition of class ATOZAddFakeValueCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2021/03/18 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ATOZAddFakeValueCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( ATOZAddFakeValueCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
ATOZAddFakeValueCmd::ATOZAddFakeValueCmd() :
CATStateCommand ("ATOZAddFakeValueCmd", CATDlgEngOneShot, CATCommandModeExclusive)
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
, _pATOZAddFakeValueDlg(NULL)
, _spDrawing(NULL_var)
{
	HRESULT rc = InitializeMainDialog();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}

	rc = GetRootDrawing(_spDrawing);
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}
}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
ATOZAddFakeValueCmd::~ATOZAddFakeValueCmd()
{
	if (nullptr != _pATOZAddFakeValueDlg)
	{
		_pATOZAddFakeValueDlg->RequestDelayedDestruction();
		_pATOZAddFakeValueDlg = NULL;
	}
}

HRESULT ATOZAddFakeValueCmd::InitializeMainDialog()
{
	_pATOZAddFakeValueDlg = new ATOZAddFakeValueDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
		"AddFakeValueToolDlg");
	_pATOZAddFakeValueDlg->Build();

	_pATOZAddFakeValueDlg->_Editor->SetLine("修改全部假值");

	_pATOZAddFakeValueDlg->SetVisibility(CATDlgShow);
	return S_OK;
}

//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void ATOZAddFakeValueCmd::BuildGraph()
{
	//click Wndclose buttion
	AddAnalyseNotificationCB(_pATOZAddFakeValueDlg,
		_pATOZAddFakeValueDlg->GetWindCloseNotification(),
		(CATCommandMethod)&ATOZAddFakeValueCmd::ExitCmd, NULL);
	//click cancel button
	AddAnalyseNotificationCB(_pATOZAddFakeValueDlg,
		_pATOZAddFakeValueDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&ATOZAddFakeValueCmd::ExitCmd, NULL);

	//click OK button
	AddAnalyseNotificationCB(_pATOZAddFakeValueDlg,
		_pATOZAddFakeValueDlg->GetDiaOKNotification(),
		(CATCommandMethod)&ATOZAddFakeValueCmd::OKAction, NULL);

}


void ATOZAddFakeValueCmd::OKAction()
{
	if (NULL_var == _spDrawing)
	{
		cout << "未能获取Drawing根节点" << endl;
		return;
	}

	CATLISTV(CATBaseUnknown_var) listSheets;
	GetAllSheets(_spDrawing, listSheets);

	ManageAllDims(listSheets);

	CAAUpdateObject(_spDrawing);

	this->RequestDelayedDestruction();
	return;
}


void ATOZAddFakeValueCmd::ExitCmd()
{
	this->RequestDelayedDestruction();
	return;
}

HRESULT ATOZAddFakeValueCmd::GetRootDrawing(CATIDftDrawing_var &ospDrawing)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATPathElement& CurrentElemPath = pFrmEditor->GetUIActiveObject();
	CATBaseUnknown* pCurrentObject = CurrentElemPath.FindElement(IID_CATIDftDrawing);
	if (NULL != pCurrentObject)
	{
		ospDrawing = pCurrentObject;
	}

	return S_OK;
}

HRESULT ATOZAddFakeValueCmd::CAAUpdateObject(CATBaseUnknown_var spUpdateObjectBU)
{
	if (NULL_var == spUpdateObjectBU)
	{
		cout << "ERROR:CAAUpdateObject() - spUpdateObjectBU is NULL!" << endl;
		return E_FAIL;
	}

	CATIUseEntity *piUseEntity = NULL;
	HRESULT rc = spUpdateObjectBU->QueryInterface(IID_CATIUseEntity, (void**)&piUseEntity);
	if (SUCCEEDED(rc))
	{
		rc = DataCommonProtocolServices::Update(piUseEntity);
		if (FAILED(rc))
		{
			CATError * pError = CATError::CATGetLastError(rc);
			if (NULL != pError)
			{
				cerr << "Error message is " << pError->GetNLSMessage() << endl;
				pError->Release();
				pError = NULL;
			}
		}
		piUseEntity->Release();
		piUseEntity = NULL;
	}

	return rc;
}

HRESULT ATOZAddFakeValueCmd::RetrieveCurrentDftSheet(CATIDftSheet_var &ospDftSheet)
{

	CATIDftDrawing* pDftDrawing = NULL;
	HRESULT rc = GetCurrentDrawing(pDftDrawing);
	if (FAILED(rc) || (NULL == pDftDrawing))
	{
		cout << "ERROR:ClsSetSamePositionViewsFunction::RetrieveCurrentDftSheet()-NULL == pDftDrawing" << endl;
		return E_FAIL;
	}

	CATIDftSheet* piDftSheet = NULL;
	pDftDrawing->GetActiveSheet(&piDftSheet);
	if (NULL == piDftSheet) return E_FAIL;

	ospDftSheet = piDftSheet;

	piDftSheet->Release();
	piDftSheet = NULL;

	pDftDrawing->Release();
	pDftDrawing = NULL;
	return S_OK;
}
//获取当前drawing对象
HRESULT ATOZAddFakeValueCmd::GetCurrentDrawing(CATIDftDrawing * &piDftDrawing)
{
	HRESULT rc(S_OK);

	CATFrmEditor *pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor)
	{
		cout << "Error:CopyComponentFunction::GetCurrentDrawing() - pFrmEditor is NULL!" << endl;
		return E_FAIL;
	}

	CATPathElement ActivePathElement = pFrmEditor->GetUIActiveObject();
	piDftDrawing = (CATIDftDrawing *)ActivePathElement.FindElement(IID_CATIDftDrawing);
	if (NULL == piDftDrawing)
	{
		rc = E_FAIL;
	}
	else
	{
		rc = S_OK;
	}

	return rc;
}

HRESULT ATOZAddFakeValueCmd::GetAllDims()
{
	CATIDftSheet_var spCurrentDftSheet = NULL_var;
	HRESULT rc = RetrieveCurrentDftSheet(spCurrentDftSheet);
	if (FAILED(rc) || (NULL_var == spCurrentDftSheet))
	{
		cout << "ERROR:ProsBatAnnotationsCmd::BatCreateTextAnnotations()-NULL_var == spCurrentDftSheet" << endl;
		return rc;
	}


	CATLISTV(CATBaseUnknown_var) listDftViews = NULL;
	RetrieveOtherViews(spCurrentDftSheet, listDftViews);
	if (0 == listDftViews.Size())
	{
		cout << "ERROR:ProsBatAnnotationsCmd::BatCreateTextAnnotations()-listDftViews.Size() == 0" << endl;
		return rc;
	}

	for (int i = 1; i <= listDftViews.Size(); i++)
	{
		CATIDftView_var spDftView = listDftViews[i];
		if (NULL_var == spDftView) continue;

		CATLISTV(CATBaseUnknown_var) listDim = NULL;
		GetViewAllDimElems(spDftView, listDim);
		cout << "listGenGeo.Size() == " << listDim.Size() << endl;

		int targetVlaue{ 0 };
		for (int DimIndex = 1; DimIndex <= listDim.Size(); DimIndex++)
		{
			CATIDrwDimDimension_var spOnDim = listDim[DimIndex];
			CATIDrwDimValue_var spOnValue = spOnDim->GetValue();
			double currentValue{ spOnValue->GetValue() };
			if (currentValue <= 3.1415926)
				currentValue = currentValue * 57.29578;
			targetVlaue = (int)currentValue;

			CATIDrwDimFakeComponent_var spOnFake = spOnValue->GetFakeComponent();
			if (NULL_var == spOnFake)	return E_FAIL;

			CATUnicodeString fakeValue("");
			fakeValue.BuildFromNum(targetVlaue);

			spOnFake->SetFakeMode(1);
			spOnFake->SetMainFakeValue(fakeValue);
		}
	}
	return S_OK;
}


//获取所有视图，不包括主视图和背景视图
//V6 有自带API 直接获取所有视图对象（不包括主视图和辅助视图
HRESULT ATOZAddFakeValueCmd::RetrieveOtherViews(const CATIDftSheet_var &spDftSheet,
	CATLISTV(CATBaseUnknown_var) &olistOtherViews)
{
	if (NULL_var == spDftSheet) return E_FAIL;

	CATIUnknownList* piListViews = NULL;
	HRESULT rc = spDftSheet->GetViews(&piListViews);
	if (FAILED(rc) || (NULL == piListViews))
	{
		cout << "ERROR:ClsDrawingPubServices::RetrieveOtherViews()-NULL == piListViews" << endl;
		return rc;
	}

	unsigned int iViewCount = 0;
	piListViews->Count(&iViewCount);
	for (int i = 0; i < iViewCount; i++)
	{
		IUnknown* piUnknown = NULL;
		piListViews->Item(i, &piUnknown);
		if (NULL == piUnknown) continue;

		CATIDftView* piCurrentView = NULL;
		rc = piUnknown->QueryInterface(IID_CATIDftView, (void**)&piCurrentView);
		if (FAILED(rc) || (NULL == piCurrentView)) continue;

		CATIDftView_var spCurrentDftView = piCurrentView;

		piCurrentView->Release(); piCurrentView = NULL;
		piUnknown->Release(); piUnknown = NULL;

		olistOtherViews.Append(spCurrentDftView);
	}
	return S_OK;
}

HRESULT ATOZAddFakeValueCmd::GetViewAllDimElems(const CATIDftView_var &ispDftView,
	CATLISTV(CATBaseUnknown_var) &olistDimElems)
{
	if (NULL_var == ispDftView) return E_FAIL;

	CATIUnknownList *piDimList = NULL;
	HRESULT rc = ispDftView->GetComponents(IID_CATIDrwDimDimension, &piDimList); //获取成功
	if (NULL == piDimList)
	{
		cout << "未能获取IID_CATIDrwDimDimension" << endl;
		return E_FAIL;
	}

	unsigned int GeoSize = 0;
	piDimList->Count(&GeoSize);
	for (int i = 0; i < GeoSize; i++)
	{
		IUnknown * DimItem = NULL;
		piDimList->Item(i, &DimItem);
		if (NULL == DimItem) continue;

		CATIDrwDimDimension* piOnDim = NULL;
		rc = DimItem->QueryInterface(IID_CATIDrwDimDimension, (void**)&piOnDim);
		DimItem->Release(); DimItem = NULL;
		if (FAILED(rc) || (NULL == piOnDim)) continue;

		CATIDrwDimDimension_var spOnDim = piOnDim;
		piOnDim->Release(); piOnDim = NULL;
		olistDimElems.Append(spOnDim);
	}
	piDimList->Release(); piDimList = NULL;
	return S_OK;
}

HRESULT ATOZAddFakeValueCmd::GetAllSheets(const CATIDftDrawing_var &ispDftDrawing,
	CATLISTV(CATBaseUnknown_var) &olistSheets)
{
	if (NULL_var == ispDftDrawing) return E_FAIL;

	CATIUnknownList* pUnknownList = NULL;
	HRESULT rc = ispDftDrawing->GetSheets(&pUnknownList);
	if (NULL == pUnknownList) return E_FAIL;

	unsigned int iSheetCounts(0);
	pUnknownList->Count(&iSheetCounts);
	for (int i = 0; i < iSheetCounts; i++)
	{
		IUnknown* pSheetUnknown = NULL;
		pUnknownList->Item(i, &pSheetUnknown);
		if (NULL == pSheetUnknown) continue;

		CATIDftSheet* piDftSheet = NULL;
		rc = pSheetUnknown->QueryInterface(IID_CATIDftSheet, (void**)&piDftSheet);
		if (SUCCEEDED(rc) && (NULL != piDftSheet))
		{
			CATIDftSheet_var spOnSheet = piDftSheet;
			piDftSheet->Release(); piDftSheet = NULL;
			olistSheets.Append(spOnSheet);
		}
		pSheetUnknown->Release(); pSheetUnknown = NULL;
	}
	pUnknownList->Release(); pUnknownList = NULL;
	cout << "图纸个数为:" << olistSheets.Size() << endl;
	return S_OK;
}

HRESULT ATOZAddFakeValueCmd::ManageAllDims(CATLISTV(CATBaseUnknown_var) &ilistDimElems)
{
	CATIDftSheet_var spCurrentDftSheet = NULL_var;
	HRESULT rc = S_OK;

	for (int i = 1; i <= ilistDimElems.Size(); i++)
	{
		spCurrentDftSheet = ilistDimElems[i];
		CATLISTV(CATBaseUnknown_var) listDftViews = NULL;
		RetrieveOtherViews(spCurrentDftSheet, listDftViews);
		if (0 == listDftViews.Size())
		{
			cout << "ERROR:ProsBatAnnotationsCmd::BatCreateTextAnnotations()-listDftViews.Size() == 0" << endl;
			return rc;
		}

		for (int i = 1; i <= listDftViews.Size(); i++)
		{
			CATIDftView_var spDftView = listDftViews[i];
			if (NULL_var == spDftView) continue;

			CATLISTV(CATBaseUnknown_var) listDim = NULL;
			GetViewAllDimElems(spDftView, listDim);
			cout << "listGenGeo.Size() == " << listDim.Size() << endl;

			int targetVlaue{ 0 };
			for (int DimIndex = 1; DimIndex <= listDim.Size(); DimIndex++)
			{
				CATIDrwDimDimension_var spOnDim = listDim[DimIndex];
				CATIDrwDimValue_var spOnValue = spOnDim->GetValue();
				double currentValue{ spOnValue->GetValue() };

				if (currentValue <= 3.1415926)
					//currentValue = currentValue * 57.29578;
					continue;

				targetVlaue = (int)currentValue;

				CATIDrwDimFakeComponent_var spOnFake = spOnValue->GetFakeComponent();
				if (NULL_var == spOnFake)	return E_FAIL;

				CATUnicodeString fakeValue("");
				fakeValue.BuildFromNum(targetVlaue);

				spOnFake->SetFakeMode(1);
				spOnFake->SetMainFakeValue(fakeValue);

				CATIDrwTextProperties_var spProperties = spOnDim;
				if (NULL_var != spProperties)
					spProperties->Refresh();
				else
					cout << "CATIDrwTextProperties_var获取失败" << endl;

			}


		}
	}
	return S_OK;
}