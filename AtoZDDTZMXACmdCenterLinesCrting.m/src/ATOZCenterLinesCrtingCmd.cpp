//===================================================================
// COPYRIGHT atoz 2021/03/12
//===================================================================
// ATOZCenterLinesCrtingCmd.cpp
// Header definition of class ATOZCenterLinesCrtingCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2021/03/12 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ATOZCenterLinesCrtingCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( ATOZCenterLinesCrtingCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
ATOZCenterLinesCrtingCmd::ATOZCenterLinesCrtingCmd() :
CATStateCommand ("ATOZCenterLinesCrtingCmd", CATDlgEngOneShot, CATCommandModeShared)
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
, _pATOZCenterLinesCrtingDlg(NULL)
, _pSelProdPathElemAgent(NULL)
, _pSelPipeObjDlgAgent(NULL)
, _spRootNavRef(NULL_var)
, _bag()
{
	HRESULT rc = InitializeMainDialog();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}

	::RetrieveRootProd(_spRootNavRef);
}

HRESULT ATOZCenterLinesCrtingCmd::InitializeMainDialog()
{
	_pATOZCenterLinesCrtingDlg = new ATOZCenterLinesCrtingDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
		"ATOZCenterLinesCrtingDlg");

	_pATOZCenterLinesCrtingDlg->Build();

	_pATOZCenterLinesCrtingDlg->_SelectorListPipeProd->SetLine("No Selection");

	int ArraySel[1] = { 0 };
	_pATOZCenterLinesCrtingDlg->_SelectorListPipeProd->SetSelect(ArraySel, 1);

	_pATOZCenterLinesCrtingDlg->SetVisibility(CATDlgShow);
	return S_OK;

	//一定考虑内存清理 跳转时可能会强制关闭命令
}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
ATOZCenterLinesCrtingCmd::~ATOZCenterLinesCrtingCmd()
{
	_bag.RemoveAll();

	if (NULL != _pSelPipeObjDlgAgent)
	{
		_pSelPipeObjDlgAgent->RequestDelayedDestruction();
		_pSelPipeObjDlgAgent = NULL;
	}

	if (NULL != _pSelProdPathElemAgent)
	{
		_pSelProdPathElemAgent->RequestDelayedDestruction();
		_pSelProdPathElemAgent = NULL;
	}

	if (NULL != _pATOZCenterLinesCrtingDlg)
	{
		_pATOZCenterLinesCrtingDlg->RequestDelayedDestruction();
		_pATOZCenterLinesCrtingDlg = NULL;
	}
}


//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void ATOZCenterLinesCrtingCmd::BuildGraph()
{
	_pSelProdPathElemAgent = new CATPathElementAgent("SelectProd");
	_pSelProdPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot);
	_pSelProdPathElemAgent->AddElementType(IID_CATIPLMRepInstances);

	_pSelPipeObjDlgAgent = new CATDialogAgent("SelPipeDlgAgent");
	_pSelPipeObjDlgAgent->AcceptOnNotify(_pATOZCenterLinesCrtingDlg->_SelectorListPipeProd,
		_pATOZCenterLinesCrtingDlg->_SelectorListPipeProd->GetListSelectNotification());

	CATDialogState * SelectPipeObjState = GetInitialState("SelectPipeObjState");
	SelectPipeObjState->AddDialogAgent(_pSelProdPathElemAgent);

	AddTransition(SelectPipeObjState, SelectPipeObjState,
		IsOutputSetCondition(_pSelProdPathElemAgent),
		Action((ActionMethod)&ATOZCenterLinesCrtingCmd::SelectPipeObj));


	//click OK button
	AddAnalyseNotificationCB(_pATOZCenterLinesCrtingDlg,
		_pATOZCenterLinesCrtingDlg->GetDiaOKNotification(),
		(CATCommandMethod)&ATOZCenterLinesCrtingCmd::OKAction, NULL);

	//click Wndclose buttion
	AddAnalyseNotificationCB(_pATOZCenterLinesCrtingDlg,
		_pATOZCenterLinesCrtingDlg->GetWindCloseNotification(),
		(CATCommandMethod)&ATOZCenterLinesCrtingCmd::ExitCmd, NULL);

	//click cancel button
	AddAnalyseNotificationCB(_pATOZCenterLinesCrtingDlg,
		_pATOZCenterLinesCrtingDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&ATOZCenterLinesCrtingCmd::ExitCmd, NULL);


}


void ATOZCenterLinesCrtingCmd::ExitCmd()
{
	this->RequestDelayedDestruction();
	return;
}


void ATOZCenterLinesCrtingCmd::SelectPipeObj()
{
	CATPathElement* pPathElem = _pSelProdPathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = pPathElem->GetCurrentObject();
	_pSelProdPathElemAgent->InitializeAcquisition();

	ClearSO();
	HighlightPathElemObj(pPathElem);

	_spPipeProd = pBaseUnknown;
	if (NULL_var == _spPipeProd)
	{
		::DisplayMessage("Error", "未获取装配体!", "ERROR");
		return;
	}

	CATIPLMNavReference *piProdRef(NULL);
	_spPipeProd->GetRelatedReference(piProdRef);
	if (NULL != piProdRef) {
		_spPipeProdRef = piProdRef;
		piProdRef->Release(); piProdRef = NULL;
	}

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZCenterLinesCrtingDlg->_SelectorListPipeProd;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}


}

void ATOZCenterLinesCrtingCmd::OKAction()
{
	//在根节点下创建part
	CATIPLMNavInstance_var spNewPartInst(NULL_var);
	ATOZCenterLinesCrtingCmd::CreatePartUnderRoot(_spRootNavRef, spNewPartInst, _bag); //在公共函数中保存了另一个版本


	//获取所有管道实例
	CATListPtrCATIPLMNavOccurrence PipeOccurrenceList;
	CATIPLMNavOccurrence_var spRootOccur(NULL_var);

	CATIPrdOccurrenceMngt* occMngt = NULL;
	if (SUCCEEDED(CATPrdGetOccurrenceMngt(occMngt)) && occMngt)
	{
		HRESULT ret = occMngt->GetOrCreateRootOccurrence(_spRootNavRef, spRootOccur);
		occMngt->Release();
		occMngt = NULL;
	}

	BrowseOccurrences(spRootOccur, PipeOccurrenceList);

	//获取所有引导点的绝对坐标
	GetAllAbsPts(PipeOccurrenceList, _vecpointsAbs);

	//获取容器与part feature
	CATIPLMNavReference *piNewPartRef(NULL);
	spNewPartInst->GetReferenceInstanceOf(piNewPartRef);

	CATIMmiPrtContainer_var spContainer(NULL_var); //容器
	CATIMmiUsePrtPart_var spPrtPart(NULL_var);	//part特征
	GetContainerAndMechPart(piNewPartRef, spContainer, spPrtPart);
	piNewPartRef->Release(); piNewPartRef = NULL;


	//创建几何图形集
	CATIMmiMechanicalFeature_var spGsmTool(NULL_var); //几何图形集
	CAAGsiCreateGeometricFeatureSets(spPrtPart,"管道中心线", spGsmTool);
	spPrtPart->SetInWorkObject(spGsmTool);


	//创建点
	CATIGSMUseFactory_var spGSMFactory = spContainer;
	CreateCenterLines(spGSMFactory, _vecpointsAbs, spGsmTool);

	this->RequestDelayedDestruction();
	return;
}

HRESULT ATOZCenterLinesCrtingCmd::CreatePartUnderRoot(const CATIPLMNavReference_var &ispParentRef, CATIPLMNavInstance_var &ospNewPartInst, CATOmbLifeCycleRootsBag &ibag)
{
	CATIPrd3DPartReferenceFactory* pIPLM3DPartFactory = NULL;
	CATPrdFactory::CreatePrdFactory(IID_CATIPrd3DPartReferenceFactory, (void **)& pIPLM3DPartFactory);
	if (NULL == pIPLM3DPartFactory) return E_FAIL;

	CATIType_var spRefType;
	CATCkePLMNavPublicServices::RetrieveKnowledgeType("VPMReference", spRefType);

	CATIPLMProducts * pCreated3DPart = NULL;
	CATLISTV(CATICkeParm_var) EmptyAttrListForRef;
	CATLISTV(CATICkeParm_var) EmptyAttrListForRepRef;
	pIPLM3DPartFactory->Create3DPart(NULL, spRefType, EmptyAttrListForRef, EmptyAttrListForRepRef, pCreated3DPart);
	pIPLM3DPartFactory->Release();
	pIPLM3DPartFactory = NULL;

	if (pCreated3DPart == NULL)	return E_FAIL;

	ibag.InsertRoot(pCreated3DPart);

	CATIPLMProducts_var spPrdsRoot = ispParentRef;

	CATBaseUnknown* piUnkNewPart(NULL);
	if (NULL_var != spPrdsRoot) 
		spPrdsRoot->AddProduct(pCreated3DPart, piUnkNewPart);
		
	pCreated3DPart->Release(); pCreated3DPart = NULL;
	if (NULL == piUnkNewPart) return E_FAIL;
	
	ospNewPartInst = piUnkNewPart;
	piUnkNewPart->Release(); piUnkNewPart = NULL;
	return S_OK;
	
}

HRESULT ATOZCenterLinesCrtingCmd::BrowseOccurrences(CATIPLMNavOccurrence_var &spPLMNavOccOnCurrentNode, CATListPtrCATIPLMNavOccurrence &ChildrenList)
{
	if (NULL_var == spPLMNavOccOnCurrentNode)
		return E_INVALIDARG;
	//
	// Now browse the child components
	//
	CATListPtrCATIPLMNavOccurrence ListChildOccurrences;
	HRESULT rc = spPLMNavOccOnCurrentNode->ListChildren(ListChildOccurrences);
	if (SUCCEEDED(rc))
	{
		int i = 1;
		while (SUCCEEDED(rc) && (i <= ListChildOccurrences.Size()))
		{
			CATIPLMNavOccurrence_var spCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL_var != spCurrentChildOccurrence)
			{
				//根据类型来保存
				if (CATIPipPipeInstance_var(spCurrentChildOccurrence) != NULL_var)
					ChildrenList.Append(spCurrentChildOccurrence);
				rc = BrowseOccurrences(spCurrentChildOccurrence, ChildrenList);
			}

			CATIPLMNavOccurrence * pCurrentChildOccurrence = ListChildOccurrences[i];

			if (NULL != pCurrentChildOccurrence) {
				pCurrentChildOccurrence->Release();
				pCurrentChildOccurrence = NULL;
			}

			i++;
		}
	}
	return rc;
}

HRESULT ATOZCenterLinesCrtingCmd::GetAllAbsPts(CATListPtrCATIPLMNavOccurrence &iPipeOccurrenceList, vector<CATLISTV(CATMathPoint)> &ivecpointsAbs)
{
	CATIPLMNavOccurrence_var spCurPipeOccur(NULL_var);
	CATIPipPipeInstance_var spCurPipeInst(NULL_var);
	const int SizeOfPipes = iPipeOccurrenceList.Size();
	for (int i = 1; i <= SizeOfPipes; i++)
	{
		CATLISTV(CATMathPoint) ipointsAbs; //单个零件的点

		spCurPipeOccur = iPipeOccurrenceList[i];

		//获取当前管道的绝对矩阵
		CATMathTransformation AbsTransMatric;
		CATIMovable_var spMovable(NULL_var);
		spMovable = spCurPipeOccur;
		if (NULL_var != spMovable) {
			if (SUCCEEDED(spMovable->GetAbsPosition(AbsTransMatric))) {
				cout << "GetAbsPosition excuted" << endl;
				AbsTransMatric.Dump();
			}
			else
				cout << "GetAbsPosition failed" << endl;
		}

		//获取当前管道的引导点
		spCurPipeInst = spCurPipeOccur;
		//CATLISTV(CATIMmiMechanicalFeature_var) listOfGuidePts;
		CATLISTP(CATMathPoint) ListPofCoordinateNode;

		CATBaseUnknown *pIUnkPipeRef = NULL;
		spCurPipeInst->GetReference(pIUnkPipeRef);
		if (NULL != pIUnkPipeRef) {
			CATIPipRigidPipeReference_var spPipRigidRef;
			spPipRigidRef = pIUnkPipeRef;
			if (NULL_var != spPipRigidRef)
				spPipRigidRef->GetCoordinateofNode(ListPofCoordinateNode);

			pIUnkPipeRef->Release(); pIUnkPipeRef = NULL;
		}

		//转换为绝对坐标后存储
		const int SizeOfPts = ListPofCoordinateNode.Size();
		for (int i = 1; i <= SizeOfPts; i++)
		{
			CATMathPoint relativePt;

			relativePt = (*ListPofCoordinateNode[i]);

			CATMathPoint AbsPt = AbsTransMatric*relativePt;
			ipointsAbs.Append(AbsPt);
			
		}

		ivecpointsAbs.push_back(ipointsAbs);
	}

	return S_OK;

}

HRESULT ATOZCenterLinesCrtingCmd::GetContainerAndMechPart(const CATIPLMNavReference_var &ispPLMNavRef, CATIMmiPrtContainer_var &ospContainer, CATIMmiUsePrtPart_var &ospPrtPart)
{
	if (NULL_var == ispPLMNavRef) return E_FAIL;

	HRESULT rc = E_FAIL;
	CATIPLMNavRepInstance* piPLMNavRefIns = NULL;
	CATPLMCoreType TypeRepInstance = PLMCoreRepInstance;
	CATListPtrCATIPLMNavEntity listPLMNavEntity = NULL;

	ispPLMNavRef->ListChildren(listPLMNavEntity, 1, &TypeRepInstance);
	if (listPLMNavEntity.Size() == 0)
	{
		cout << "ERROR:GetPartObject()-listPLMNavEntity.Size() == 0" << endl;
		return E_FAIL;
	}
	else
	{
		CATIPLMNavEntity* piPLMNavEntity = listPLMNavEntity[1];
		if (NULL != piPLMNavEntity)
		{
			rc = piPLMNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void**)&piPLMNavRefIns);
		}
	}
	if (NULL == piPLMNavRefIns)
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRefIns" << endl;
		return E_FAIL;
	}
	CATIPLMNavRepReference* piPLMNavRepRef = NULL;
	rc = piPLMNavRefIns->GetRepReferenceInstanceOf(piPLMNavRepRef);
	piPLMNavRefIns->Release(); piPLMNavRefIns = NULL;
	if (FAILED(rc) || (NULL == piPLMNavRepRef))
	{
		cout << "ERROR:GetPartObject()-NULL == piPLMNavRepRef" << endl;
		return E_FAIL;
	}

	CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
	rc = piPLMNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&piRepLoadMode);
	if (SUCCEEDED(rc) && NULL != piRepLoadMode)
	{
		rc = piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
		piRepLoadMode->Release();
		piRepLoadMode = NULL;
	}

	CATIMmiPrtContainer * piPrtContainer = NULL;
	rc = piPLMNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&piPrtContainer);
	if (SUCCEEDED(rc) && (NULL != piPrtContainer))
	{
		CATIMmiMechanicalFeature_var spMechFeature = NULL_var;
		piPrtContainer->GetMechanicalPart(spMechFeature);
		ospContainer = piPrtContainer;
		piPrtContainer->Release();
		piPrtContainer = NULL;

		ospPrtPart = spMechFeature;
	}

	piPLMNavRepRef->Release();
	piPLMNavRepRef = NULL;
	return rc;
}

HRESULT ATOZCenterLinesCrtingCmd::CreateCenterLines(CATIGSMUseFactory_var &ispGSMFactory, vector<CATLISTV(CATMathPoint)> &ivecpointsAbs, CATIMmiMechanicalFeature_var &ispGsmTool)
{
	const size_t CountOfPipes = ivecpointsAbs.size();

	for (int i = 0; i < CountOfPipes; i++)
	{
		CATLISTV(CATMathPoint) curListPts = ivecpointsAbs[i];

		const int CountOfPts = curListPts.Size();
		for (int i = 1; i < CountOfPts; i++)
		{
			double firstPt[3]{};
			curListPts[i].GetCoord(firstPt);

			double secondPt[3]{};
			curListPts[i + 1].GetCoord(secondPt);

			CATIGSMUseLinePtPt_var spOnLine = ispGSMFactory->CreateLine(ispGSMFactory->CreatePoint(firstPt), ispGSMFactory->CreatePoint(secondPt));

			CATIGSMUseProceduralView_var ispProcView = spOnLine;
			if (NULL_var != ispProcView)
			{
				HRESULT rc = ispProcView->InsertInProceduralView(ispGsmTool);
				if (FAILED(rc))
				{
					cout << "\nERROR Problem append the feature in the part body set!!" << endl;
					return  E_FAIL;
				}

				CATIUseEntity_var hUseEnt(spOnLine);
				if (!!hUseEnt)
				{
					// update the extrude surface feature
					// ------------------------------------
					rc = DataCommonProtocolServices::Update(hUseEnt);
					if (FAILED(rc))
					{
						cout << "\nERROR Problem to update the extrude surface feature : DataCommonProtocolServices::Update KO!" << endl;
						return  E_FAIL;
					}
					cout << "\tUpdate the extrude surface feature : OK" << endl;

					CATIVisProperties_var spLineProp = spOnLine;
					if (NULL_var != spLineProp)
					{
						CATVisPropertiesValues iValues;
						iValues.SetLineType(4);
						iValues.SetColor(0, 255, 0);
						//CATVisPropertyType iPropertyType = CATVPLineType;
						//CATVisGeomType  iGeomType = CATVPGlobalType;
						//如果无效就只改变颜色

						rc = spLineProp->SetPropertiesAtt(iValues, CATVPAllPropertyType, CATVPLine);
					}
				}
			}
		}
	}

	return S_OK;
}