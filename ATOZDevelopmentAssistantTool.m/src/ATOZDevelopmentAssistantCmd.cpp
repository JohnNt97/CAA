//===================================================================
// COPYRIGHT atoz 2020/12/15
//===================================================================
// ATOZDevelopmentAssistantCmd.cpp
// Header definition of class ATOZDevelopmentAssistantCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2020/12/15 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ATOZDevelopmentAssistantCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( ATOZDevelopmentAssistantCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
ATOZDevelopmentAssistantCmd::ATOZDevelopmentAssistantCmd() :
CATStateCommand ("ATOZDevelopmentAssistantCmd", CATDlgEngOneShot, CATCommandModeExclusive)
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
, _testMode(true)
, _pATOZDevelopmentAssistantDlg(NULL)
, _pSelObjPathElemAgent(NULL)
, _pSelTestObjPathElemAgent(NULL)
, _pSelTestObjPathElemAgent2(NULL)
, _pSelObjDlgAgent(NULL)
, _pSelTestObjDlgAgent(NULL)
, _pMultiSelTestObjDlgAgent(NULL)
, _spBU(NULL_var)
, _spBUTest(NULL_var)
, _pCurrentObj(NULL)
, _spCurrentPart(NULL_var)
, _spRootNavRef(NULL_var)
, _ModelBag()
, _pSObj(NULL)
, _pMultiSelPathElemAgent(NULL)
, _spBUTest2(NULL_var)
, _spPrdOccurr(NULL_var)
, _spDrawing(NULL_var)
, _created(false)
{
	HRESULT rc = InitializeMainDialog();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}

	RetrieveRootProd(_spRootNavRef);
	CATIPrdOccurrenceMngt* piOccurrMngt = NULL;
	if (SUCCEEDED(CATPrdGetOccurrenceMngt(piOccurrMngt)) && piOccurrMngt)
		piOccurrMngt->GetOrCreateRootOccurrence(_spRootNavRef, _spPrdOccurr);
	if (NULL_var == _spPrdOccurr)
		cout << "didnt get _spPrdOccurr" << endl;

	


	//::GetPartObject(_spRootNavRef, _spCurrentPart);

	CATIDftDrawing* pDftDrawing = NULL;
	rc = ClsDrawingPubServices::GetCurrentDrawing(pDftDrawing);
	_spDrawing = pDftDrawing;
	if (NULL != pDftDrawing) {
		pDftDrawing->Release();
		pDftDrawing = NULL;
	}
	
	

	/*CATListOfCATString iListAttributeName;
	CATListOfCATUnicodeString iListAttributeValue;

	iListAttributeName.Append("PLM_ExternalID");
	iListAttributeValue.Append("CXMS-Piping-工艺库");

	const char * iStrPLMType = "ENOCLG_LibraryReference";
	CATIAdpPLMIdentificator* opiIDComp = NULL;

	CAARetrieveIDofUniquePLMObject(iListAttributeName, iListAttributeValue,
		iStrPLMType, opiIDComp);

	if (NULL != opiIDComp)
		cout << "获取成功" << endl;*/
	//DisplayTemplateView();


}

HRESULT ATOZDevelopmentAssistantCmd::GetViewAllDimElems(const CATIDftView_var &ispDftView)
{
	if (NULL_var == ispDftView) return E_FAIL;

	CATIUnknownList *piDimList = NULL;
	HRESULT rc = ispDftView->GetComponents(IID_CATIDftDimensionReference, &piDimList); //获取成功
	if (NULL == piDimList)
	{
		cout << "未能获取IID_CATIDrwDimDimension" << endl;
		return E_FAIL;
	}

	unsigned int GeoSize = 0;
	piDimList->Count(&GeoSize);
	for (int i = 0; i < GeoSize; i++)
	{
		IUnknown * DimItem = NULL;
		piDimList->Item(i, &DimItem);
		if (NULL == DimItem) continue;

		CATIDftDimensionReference* piOnDim = NULL;
		rc = DimItem->QueryInterface(IID_CATIDftDimensionReference, (void**)&piOnDim);
		DimItem->Release(); DimItem = NULL;
		if (FAILED(rc) || (NULL == piOnDim)) continue;

		CATIDftDimensionReference_var spOnDim = piOnDim;

		CATMathPoint2D indication = spOnDim->GetSelectionPoint();
		cout << "获取的定位点坐标为：" << endl;
		cout << indication.GetX() << " " << indication.GetY() << endl;

		piOnDim->Release(); piOnDim = NULL;
		//olistDimElems.Append(spOnDim);
	}
	piDimList->Release(); piDimList = NULL;
	return S_OK;
}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
ATOZDevelopmentAssistantCmd::~ATOZDevelopmentAssistantCmd()
{

	if (NULL != _pMultiSelPathElemAgent)
	{
		_pMultiSelPathElemAgent->RequestDelayedDestruction();
		_pMultiSelPathElemAgent = NULL;
	}

	_pCurrentObj = NULL;

	if (NULL != _pMultiSelTestObjDlgAgent)
	{
		_pMultiSelTestObjDlgAgent->RequestDelayedDestruction();
		_pMultiSelTestObjDlgAgent = NULL;
	}

	if (NULL != _pSelTestObjDlgAgent)
	{
		_pSelTestObjDlgAgent->RequestDelayedDestruction();
		_pSelTestObjDlgAgent = NULL;
	}

	if (NULL != _pSelObjDlgAgent)
	{
		_pSelObjDlgAgent->RequestDelayedDestruction();
		_pSelObjDlgAgent = NULL;
	}

	if (NULL != _pSelTestObjPathElemAgent2)
	{
		_pSelTestObjPathElemAgent2->RequestDelayedDestruction();
		_pSelTestObjPathElemAgent2 = NULL;
	}

	if (NULL != _pSelTestObjPathElemAgent)
	{
		_pSelTestObjPathElemAgent->RequestDelayedDestruction();
		_pSelTestObjPathElemAgent = NULL;
	}

	if (NULL != _pSelObjPathElemAgent)
	{
		_pSelObjPathElemAgent->RequestDelayedDestruction();
		_pSelObjPathElemAgent = NULL;
	}

	if (NULL != _pATOZDevelopmentAssistantDlg)
	{
		_pATOZDevelopmentAssistantDlg->RequestDelayedDestruction();
		_pATOZDevelopmentAssistantDlg = NULL;
	}

	_ModelBag.RemoveAll();
}

HRESULT ATOZDevelopmentAssistantCmd::InitializeMainDialog()
{
	_pATOZDevelopmentAssistantDlg = new ATOZDevelopmentAssistantDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
		"CallEngineeringTemplateDlg");

	_pATOZDevelopmentAssistantDlg->Build();

	_pATOZDevelopmentAssistantDlg->SetGridColumnResizable(0, 1);
	_pATOZDevelopmentAssistantDlg->_Frame1->SetGridColumnResizable(1, 1);
	_pATOZDevelopmentAssistantDlg->_Frame2->SetGridColumnResizable(1, 1);

	_pATOZDevelopmentAssistantDlg->_SelectorList->SetLine("No Selection");
	int ArraySel[1] = { 0 };
	_pATOZDevelopmentAssistantDlg->_SelectorList->SetSelect(ArraySel, 1);

	_pATOZDevelopmentAssistantDlg->_SelectorListTest->SetLine("No Selection");
	_pATOZDevelopmentAssistantDlg->_SelectorMulti->SetLine("No Selection");
	_pATOZDevelopmentAssistantDlg->_SelectorListTest2->SetLine("No Selection");

	_pATOZDevelopmentAssistantDlg->SetVisibility(CATDlgShow);
	return S_OK;
}

//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void ATOZDevelopmentAssistantCmd::BuildGraph()
{
	//获取对象类型 代理
	_pSelObjPathElemAgent = new CATPathElementAgent("SelectObj");
	_pSelObjPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot | CATDlgEngWithTooltip);
	//_pSelObjPathElemAgent->AddElementType(IID_CATIPLMNavRepOccurrence); //IID_CATIMf3DBehavior IID_CATIMfTriDimResult IID_CATIMfBiDimResult IID_CATIMmiUsePrtPart
	_pSelObjPathElemAgent->AddElementType(IID_CATBaseUnknown);

	//单选功能测试 代理
	_pSelTestObjPathElemAgent = new CATPathElementAgent("SelectTestObj");
	_pSelTestObjPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot | CATDlgEngWithTooltip);
	//_pSelTestObjPathElemAgent->AddElementType("CATIMmiUseMechanicalTool");
	//_pSelTestObjPathElemAgent->AddElementType(IID_CATIMf3DAxisSystem);
	//_pSelTestObjPathElemAgent->AddElementType("IDMPoint2D");
	//_pSelTestObjPathElemAgent->AddElementType(IID_CATIMmiUsePrtPart);
	//_pSelTestObjPathElemAgent->AddElementType(IID_CATIDrwDimDimension);
	//_pSelTestObjPathElemAgent->AddElementType(IID_CATIDftView);
	_pSelTestObjPathElemAgent->AddElementType(IID_CATIPipPipeInstance);


	//单选功能测试 代理2
	_pSelTestObjPathElemAgent2 = new CATPathElementAgent("SelectTestObj2");
	_pSelTestObjPathElemAgent2->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot | CATDlgEngWithTooltip);
	_pSelTestObjPathElemAgent2->AddElementType(IID_CATBaseUnknown);
	//_pSelTestObjPathElemAgent2->AddElementType(IID_CATIMf3DAxisSystem);
	//_pSelTestObjPathElemAgent2->AddElementType("CATIDrwDimDimension");
	//_pSelTestObjPathElemAgent2->AddElementType(IID_CATIDftView);
	

	//多选功能测试 代理
	_pMultiSelPathElemAgent = new CATPathElementAgent("MultiSel");
	_pMultiSelPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngMultiAcquisitionSelModes | CATDlgEngMultiAcquisitionSelModes | CATDlgEngMultiAcquisitionCtrl | CATDlgEngMultiAcquisitionUserCtrl);
	_pMultiSelPathElemAgent->AddElementType(IID_CATBaseUnknown);


	//获取对象类型 对话框代理
	_pSelObjDlgAgent = new CATDialogAgent("ObjDlg");
	_pSelObjDlgAgent->AcceptOnNotify(_pATOZDevelopmentAssistantDlg->_SelectorList,
		_pATOZDevelopmentAssistantDlg->_SelectorList->GetListSelectNotification());

	//单选功能测试 对话框代理
	_pSelTestObjDlgAgent = new CATDialogAgent("TestObjDlg");
	_pSelTestObjDlgAgent->AcceptOnNotify(_pATOZDevelopmentAssistantDlg->_SelectorListTest,
		_pATOZDevelopmentAssistantDlg->_SelectorListTest->GetListSelectNotification());

	_pSelTestObjDlgAgent2 = new CATDialogAgent("TestObjDlg2");
	_pSelTestObjDlgAgent2->AcceptOnNotify(_pATOZDevelopmentAssistantDlg->_SelectorListTest2,
		_pATOZDevelopmentAssistantDlg->_SelectorListTest2->GetListSelectNotification());

	//多选功能测试 对话框代理
	_pMultiSelTestObjDlgAgent = new CATDialogAgent("TestMultiObjDlg");
	_pMultiSelTestObjDlgAgent->AcceptOnNotify(_pATOZDevelopmentAssistantDlg->_SelectorMulti,
		_pATOZDevelopmentAssistantDlg->_SelectorMulti->GetListSelectNotification());

	//状态定义
	CATDialogState * SelectObjState = GetInitialState("选择需要查看类型的对象");
	SelectObjState->AddDialogAgent(_pSelObjPathElemAgent);
	SelectObjState->AddDialogAgent(_pSelTestObjDlgAgent);
	SelectObjState->AddDialogAgent(_pMultiSelTestObjDlgAgent);

	CATDialogState * SelectTestObjState = AddDialogState("选择需要测试功能的对象");
	SelectTestObjState->AddDialogAgent(_pSelTestObjPathElemAgent);
	SelectTestObjState->AddDialogAgent(_pSelObjDlgAgent);
	SelectTestObjState->AddDialogAgent(_pSelTestObjDlgAgent2);
	SelectTestObjState->AddDialogAgent(_pMultiSelTestObjDlgAgent);

	CATDialogState * SelectTestObjState2 = AddDialogState("选择需要测试功能的对象2");
	SelectTestObjState2->AddDialogAgent(_pSelTestObjPathElemAgent);
	SelectTestObjState2->AddDialogAgent(_pSelObjDlgAgent);
	SelectTestObjState2->AddDialogAgent(_pMultiSelTestObjDlgAgent);

	CATDialogState * MultiSelTestObjState = AddDialogState("选择多个需要测试功能的对象");
	MultiSelTestObjState->AddDialogAgent(_pMultiSelPathElemAgent);
	MultiSelTestObjState->AddDialogAgent(_pSelObjDlgAgent);
	MultiSelTestObjState->AddDialogAgent(_pSelTestObjDlgAgent);

	

	//类型获取 状态转换
	AddTransition(SelectObjState, SelectObjState,
		IsOutputSetCondition(_pSelObjPathElemAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::SelectObj));

	AddTransition(SelectObjState, SelectTestObjState,
		IsOutputSetCondition(_pSelTestObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	AddTransition(SelectObjState, MultiSelTestObjState,
		IsOutputSetCondition(_pMultiSelTestObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	//单选功能测试 状态转换
	AddTransition(SelectTestObjState, SelectTestObjState,
		IsOutputSetCondition(_pSelTestObjPathElemAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::SelectTestObj));

	AddTransition(SelectTestObjState, SelectObjState,
		IsOutputSetCondition(_pSelTestObjDlgAgent2),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	AddTransition(SelectTestObjState, SelectObjState,
		IsOutputSetCondition(_pSelObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	AddTransition(SelectTestObjState, MultiSelTestObjState,
		IsOutputSetCondition(_pMultiSelTestObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	//单选功能测试2 状态转换
	AddTransition(SelectTestObjState2, SelectTestObjState2,
		IsOutputSetCondition(_pSelTestObjPathElemAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::SelectTestObj2));

	AddTransition(SelectTestObjState2, SelectTestObjState,
		IsOutputSetCondition(_pSelTestObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	//多选功能测试 状态转换
	AddTransition(MultiSelTestObjState, MultiSelTestObjState,
		IsOutputSetCondition(_pMultiSelPathElemAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::IterateTestObj));

	AddTransition(MultiSelTestObjState, SelectObjState,
		IsOutputSetCondition(_pSelObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	AddTransition(MultiSelTestObjState, SelectTestObjState,
		IsOutputSetCondition(_pSelTestObjDlgAgent),
		Action((ActionMethod)&ATOZDevelopmentAssistantCmd::CleanDialogAgent));

	
	//类型获取 回调
	AddAnalyseNotificationCB(_pATOZDevelopmentAssistantDlg->_PushButton,
		_pATOZDevelopmentAssistantDlg->_PushButton->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZDevelopmentAssistantCmd::GetObjType, NULL);

	//功能测试 回调 （单选与多选）
	AddAnalyseNotificationCB(_pATOZDevelopmentAssistantDlg->_PushButtonTest,
		_pATOZDevelopmentAssistantDlg->_PushButtonTest->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZDevelopmentAssistantCmd::TestFunction, NULL);

	//功能测试 回调 （无选择）
	AddAnalyseNotificationCB(_pATOZDevelopmentAssistantDlg->_PushButtonFuncTest,
		_pATOZDevelopmentAssistantDlg->_PushButtonFuncTest->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZDevelopmentAssistantCmd::TestAll, NULL);

	//click OK button
	AddAnalyseNotificationCB(_pATOZDevelopmentAssistantDlg,
		_pATOZDevelopmentAssistantDlg->GetDiaOKNotification(),
		(CATCommandMethod)&ATOZDevelopmentAssistantCmd::OKAction, NULL);

	//click Wndclose buttion
	AddAnalyseNotificationCB(_pATOZDevelopmentAssistantDlg,
		_pATOZDevelopmentAssistantDlg->GetWindCloseNotification(),
		(CATCommandMethod)&ATOZDevelopmentAssistantCmd::ExitCmd, NULL);

	//click cancel button
	AddAnalyseNotificationCB(_pATOZDevelopmentAssistantDlg,
		_pATOZDevelopmentAssistantDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&ATOZDevelopmentAssistantCmd::ExitCmd, NULL);

}

void ATOZDevelopmentAssistantCmd::OKAction()
{
	this->RequestDelayedDestruction();
	return;
}

void ATOZDevelopmentAssistantCmd::ExitCmd()
{
	this->RequestDelayedDestruction();
	return;
}

void ATOZDevelopmentAssistantCmd::SelectObj(void* idata)
{

	CATPathElement* pPathElem = _pSelObjPathElemAgent->GetValue();
	_spBU = _pSelObjPathElemAgent->GetElementValue();
	_pSelObjPathElemAgent->InitializeAcquisition();

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	//ListOfDelegated* delegated = _spBU->ListDelegatedInterface();
	//travelList(delegated);

	CATDlgSelectorList* pDlgSelList = _pATOZDevelopmentAssistantDlg->_SelectorList; //CATDrwAnndDecodeLeaf
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}

}


//用于单选择功能测试
void ATOZDevelopmentAssistantCmd::SelectTestObj(void* idata)
{
	CATPathElement* pPathElem = _pSelTestObjPathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = _pSelTestObjPathElemAgent->GetElementValue();
	_pSelTestObjPathElemAgent->InitializeAcquisition();

	CATIPipPipeInstance_var spTest = pBaseUnknown;

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZDevelopmentAssistantDlg->_SelectorListTest;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}

	CATBaseUnknown *pIUnkPipeRef = NULL;
	spTest->GetReference(pIUnkPipeRef);
	if (NULL != pIUnkPipeRef)
	{
		CATIPipRigidPipeReference_var hPipRigidRef;
		hPipRigidRef = pIUnkPipeRef;
		if (NULL_var != hPipRigidRef)
		{
			//引导点
			CATLISTV(CATIMmiMechanicalFeature_var) listOfFeat;
			hPipRigidRef->GetAllPoints(listOfFeat);
			const int SIZE = listOfFeat.Size();
			
			cout << "the count of the guide point is " << SIZE << endl;


		}

		pIUnkPipeRef->Release(); pIUnkPipeRef = NULL;
	}


	return;
	//功能测试区
	CATIHvaPartInstance* hHvaPartInstance(NULL);
	_spBUTest->QueryInterface(IID_CATIHvaPartInstance, (void**)&hHvaPartInstance);

	CATIHvaPartReference* pIHvaPartRef(NULL);
	if (NULL != hHvaPartInstance) {

		hHvaPartInstance->GetReference(pIHvaPartRef);
		hHvaPartInstance->Release(); hHvaPartInstance = NULL;

		CATLISTP(CATIHvaHvacPortRef) ListPorts;
		pIHvaPartRef->ListPorts(ListPorts);

		CATIHvaHvacPortRef* pIThisPort(NULL);
		CATMathPoint  * pMathPtConstraintOriginPt = NULL;//Used in for loop - To be deleted
		CATMathVector * pMathVectConstraintAlign = NULL;//Used in for loop - To be deleted
		CATMathVector * pMathVectConstraintOrient = NULL;//Used in for loop - To be deleted

		const int SizeListPorts = ListPorts.Size();
		for (int nPortIndex = 1; nPortIndex <= SizeListPorts; nPortIndex++) {
			CATIHvaHvacPortRef::CATHvaGeomPortTypeEnum geomPortType(CATIHvaHvacPortRef::CatHvaUndefinedPort);
			pIThisPort = ListPorts[nPortIndex];
			pIThisPort->GetType(geomPortType);

			cout << geomPortType << endl;

			/*pIThisPort->GetConstraintElements(pMathPtConstraintOriginPt,
				pMathVectConstraintAlign,
				pMathVectConstraintOrient);*/
		}

	}


}


HRESULT ATOZDevelopmentAssistantCmd::BrowseOccurrences(int level, CATIPLMNavOccurrence_var spPLMNavOccOnCurrentNode,
	HRESULT(ATOZDevelopmentAssistantCmd::*print_function)(CATIPLMNavOccurrence_var, int))
{

	if (NULL_var == spPLMNavOccOnCurrentNode)
	{
		return E_INVALIDARG;
	}


	//
	// Print the current component
	//
	HRESULT rc = (this->*print_function)(spPLMNavOccOnCurrentNode, level);
	if (FAILED(rc))
		return rc;

	//
	// Now browse the child components
	//
	CATListPtrCATIPLMNavOccurrence ListChildOccurrences;
	rc = spPLMNavOccOnCurrentNode->ListChildren(ListChildOccurrences);
	if (SUCCEEDED(rc))
	{
		int i = 1;
		while (SUCCEEDED(rc) && (i <= ListChildOccurrences.Size()))
		{
			CATIPLMNavOccurrence_var spCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL_var != spCurrentChildOccurrence)
			{
				rc = BrowseOccurrences(level + 1, spCurrentChildOccurrence, print_function);
			}

			CATIPLMNavOccurrence * pCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL != pCurrentChildOccurrence)
			{
				pCurrentChildOccurrence->Release();
				pCurrentChildOccurrence = NULL;
			}

			i++;
		}
	}

	return rc;
}

HRESULT ATOZDevelopmentAssistantCmd::PrintOccurrenceInformation(CATIPLMNavOccurrence_var spPLMNavOccurrence, int level)
{
	HRESULT rc = S_OK;

	if (NULL_var == spPLMNavOccurrence)
	{
		return E_INVALIDARG;
	}

	for (int i = 0; i <= level; i++) cout << "   ";

	//
	// Prints alias name of the occurrence
	//
	CATIAlias_var spAliasOnComponent(spPLMNavOccurrence);
	CATUnicodeString AliasNameOfOccurrence;
	if (spAliasOnComponent != NULL_var)
	{
		AliasNameOfOccurrence = spAliasOnComponent->GetAlias();
	}

	cout << "<occ: " << AliasNameOfOccurrence.ConvertToChar() << ">";


	return rc;
}


void ATOZDevelopmentAssistantCmd::SelectTestObj2(void* idata)
{
	CATPathElement* pPathElem = _pSelTestObjPathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = _pSelTestObjPathElemAgent->GetElementValue();
	_pSelTestObjPathElemAgent->InitializeAcquisition();

	_spBUTest2 = pBaseUnknown;
	
	CATIPLMNavReference_var spObjInContext(NULL_var);
	ClsDrawingPubServices::GetProductFromView(_spBUTest2, spObjInContext);
	
	cout << "视图所对应的上下文对象: " << spObjInContext << endl;

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZDevelopmentAssistantDlg->_SelectorListTest2;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}


}

//用于多选择功能测试
void ATOZDevelopmentAssistantCmd::MultiSelectTestObj(void* idata)
{
	cout << "MultiSelectTestObj entered" << endl;
	_pSObj = _pMultiSelPathElemAgent->GetListOfValues();
	_pMultiSelPathElemAgent->InitializeAcquisition();

	CATUnicodeString strFullPath("");
	const int SIZE = _pSObj->GetSize();
	if (0 == SIZE)
	{
		cout << "所选元素个数为0" << endl;
	}

	CATDlgSelectorList* pDlgSelList = _pATOZDevelopmentAssistantDlg->_SelectorMulti;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();

		for (int i = 0; i < SIZE; i++)
		{
			CATPathElement * pPath = (CATPathElement*)(*_pSObj)[i];
			TestPrintPath2(pPath, strFullPath);
			pDlgSelList->SetLine(strFullPath);
		}
	}

}

void ATOZDevelopmentAssistantCmd::TestPrintPath2(CATPathElement * ipPath, CATUnicodeString & oPathName)
{

	oPathName = "";
	if (NULL != ipPath)
	{
		int sizeOfThePath = ipPath->GetSize();


		CATBaseUnknown * pElt = (*ipPath)[sizeOfThePath - 1];
		if (NULL != pElt)
		{
			CATIAlias * pIAliasOnElt = NULL;
			HRESULT rc = pElt->QueryInterface(IID_CATIAlias, (void**)&pIAliasOnElt);
			if (SUCCEEDED(rc))
			{
				CATUnicodeString Name = pIAliasOnElt->GetAlias();
				oPathName.Append(Name);

				pIAliasOnElt->Release();
				pIAliasOnElt = NULL;
			}
		}

	}
}

void ATOZDevelopmentAssistantCmd::IterateTestObj(void* idata)
{
	CATDlgSelectorList* pDlgSelList = _pATOZDevelopmentAssistantDlg->_SelectorMulti;
	if (NULL == pDlgSelList)
	{
		cout << "NULL == pDlgSelList" << endl;
		return;
	}
	CATUnicodeString strFullPath("");

	CATSO* pObjSO = _pMultiSelPathElemAgent->GetListOfValues();
	CATPathElement *pElemPath = NULL;


	if (NULL != pObjSO)
	{
		pDlgSelList->ClearLine();

		// We will scan the CSO from the begining
		pObjSO->InitElementList();
		while (NULL != (pElemPath = (CATPathElement*)pObjSO->NextElement()))
		{
			TestPrintPath2(pElemPath, strFullPath);
			pDlgSelList->SetLine(strFullPath);
		}

		_pMultiSelPathElemAgent->InitializeAcquisition();

	}

}



//功能测试区 单选与多选
void ATOZDevelopmentAssistantCmd::TestFunction()
{
	cout << "begin TestFunction" << endl;
	
	


	//原始测试代码 可删除

	//this->RequestDelayedDestruction();
	return;
	
}

HRESULT ATOZDevelopmentAssistantCmd::GetRootDrawing(CATIDftDrawing_var &ospDrawing)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATPathElement& CurrentElemPath = pFrmEditor->GetUIActiveObject();
	CATBaseUnknown* pCurrentObject = CurrentElemPath.FindElement(IID_CATIDftDrawing);
	if (NULL != pCurrentObject)
	{
		ospDrawing = pCurrentObject;
	}

	return S_OK;
}

//无选择功能测试
void ATOZDevelopmentAssistantCmd::TestAll()
{
	
	
	RecursiveLoad(_spRootNavRef);

	return;


	//管道port测试
	if (NULL_var == _spPrdOccurr) {
		cout << "NULL_var == _spPrdOccurr" << endl;
		return;
	}

	//在根节点下遍历所有管道接口 已获取坐标 
	CATListPtrCATIPLMNavOccurrence  ListofPtrNavOccurrence;
	_spPrdOccurr->ListChildren(ListofPtrNavOccurrence);

	const int SizeRootList = ListofPtrNavOccurrence.Size();
	int nCreatePortNo = 1;
	CATIPipPipingPortRef::CATPipGeomPortTypeEnum geomPortType(CATIPipPipingPortRef::CatPipUndefinedPort);

	CATIPLMNavOccurrence* pIElemNavOccurrence = NULL;

	for (int index = 1; index <= SizeRootList; index++) {
		pIElemNavOccurrence = ListofPtrNavOccurrence[index];
		if (NULL == pIElemNavOccurrence) continue;

		CATIPipPartInstance* hHvaPartInstance(NULL);
		pIElemNavOccurrence->QueryInterface(IID_CATIPipPartInstance, (void**)&hHvaPartInstance);
		if (NULL != hHvaPartInstance) {
			CATIPipPartReference* pIHvaPartRef = NULL;
			hHvaPartInstance->GetReference(pIHvaPartRef);
			
			CATLISTP(CATIPipPipingPortRef) ListPorts;
			pIHvaPartRef->ListPorts(ListPorts);
			
			const int SizeListPorts = ListPorts.Size();

			for (int nPortIndex = 1; nPortIndex <= SizeListPorts; nPortIndex++) {
				
				CATIPipPipingPortRef* pIThisPort = NULL;
				pIThisPort = ListPorts[nPortIndex];

				pIThisPort->GetType(geomPortType);
				cout << "the type of the port is " << geomPortType << endl;

				CATMathPoint  * pMathPtConstraintOriginPt = NULL;
				CATMathVector * pMathVectConstraintAlign = NULL;
				CATMathVector * pMathVectConstraintOrient = NULL;

				pIThisPort->GetConstraintElements(pMathPtConstraintOriginPt,
					pMathVectConstraintAlign,
					pMathVectConstraintOrient);

				double Cordx = pMathPtConstraintOriginPt->GetX();
				double Cordy = pMathPtConstraintOriginPt->GetY();
				double Cordz = pMathPtConstraintOriginPt->GetZ();

				cout << "the cord of the port is " << Cordx << " " << Cordy << " " << Cordz << endl;
				cout << endl;



			}


			hHvaPartInstance->Release(); hHvaPartInstance = NULL;
			pIHvaPartRef->Release(); pIHvaPartRef = NULL;
		}
	}





	return;
}

HRESULT ATOZDevelopmentAssistantCmd::RecursiveLoad(CATIPLMNavReference *ipNavRef)
{
	HRESULT hr = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			hr = S_OK;
			CATIPLMNavEntity * pChild = NULL;
			for (int j = 1; j <= nbChildren; j++)
			{
				CATBaseUnknown_var spNavEntity = childrenList[j];
				if (NULL_var != spNavEntity)
				{

					CATIPrdObject_var spPrd(childrenList[j]);
					if (NULL_var != spPrd)
					{
						CATIPLMNavReference * oReference = NULL;
						if (SUCCEEDED(spPrd->GetReferenceObject((CATBaseUnknown*&)oReference, IID_CATIPLMNavReference)))
						{
							CATIAlias_var spAlias;
							spAlias = oReference;
							if (NULL_var != spAlias) printf("oReference =%s \n", spAlias->GetAlias().ConvertToChar());

							if (FAILED(LoadRepresentations(oReference)))
							{
								hr = E_FAIL;
							}
							else
							{
								RecursiveLoad(oReference);
							}
							oReference->Release(); oReference = NULL;
						}
					}
				}
				else
					hr = E_FAIL;

				pChild = childrenList[j];
				if (NULL != pChild)
				{
					pChild->Release();
					pChild = NULL;
				}
			}
		}
	}
	return hr;
}

//=============================================================================
// This method loads in session all the representation of a PLM reference 
//=============================================================================
HRESULT ATOZDevelopmentAssistantCmd::LoadRepresentations(CATIPLMNavReference *ipNavRef)
{
	HRESULT rc = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		rc = E_FAIL;

		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreRepInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			HRESULT hr = E_FAIL;
			rc = S_OK;
			for (int j = 1; j <= nbChildren; j++)
			{
				hr = E_FAIL;
				CATIPLMNavEntity * pNavEntity = childrenList[j];
				if (NULL != pNavEntity)
				{
					CATIPLMNavRepInstance * pNavRepInst = NULL;
					if (SUCCEEDED(pNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void **)&pNavRepInst)))
					{
						CATIPLMNavRepReference * pNavRepRef = NULL;
						if (SUCCEEDED(pNavRepInst->GetRepReferenceInstanceOf(pNavRepRef)))
						{
							CATIPsiRepresentationLoadMode * pRepLoadMode = NULL;
							if (SUCCEEDED(pNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&pRepLoadMode)))
							{
								cout << "加载的3DShape 为" << CATIAlias_var(pRepLoadMode)->GetAlias() << endl;
								hr = pRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
								pRepLoadMode->Release();
								pRepLoadMode = NULL;
							}
							CATIMmiPrtContainer * piPrtContainer = NULL;
							rc = pNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&piPrtContainer);
							if (SUCCEEDED(rc) && (NULL != piPrtContainer))
							{
								CATIMmiMechanicalFeature_var spMechFeature = NULL_var;
								piPrtContainer->GetMechanicalPart(spMechFeature);
								piPrtContainer->Release();
								piPrtContainer = NULL;

								CATIMmiUsePrtPart_var spPartFeature = spMechFeature;
								CATIMmiMechanicalFeature_var spGsmTool(NULL_var);
								CAAGsiGetGeometricFeatureSets(spPartFeature, "管道中心线", spGsmTool);
								if (NULL_var != spGsmTool) {
									cout << "找到几何图形集" << endl;
									DeleteAnything(spGsmTool);
									spGsmTool = NULL_var;
								}
							}
							pNavRepRef->Release();
							pNavRepRef = NULL;
						}
						pNavRepInst->Release();
						pNavRepInst = NULL;
					}

					pNavEntity->Release();
					pNavEntity = NULL;
				}
				if (FAILED(hr))    rc = hr;
			}
		}
	}

	return rc;
}


void ATOZDevelopmentAssistantCmd::CreateNewPrdInst(CATIPLMProducts_var &iospPLMProductsOnRootRef, CATIPLMProducts_var &iospPLMProductsOnNewRef)
{
	CATIPLMProducts *pPLMProductsOnNewRef(NULL);

	CATIPrdReferenceFactory * pIPrdFactory = NULL;
	HRESULT rc = CATPrdFactory::CreatePrdFactory(IID_CATIPrdReferenceFactory, (void**)&pIPrdFactory);

	CATIType_var spRefType;
	CATCkePLMNavPublicServices::RetrieveKnowledgeType("VPMReference", spRefType);
	CATListValCATICkeParm_var EmptyListAttr;
	rc = pIPrdFactory->CreatePrdReference(spRefType, EmptyListAttr, pPLMProductsOnNewRef, NULL);

	CATBaseUnknown* pBUForNewInst = NULL;
	rc = iospPLMProductsOnRootRef->AddProduct(pPLMProductsOnNewRef, pBUForNewInst, IID_CATIPLMNavInstance);
	if (FAILED(rc) || NULL == pBUForNewInst)
	{
		cout << "AddProduct Failed" << endl;
		return;
	}

	iospPLMProductsOnNewRef = pBUForNewInst;

	pPLMProductsOnNewRef->Release();
	pPLMProductsOnNewRef = NULL;

	pBUForNewInst->Release();
	pBUForNewInst = NULL;

	pIPrdFactory->Release();
	pIPrdFactory = NULL;
}





void ATOZDevelopmentAssistantCmd::PathElementString(CATPathElement * ipPath, CATUnicodeString & oPathName, CATBoolean Leaf)
{
	oPathName = "";
	if (NULL != ipPath)
	{
		int sizeOfThePath = ipPath->GetSize();

		for (int i = sizeOfThePath - 1; i >= 0; i--)
		{
			CATBaseUnknown * pElt = (*ipPath)[i];
			if (NULL != pElt)
			{
				CATIAlias * pIAliasOnElt = NULL;
				HRESULT rc = pElt->QueryInterface(IID_CATIAlias, (void**)&pIAliasOnElt);
				if (SUCCEEDED(rc))
				{
					CATUnicodeString Name = pIAliasOnElt->GetAlias();
					//cout << pElt->GetImpl()->IsA()<< endl;
					oPathName.Append(Name);

					if (TRUE == Leaf)
					{
						pIAliasOnElt->Release();
						pIAliasOnElt = NULL;
						break;
					}

					if (i > 0)
					{
						oPathName.Append("/"); ;
					}

					pIAliasOnElt->Release();
					pIAliasOnElt = NULL;
				}
			}
		}
	}
}

void ATOZDevelopmentAssistantCmd::CleanDialogAgent()
{
	if (_pSelObjDlgAgent->IsOutputSet())
	{
		_pSelObjDlgAgent->InitializeAcquisition();
		_pATOZDevelopmentAssistantDlg->_SelectorListTest->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorMulti->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorListTest2->ClearSelect();
	}
	if (_pSelTestObjDlgAgent->IsOutputSet())
	{
		_pSelTestObjDlgAgent->InitializeAcquisition();
		_pATOZDevelopmentAssistantDlg->_SelectorList->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorMulti->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorListTest2->ClearSelect();
	}

	if (_pMultiSelTestObjDlgAgent->IsOutputSet())
	{
		_pMultiSelTestObjDlgAgent->InitializeAcquisition();
		_pATOZDevelopmentAssistantDlg->_SelectorListTest->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorList->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorListTest2->ClearSelect();
	}

	if (_pSelTestObjDlgAgent2->IsOutputSet())
	{
		_pSelTestObjDlgAgent2->InitializeAcquisition();
		_pATOZDevelopmentAssistantDlg->_SelectorListTest->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorList->ClearSelect();
		_pATOZDevelopmentAssistantDlg->_SelectorMulti->ClearSelect();

	}

}

int ATOZDevelopmentAssistantCmd::DisplayMessage(const CATString &istrMsgType,
	const CATUnicodeString &iusMsgToDisplay,
	const CATUnicodeString &iusDlgTitle)
{

	int RetUserReply = 0;

	CATDlgStyle Dlgstyle;
	CATUnicodeString usDlgTitle = "";

	if (istrMsgType == "Error")
	{
		Dlgstyle = CATDlgNfyError | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Error";
	}
	else if (istrMsgType == "Information")
	{
		Dlgstyle = CATDlgNfyInformation | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Information";
	}
	else if (istrMsgType == "Warning")
	{
		Dlgstyle = CATDlgNfyWarning | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Warning";
	}

	if (iusDlgTitle != "")usDlgTitle = iusDlgTitle;

	CATDlgNotify* pDlgNotify = new CATDlgNotify((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(), istrMsgType, Dlgstyle);
	if (!pDlgNotify) return 0;

	RetUserReply = pDlgNotify->DisplayBlocked(iusMsgToDisplay, usDlgTitle); // Get the User selected button
	return RetUserReply;
}

//获取类型
void ATOZDevelopmentAssistantCmd::GetObjType()
{
	if (NULL_var == _spBU)
	{
		return;
	}

	CATUnicodeString strTypeName("");
	CATDlgEditor* pDlgEditor = _pATOZDevelopmentAssistantDlg->_Editor;
	strTypeName = _spBU->GetImpl()->IsA();
	cout << strTypeName << endl;
	if (NULL != pDlgEditor)
	{
		pDlgEditor->ClearLine();
		pDlgEditor->SetLine(strTypeName);
	}
	strTypeName = _spBU->IsA();
	pDlgEditor->SetLine(strTypeName);

	//CATMetaClass* pMetaObj 
	//ListofSupportedInterface
	
}

//DisplayTemplateView
HRESULT ATOZDevelopmentAssistantCmd::DisplayTemplateView()
{
	//判断项目中是否存在物料
	CATLISTV(CATString)        listAttrName;
	CATLISTV(CATUnicodeString) listAttrValue;
	listAttrName.Append("PLM_ExternalID");
	//listAttrName.Append("revision");

	listAttrValue.Append("CXMS-Piping-工艺库");
	//listAttrValue.Append(_strFeatVersion);
	CATListPtrCATAdpQueryResult listQueryResult = NULL;
	GetPLMObjectsFromAttrAndFromType(listAttrName, listAttrValue, "VPMReference", listQueryResult);
	if (listQueryResult.Size() > 0)
	{
		CATBoolean authoringMode = TRUE;
		CATIPLMNavReference* piProductRef = NULL;
		OpenPLMComponent("VPMReference", listAttrName, listAttrValue,
			IID_CATIPLMNavReference, (void**)&piProductRef, _ModelBag, authoringMode);
		if (NULL != piProductRef)
		{
			/*CATIPLMComponent_var spPLMComponent = piProductRef;
			if (NULL_var != spPLMComponent)
			{
			PrintComponentAttrs(spPLMComponent);
			}*/

			CATIPrdOccurrenceMngt* piOccurrMngt = NULL;
			if (SUCCEEDED(CATPrdGetOccurrenceMngt(piOccurrMngt)) && piOccurrMngt)
			{
				CATIPLMNavOccurrence_var spPrdOccurr = NULL_var;
				piOccurrMngt->GetOrCreateRootOccurrence(piProductRef, spPrdOccurr);
				if (NULL_var != spPrdOccurr)
				{
					CATFrmEditor * pEditor = CATFrmEditor::GetCurrentEditor();
					CATVisManager * pVisuManager = CATVisManager::GetVisManager();
					CATCommand * pCommandSelector = (CATCommand*)pEditor->GetCommandSelector();
					list<IID> ListIVisu3d;
					IID visu3d = IID_CATI3DGeoVisu;
					ListIVisu3d.fastadd(&visu3d);
					CATPathElement*  pRootObjectPath = new CATPathElement(spPrdOccurr);
					CATViewpoint*  pModelViewPoint = (CATViewpoint*)&(_pATOZDevelopmentAssistantDlg->_Nav3DViewerModel->GetMain3DViewpoint());
					HRESULT rc = pVisuManager->AttachTo(pRootObjectPath, pModelViewPoint, ListIVisu3d, pCommandSelector);

					_pATOZDevelopmentAssistantDlg->_Nav3DViewerModel->Draw();
					_pATOZDevelopmentAssistantDlg->_Nav3DViewerModel->Reframe();
				}

				piOccurrMngt->Release(); piOccurrMngt = NULL;
			}
			//_spFeatNavRef = piProductRef;
			piProductRef->Release(); piProductRef = NULL;
		}

	}

	return S_OK;
}

HRESULT ATOZDevelopmentAssistantCmd::GetPLMObjectsFromAttrAndFromType(const CATListOfCATString &listOfAttribute,
	const CATListOfCATUnicodeString &listOfValues,
	const CATUnicodeString &iStrPLMType,
	CATListPtrCATAdpQueryResult & opQueryResults)
{
	HRESULT hr = S_OK;
	//cout << "   GetPLMObjectsFromAttrAndFromType " << endl;

	if ((0 == listOfAttribute.Size()) || (0 == listOfValues.Size())) return E_INVALIDARG;
	if (listOfAttribute.Size() != listOfValues.Size()) return E_INVALIDARG;
	if (0 < opQueryResults.Size())return E_INVALIDARG;


	int iListSize = listOfAttribute.Size();

	CATAdpAttributeSet iAttributeSet;
	//cout << "   Build an Attribute set with inputs from user, for query into db" << endl;
	int i = 1;
	while ((i <= iListSize) && (SUCCEEDED(hr)))
	{
		CATUnicodeString Name = listOfAttribute[i].CastToCharPtr();
		const CATString AttributeINPUT = CATCkePLMNavPublicServices::RetrieveBasicAttributeNameFromPreviousOne(NULL_var, Name).CastToCharPtr();
		CATUnicodeString AttrValue = listOfValues[i];

		hr = iAttributeSet.AddAttribute(AttributeINPUT, AttrValue);
		i++;
	}

	CATIType_var spTypeObj = NULL_var;
	hr = RetrievePLMType(iStrPLMType, spTypeObj);
	if (FAILED(hr) || (NULL_var == spTypeObj))
	{
		cout << "ERROR:ClsPLMUtilities::GetPLMObjectsFromAttrAndFromType()-NULL_var == spTypeObj" << endl;
		return E_FAIL;
	}


	hr = CATAdpPLMQueryServices::GetElementsFromAttributes(spTypeObj,
		iAttributeSet,
		opQueryResults);

	return hr;
}

HRESULT ATOZDevelopmentAssistantCmd::OpenPLMComponent(const CATUnicodeString &istrPLMType,
	const CATListOfCATString &listAttrName,
	const CATLISTV(CATUnicodeString) &ListAttrValue,
	const IID& iIID,
	void **opiPLMComp,
	CATOmbLifeCycleRootsBag &iBag,
	CATBoolean iExpandAll)
{
	HRESULT hr = S_OK;
	if (CATUnicodeString("") == istrPLMType) return E_FAIL;
	if (0 == listAttrName.Size()) return E_FAIL;
	if (0 == ListAttrValue.Size()) return E_FAIL;

	int iListSize = listAttrName.Size();

	CATListPtrCATAdpQueryResult listQueryResult = NULL;
	hr = GetPLMObjectsFromAttrAndFromType(listAttrName, ListAttrValue, istrPLMType, listQueryResult);
	if (FAILED(hr) || (0 == listQueryResult.Size()))
	{

		cout << "ERROR:ClsPLMUtilities::OpenPLMComponent()-0 == listQueryResult.Size()" << endl;
		return hr;
	}

	CATIAdpPLMIdentificator* piAdpPLMIdentificator = NULL;
	listQueryResult[1]->GetIdentifier(piAdpPLMIdentificator);
	if (NULL == piAdpPLMIdentificator)
	{
		cout << "ERROR:ClsPLMUtilities::OpenPLMComponent()-NULL == piAdpPLMIdentificator" << endl;
		return E_FAIL;
	}

	if (TRUE == iExpandAll)
	{
		CATAdpOpenParameters params_Auth(CATAdpExpandParameters::Authoring);
		CATAdpOpener opener_Auth(iBag, params_Auth);
		// 5.2. Open the Retrieved Component by using CATAdpOpener
		hr = opener_Auth.CompleteAndOpen(piAdpPLMIdentificator, iIID, opiPLMComp);
	}
	else
	{
		CATAdpOpenParameters params_Nav(CATAdpExpandParameters::OneLevelRepresentations);
		CATAdpOpener opener_Nav(iBag, params_Nav);
		hr = opener_Nav.CompleteAndOpen(piAdpPLMIdentificator, iIID, opiPLMComp);
	}
	piAdpPLMIdentificator->Release();
	piAdpPLMIdentificator = NULL;

	return S_OK;
}

HRESULT ATOZDevelopmentAssistantCmd::RetrievePLMType(const CATUnicodeString & isPLMType,
	CATIType_var & ospType)
{
	HRESULT rc = E_INVALIDARG;
	if (isPLMType != "")
	{
		// For DS type
		rc = CATCkePLMNavPublicServices::RetrieveKnowledgeType(isPLMType, ospType);
		// For Specialization Type
		if (FAILED(rc))  rc = CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType(isPLMType, ospType);
	}
	return rc;
}

HRESULT ATOZDevelopmentAssistantCmd::CAAUpdateObject(CATBaseUnknown_var spUpdateObjectBU)
{
	if (NULL_var == spUpdateObjectBU)
	{
		cout << "ERROR:CAAUpdateObject() - spUpdateObjectBU is NULL!" << endl;
		return E_FAIL;
	}

	CATIUseEntity *piUseEntity = NULL;
	HRESULT rc = spUpdateObjectBU->QueryInterface(IID_CATIUseEntity, (void**)&piUseEntity);
	if (SUCCEEDED(rc))
	{
		rc = DataCommonProtocolServices::Update(piUseEntity);
		if (FAILED(rc))
		{
			CATError * pError = CATError::CATGetLastError(rc);
			if (NULL != pError)
			{
				cerr << "Error message is " << pError->GetNLSMessage() << endl;
				pError->Release();
				pError = NULL;
			}
		}
		piUseEntity->Release();
		piUseEntity = NULL;
	}

	return rc;
}

HRESULT ATOZDevelopmentAssistantCmd::GetCurrentPart(CATIMmiUsePrtPart_var &ospPrtPart,
	CATIPLMNavOccurrence_var &ospParentOccurr)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATPathElement& CurrentElemPath = pFrmEditor->GetUIActiveObject();
	CATBaseUnknown* pCurrentObject = CurrentElemPath.FindElement(IID_CATIMmiUsePrtPart);
	if (NULL != pCurrentObject)
	{
		ospPrtPart = pCurrentObject;
	}

	CATBaseUnknown* pOccurrObj = CurrentElemPath.FindElement(IID_CATIPLMNavOccurrence);
	if (NULL != pOccurrObj)
	{
		CATIPLMNavOccurrence_var spCurrentOccurr = pOccurrObj;
		if (NULL_var != spCurrentOccurr)
		{
			CATIPLMNavOccurrence* piParentOccurr = NULL;
			spCurrentOccurr->GetFather(piParentOccurr);
			if (NULL != piParentOccurr)
			{
				ospParentOccurr = piParentOccurr;
				piParentOccurr->Release(); piParentOccurr = NULL;
			}
		}

		//CATIPLMNavOccurrence_var spCurrentOccurr = pOccurrObj;
		//CATIAlias_var spAliasName = spCurrentOccurr;
		//cout << "pCurrentObject == " << spAliasName->GetAlias() << endl;
	}
	return S_OK;
}

HRESULT ATOZDevelopmentAssistantCmd::CAARetrieveIDofUniquePLMObject(CATListOfCATString &ilistOfAttribute,
	CATListOfCATUnicodeString &ilistOfValues,
	const char* &iStrPLMType,
	CATIAdpPLMIdentificator* &opiIdentOnPLMComp)
{
	// 0. Initialize the Return Value
	HRESULT hr = E_INVALIDARG;

	// 1. Check For Input Arguments
	if ((0 != ilistOfAttribute.Size()) || (0 != ilistOfValues.Size()))  hr = S_OK;
	if (ilistOfAttribute.Size() == ilistOfValues.Size())  hr = S_OK;


	int iListSize = ilistOfAttribute.Size();

	CATAdpPLMQueryAttributeSet iAttributeSetNew;
	CATAdpAttributeSet iAttributeSet;

	// 2. Build the Attribute Set For Query
	int i = 1;
	while ((i <= iListSize) && (SUCCEEDED(hr)))
	{
		// 2.1. Retrieve the Attributes Name and values from the input argument
		CATUnicodeString Name = ilistOfAttribute[i].ConvertToChar();
		const CATString AttributeINPUT = CATCkePLMNavPublicServices::RetrieveBasicAttributeNameFromPreviousOne(NULL_var, Name).ConvertToChar();
		CATUnicodeString AttrValue = ilistOfValues[i];
		// 2.2. Add the Attributes To the Set
		hr = iAttributeSetNew.AddStringAttribute(AttributeINPUT, AttrValue);
		// CATAdpAttributeSet is formed for the query by GetElementFromAttributes
		hr = iAttributeSet.AddAttribute(AttributeINPUT, AttrValue);
		i++;
	}

	// 3. Retrieve the Type by using the input String PLM Type
	CATIType_var spCATITypeOnPLMType;
	CATBoolean bPLMType = FALSE;
	if (SUCCEEDED(hr))
	{
		hr = CATCkePLMNavPublicServices::RetrieveKnowledgeType(iStrPLMType, spCATITypeOnPLMType);
		if (NULL_var == spCATITypeOnPLMType)
		{
			hr = CATCkePLMNavCustoAccessPublicServices::RetrieveCustoType(iStrPLMType, spCATITypeOnPLMType);
			if (SUCCEEDED(hr) && (NULL_var != spCATITypeOnPLMType))
			{
				bPLMType = TRUE;
				cout << "   Success CATCkePLMNavCustoAccessPublicServices::RetrieveCustoType " << (spCATITypeOnPLMType->Name()).ConvertToChar() << endl;
			}
		}
		else
		{
			bPLMType = TRUE;
			cout << "   Success CATCkePLMNavPublicAccessServices ::RetrieveKnowledgeType non custo type  " << (spCATITypeOnPLMType->Name()).ConvertToChar() << endl;
		}
	}
	if (bPLMType == FALSE)
		cout << "   RetrieveCustoType AND RetrieveKnowledgeType are Failed, Invalid PLMType : Identify the Correct PLMType in Modeler" << endl;

	// 4. Retrieve the Element From Database by using the PLM Type and Attribute Set
	CATBoolean bMultipleElementAttrSet = FALSE;
	CATBoolean bUniqueKeyDefOnObject = TRUE;
	CATBoolean bIsUnique = TRUE;
	CATBoolean bUniqueObjectFromKey = TRUE;
	CATBoolean bMultipleElementFromQuery = FALSE;
	CATAdpPLMComponentsInfos oComponentsInfos;

	// 4.1. Create the Filter Consists of PLMType and Attribute Set
	CATAdpPLMQueryFilter iQueryFilter(spCATITypeOnPLMType, iAttributeSetNew);

	// 4.2. Retrieve the Element from Database By using Filter , If Multiple elements are retrieved then Query Fails
	if (SUCCEEDED(hr)) hr = CATAdpPLMExtendedQueryServices::GetElementsFromQueryFilter(iQueryFilter, oComponentsInfos);

	if (SUCCEEDED(hr) && oComponentsInfos.Size() != 0)
	{
		if (oComponentsInfos.Size() != 1)
		{
			cout << "\n\t GetElementsFromQueryFilter Returns Multiple Elements. Please Provide Attribute For Identifying the Unique object from Database. Use PLM_EXTERNAL ID + Version" << endl;
			bMultipleElementAttrSet = TRUE;
		}
		// 4.3. Retrieve the Iterator for Attribute Set
		CATAdpPLMComponentsInfosIter iterator = oComponentsInfos.GetIterator();
		CATIAdpPLMIdentificator *oComponent = NULL;
		CATAdpPLMComponentInfos oInfos;
		CATAdpPLMComponentUniqueKey oUniqueKey;
		// 4.4. Retrieve the Attributes from iterator : Identificator of First PLM Object
		hr = iterator.NextInfos(oComponent, oInfos);

		// 4.5. Retrieve the Unique Key for PLM Object from Identificator
		if (SUCCEEDED(hr) && NULL != oComponent)
			hr = CATAdpPLMQueryServices::GetUniqueKey(oComponent, oUniqueKey);

		if (NULL != oComponent)
		{
			oComponent->Release(); oComponent = NULL;
		}

		if (FAILED(hr)) bUniqueKeyDefOnObject = FALSE;

		// 4.6. Display the Value of Unique Key
		CATUnicodeString oDisplayed;
		if (SUCCEEDED(hr))  hr = oUniqueKey.Display(oDisplayed);
		if (S_OK == hr)	 cout << "\n\t Unique Key is :" << oDisplayed.ConvertToChar() << endl;

		// 4.7. Insure the Unicity of Unique Key
		if (SUCCEEDED(hr))  hr = oUniqueKey.UnicityGuarantee();

		if (S_OK == hr)   cout << "\n\t Unicity Guranteed" << endl;
		else
		{
			cout << "\n\t Unicity of Unique Key is not Guranteed" << endl;
			bIsUnique = FALSE;
		}

		if (TRUE == bIsUnique)
		{
			CATListPtrCATIAdpPLMIdentificator oComponentsIdentifiers;
			// 4.8. Retrieve the Elements from Database by using Unique Key
			if (SUCCEEDED(hr))  hr = CATAdpPLMQueryServices::GetElementsByUniqueKey(oUniqueKey, oComponentsIdentifiers);
			// 4.9. If single element is retrieved return it, if mulitple elements are retrieved then Query Fails.
			if (SUCCEEDED(hr) && oComponentsIdentifiers.Size() != 0)  opiIdentOnPLMComp = oComponentsIdentifiers[1];
			else if (oComponentsIdentifiers.Size() != 1)
			{
				cout << "\n\t GetElementsByUniqueKey Returns Multiple Elements." << endl;
				bUniqueObjectFromKey = FALSE;
			}
		}

		// 4.10. If unique Key is not implemented on the Object then Retrieve the Object By using GetElementFromAttributes
		CATListPtrCATAdpQueryResult opQueryResults;
		if (bUniqueKeyDefOnObject == FALSE || bIsUnique == FALSE)
		{
			cout << "\n\t Unique Key is not Defined on PLM Object or Not Unique Use GetElementFromAttributes" << endl;
			hr = CATAdpPLMQueryServices::GetElementsFromAttributes(spCATITypeOnPLMType, iAttributeSet, opQueryResults);
		}

		// 4.11. If multiple elements areretrieved by above query then Query Fails  Return the identifier for first Object only
		if (SUCCEEDED(hr) && opQueryResults.Size() != 0)
		{
			CATAdpQueryResult *res = opQueryResults[1];
			if (res)
			{
				res->GetIdentifier(opiIdentOnPLMComp);
				delete res;
				res = NULL;
			}

			if (opQueryResults.Size() != 1)
			{
				cout << "\n\t\t GetElementFromAttributes Returns Mulitple Elements. Use Attribute which are unique" << endl;
				bMultipleElementFromQuery = TRUE;
			}
		}
	}

	// 5. Check for the Conditional Variable 
	if (bPLMType == FALSE || bMultipleElementAttrSet == TRUE || bUniqueObjectFromKey == FALSE || bMultipleElementFromQuery == TRUE)
		hr = E_FAIL;

	return hr;
}





//标高测试

HRESULT ATOZDevelopmentAssistantCmd::RetrieveRelatedInsProOfDftGeo(const CATIDftGenGeom_var &ispDftGenGeom,
	CATIPLMNavRepReference_var &ospRepRef,
	CATIPLMNavRepInstance_var &ospRepIns)
{
	if (NULL_var == ispDftGenGeom) return E_FAIL;

	CATOmbObjectInContext *oRepInstance = NULL;
	HRESULT rc = ispDftGenGeom->GetRepInstance(&oRepInstance);
	if (FAILED(rc) || NULL == oRepInstance)
	{
		cout << "ERROR:ClsDrawingPubServices::RetrieveRelatedInsProOfDftGeo()-oRepInstance is NULL!" << endl;
		return rc;
	}

	CATIPLMComponent*  opRepresentationInstance(NULL);
	oRepInstance->GetInstanceOfRepresentation(opRepresentationInstance);
	if (NULL_var != opRepresentationInstance)
	{
		cout << "opRepresentationInstance get" << endl;

		CATIPLMNavRepOccurrence_var spRepOccur = opRepresentationInstance;
		if (NULL_var != spRepOccur)
			cout << "get CATIPLMNavRepOccurrence_var" << endl;

		CATIPLMNavOccurrence_var spOccur = opRepresentationInstance;
		if (NULL_var != spOccur)
			cout << "get CATIPLMNavOccurrence_var" << endl;

		CATIPLMNavRepInstance_var spRepInstance = opRepresentationInstance;
		ospRepIns = spRepInstance;

		if (NULL_var != spRepInstance)
		{
			CATIPLMNavRepReference* pRepRef(NULL);
			spRepInstance->GetRepReferenceInstanceOf(pRepRef);
			if (NULL != pRepRef)
			{
				ospRepRef = pRepRef;
				pRepRef->Release(); pRepRef = NULL;
			}

		}

		opRepresentationInstance->Release(); opRepresentationInstance = NULL;
		return S_OK;
	}

	return rc;
}