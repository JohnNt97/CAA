//===================================================================
// COPYRIGHT ATOZ 2020/05/26
//===================================================================
// CallEngineeringTemplateCmd.cpp
// Header definition of class CallEngineeringTemplateCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2020/05/26 Creation: Code generated by the 3DS wizard
//===================================================================

#include "CallEngineeringTemplateCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( CallEngineeringTemplateCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
CallEngineeringTemplateCmd::CallEngineeringTemplateCmd() :
CATStateCommand ("CallEngineeringTemplateCmd", CATDlgEngOneShot, CATCommandModeShared)
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
, _pCallTempalteDlg(NULL)
, _ModelBag()
, _pSelPointPathElemAgent(NULL)
, _pSelHeadPointDlgAgent(NULL)
, _pSelTailPointDlgAgent(NULL)
,_spHeadPointObject(NULL_var)
,_spTailPointObject(NULL_var)
, _spParentOcurr(NULL_var)
, _strTemplateID("")
, _strActionName("")
, _strModelViewID("")
, _strModelViewVersion("")
, _listTemplateInstruction(NULL)
{
	HRESULT rc = InitializeConfigData();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}

	rc = InitializeMainDialog();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}
	_pCallTempalteDlg->_EditorInstructions->ClearLine();
	for (int i = 1; i <= _listTemplateInstruction.Size(); i++)
	{
		_pCallTempalteDlg->_EditorInstructions->SetLine(_listTemplateInstruction[i]);
	}

	CATIMmiUsePrtPart_var spCurrentPart = NULL_var;
	GetCurrentPart(spCurrentPart, _spParentOcurr);
	if (NULL_var == _spParentOcurr)
	{
		DisplayMessage("Error","Please work in product context!","ERROR");
		this->RequestDelayedDestruction();
		return;
	}

	DisplayTemplateView();
}
HRESULT CallEngineeringTemplateCmd::InitializeConfigData()
{
	CATUnicodeString strInstallPath("");
	ClsConfigXMLServices::Get_ComputeDataExePath(strInstallPath);
	if (CATUnicodeString("") == strInstallPath) return E_FAIL;

	CATUnicodeString strProjectConfigPath = strInstallPath + "bin\\\ATOZ\\CAAEKLConfig";
	if (0 != ::access(strProjectConfigPath.ConvertToChar(), 0))
	{
		DisplayMessage("Error","找不到CAAEKLConfig配置文件夹!","ERROR");
		return E_FAIL;
	}

	const char* pxmlfilePath = CATFindPath("CAAEKLConfig.xml", strProjectConfigPath);
	if (NULL == pxmlfilePath)
	{
		DisplayMessage("Error","找不到CAAEKLConfig.xml配置文件!","ERROR");
		return E_FAIL;
	}

	CATUnicodeString strXMLFilePath = pxmlfilePath;
	HRESULT rc = ClsConfigXMLServices::GetCUPSConfigData(strXMLFilePath,"刮板", _strTemplateID,
		                               _strActionName, _strModelViewID, _strModelViewVersion);
	if (FAILED(rc))
	{
		DisplayMessage("Error","读取CAAEKLConfig.xml配置文件失败!", "ERROR");
		return E_FAIL;
	}

	 strProjectConfigPath = strInstallPath + "bin\\\ATOZ";
	if (0 != ::access(strProjectConfigPath.ConvertToChar(), 0))
	{
		DisplayMessage("Error", "找不到ATOZ配置文件夹!", "ERROR");
		return E_FAIL;
	}
	else
	{
		const char* pfilePath = CATFindPath("TemplateInstruction_1.ini", strProjectConfigPath);
		if (NULL != pfilePath)
		{
			ClsConfigXMLServices::ReadTemplateText(pfilePath, _listTemplateInstruction);
			//for (int i = 1; i <= _listTemplateInstruction.Size(); i++)
			//{
			//	cout << "_listTemplateInstruction["<<i<<"] == "<< _listTemplateInstruction[i] << endl;
			//}
		}
	}

	return S_OK;
}
//消息类型：Error、Information、Warning
int CallEngineeringTemplateCmd::DisplayMessage(const CATString &istrMsgType,
	                                           const CATUnicodeString &iusMsgToDisplay,
	                                           const CATUnicodeString &iusDlgTitle)
{

	int RetUserReply = 0;

	CATDlgStyle Dlgstyle;
	CATUnicodeString usDlgTitle = "";

	if (istrMsgType == "Error")
	{
		Dlgstyle = CATDlgNfyError | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Error";
	}
	else if (istrMsgType == "Information")
	{
		Dlgstyle = CATDlgNfyInformation | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Information";
	}
	else if (istrMsgType == "Warning")
	{
		Dlgstyle = CATDlgNfyWarning | CATDlgNfyOK | CATDlgWndModal;
		usDlgTitle = "Warning";
	}

	if (iusDlgTitle != "")usDlgTitle = iusDlgTitle;

	CATDlgNotify* pDlgNotify = new CATDlgNotify((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(), istrMsgType, Dlgstyle);
	if (!pDlgNotify) return 0;

	RetUserReply = pDlgNotify->DisplayBlocked(iusMsgToDisplay, usDlgTitle); // Get the User selected button
	return RetUserReply;
}
//获取当前part节点和上下文product节点
HRESULT CallEngineeringTemplateCmd::GetCurrentPart(CATIMmiUsePrtPart_var &ospPrtPart,
	                                               CATIPLMNavOccurrence_var &ospParentOccurr)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL == pFrmEditor) return E_FAIL;

	CATPathElement& CurrentElemPath = pFrmEditor->GetUIActiveObject();
	CATBaseUnknown* pCurrentObject = CurrentElemPath.FindElement(IID_CATIMmiUsePrtPart);
	if (NULL != pCurrentObject)
	{
		ospPrtPart = pCurrentObject;
	}

	CATBaseUnknown* pOccurrObj = CurrentElemPath.FindElement(IID_CATIPLMNavOccurrence);
	if (NULL != pOccurrObj)
	{
		CATIPLMNavOccurrence_var spCurrentOccurr = pOccurrObj;
		if (NULL_var != spCurrentOccurr)
		{
			CATIPLMNavOccurrence* piParentOccurr = NULL;
			spCurrentOccurr->GetFather(piParentOccurr);
			if (NULL != piParentOccurr)
			{
				ospParentOccurr = piParentOccurr;
				piParentOccurr->Release(); piParentOccurr = NULL;
			}
		}

		//CATIPLMNavOccurrence_var spCurrentOccurr = pOccurrObj;
		//CATIAlias_var spAliasName = spCurrentOccurr;
		//cout << "pCurrentObject == " << spAliasName->GetAlias() << endl;
	}
	return S_OK;
}
//显示视图
HRESULT CallEngineeringTemplateCmd::DisplayTemplateView()
{
	//判断项目中是否存在物料
	CATLISTV(CATString)        listAttrName;
	CATLISTV(CATUnicodeString) listAttrValue;
	listAttrName.Append("PLM_ExternalID");
	listAttrName.Append("revision");
	
	listAttrValue.Append(_strModelViewID);
	listAttrValue.Append(_strModelViewVersion);
	CATListPtrCATAdpQueryResult listQueryResult = NULL;
	GetPLMObjectsFromAttrAndFromType(listAttrName, listAttrValue, "VPMReference", listQueryResult);
	if (listQueryResult.Size() > 0)
	{
		CATBoolean authoringMode = FALSE;
		CATIPLMNavReference* piProductRef = NULL;
		OpenPLMComponent("VPMReference", listAttrName, listAttrValue,
			IID_CATIPLMNavReference, (void**)&piProductRef, _ModelBag, authoringMode);
		if (NULL != piProductRef)
		{
			//CATIPLMComponent_var spPLMComponent = piProductRef;
			//if (NULL_var != spPLMComponent)
			//{
			//	PrintComponentAttrs(spPLMComponent);
			//}

			CATIPrdOccurrenceMngt* piOccurrMngt = NULL;
			if (SUCCEEDED(CATPrdGetOccurrenceMngt(piOccurrMngt)) && piOccurrMngt)
			{
				CATIPLMNavOccurrence_var spPrdOccurr = NULL_var;
				piOccurrMngt->GetOrCreateRootOccurrence(piProductRef, spPrdOccurr);
				if (NULL_var != spPrdOccurr)
				{
					CATFrmEditor * pEditor = CATFrmEditor::GetCurrentEditor();
					CATVisManager * pVisuManager = CATVisManager::GetVisManager();
					CATCommand * pCommandSelector = (CATCommand*)pEditor->GetCommandSelector();
					list<IID> ListIVisu3d;
					IID visu3d = IID_CATI3DGeoVisu;
					ListIVisu3d.fastadd(&visu3d);
					CATPathElement*  pRootObjectPath = new CATPathElement(spPrdOccurr);
					CATViewpoint*  pModelViewPoint = (CATViewpoint*)&(_pCallTempalteDlg->_Nav3DViewerModel->GetMain3DViewpoint());
					HRESULT rc = pVisuManager->AttachTo(pRootObjectPath, pModelViewPoint, ListIVisu3d, pCommandSelector);

					_pCallTempalteDlg->_Nav3DViewerModel->Draw();
					_pCallTempalteDlg->_Nav3DViewerModel->Reframe();
				}

				piOccurrMngt->Release(); piOccurrMngt = NULL;
			}
			piProductRef->Release(); piProductRef = NULL;
		}
	}

		return S_OK;
}
//修改零件参数
HRESULT CallEngineeringTemplateCmd::ModifyPartParams(const CATIPLMNavReference_var &ispProdRef)
{
	if (NULL_var == ispProdRef) return E_FAIL;

	CATIPLMNavRepReference_var spPLMRepRef = NULL_var;
	CATIMmiMechanicalFeature_var spPartObject = NULL_var;
	HRESULT rc = CAAMmrGetPartFromProduct(ispProdRef, spPLMRepRef, spPartObject);
	if (FAILED(rc) || (NULL_var == spPartObject)) return E_FAIL;
	if (NULL_var == spPLMRepRef) return E_FAIL;

	CATIParmPublisher_var spParamPublisher = spPLMRepRef;
	if (NULL_var == spParamPublisher)
	{
		cout << "ERROR:CallEngineeringTemplateCmd::GetPartParams()-NULL_var == spParamPublisher" << endl;
		return E_FAIL;
	}

	CATIKweModelServices_var spKweModelServices = CATCkeGlobalFunctions::GetModelServices();
	if (NULL_var == spKweModelServices)
	{
		cout << "ERROR:CallEngineeringTemplateCmd::GetPartParams()-NULL_var == spKweModelServices" << endl;
		return E_FAIL;
	}

	CATBaseUnknown_var spParamSetObj = NULL_var;
	spParamSetObj = spKweModelServices->GetCurrentSet(CATIKweModelServices::Parameter, spParamPublisher);
	if (NULL_var == spParamSetObj) return E_FAIL;
	//CATICkeParameterSet_var spParamSet = spParamSetObj;
	//if (NULL_var != spParamSet)
	//{
	//	CATLISTV(CATBaseUnknown_var)* pListParamObj = spParamSet->Parameters();
	//	if (NULL != pListParamObj)
	//	{
	//		for (int i = 1; i <= pListParamObj->Size(); i++)
	//		{
	//			CATICkeParm_var spParamObj = (*pListParamObj)[i];
	//			cout << "spParamObj == "<< spParamObj->Content() << endl;
	//		}

	//		delete[] pListParamObj; pListParamObj = NULL;
	//	}

	CATIParmPublisher_var spFristParmPublisher = spParamSetObj;
	CATLISTV(CATBaseUnknown_var) listParamObj = NULL;
	spKweModelServices->VisibleParms(spFristParmPublisher, listParamObj, 0);
	for (int i = 1; i <= listParamObj.Size(); i++)
	{
		CATICkeParm_var spCkeParam = listParamObj[i];
		CATUnicodeString strParamName = spCkeParam->Name();
		cout << "strParamName == " << strParamName << endl;
		cout << "spCkeParam == " << spCkeParam->Content() << endl;

		strParamName = GetRightParamName(strParamName);

		if (CATUnicodeString("中间槽机头距离") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerOtherZJCJTJL->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("中间槽机尾距离") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerZJCJWJL->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("中间槽宽") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerOtherZJCK->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("中间槽高") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerOtherZJCG->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("滚轴半径") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerOtherGZBJ->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("滚轴半径") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerOtherGZBJ->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("闸门阵列数量") == strParamName)
		{
			double iValue = _pCallTempalteDlg->_SpinnerOtherZMZLSL->GetValue();
			spCkeParam->Valuate(iValue);
		}
		else if (CATUnicodeString("闸门方向") == strParamName)
		{
			CATUnicodeString iValue(""); 
			_pCallTempalteDlg->_ComboZMFX->GetField(iValue);
			spCkeParam->Valuate(iValue);
		}
	}

	CATICkeParameterSet_var spJTParamSet = NULL_var;//机头参数
	CATICkeParameterSet_var spJWParamSet = NULL_var;//机尾参数
	CATICkeParameterSet_var spDJParamSet = NULL_var;//电机参数
	CATLISTV(CATBaseUnknown_var) listParamSetObj = NULL;
	GetDirectionParamSets(spParamSetObj, listParamSetObj);
	for (int i = 1; i <= listParamSetObj.Size(); i++)
	{
		CATICkeParameterSet* piParamSet = NULL;
		rc = listParamSetObj[i]->QueryInterface(IID_CATICkeParameterSet, (void**)&piParamSet);
		if (SUCCEEDED(rc) && (NULL != piParamSet))
		{
			CATIAlias_var spAliasName = piParamSet;
			CATUnicodeString strParamSetName = spAliasName->GetAlias();
		
			if (CATUnicodeString("机头") == strParamSetName)
			{
				spJTParamSet = piParamSet;
			}
			else if (CATUnicodeString("机尾") == strParamSetName)
			{
				spJWParamSet = piParamSet;
			}
			else if (CATUnicodeString("电机类型1（垂直轴）") == strParamSetName)
			{
				spDJParamSet = piParamSet;
			}
			piParamSet->Release(); piParamSet = NULL;
		}
	}

	CATLISTV(CATBaseUnknown_var)* plistJTParamObj = spJTParamSet->Parameters();//机头参数
	if (NULL != plistJTParamObj)
	{
		for (int i = 1; i <= plistJTParamObj->Size(); i++)
		{
			CATICkeParm_var spCkeParam = (*plistJTParamObj)[i];
			CATUnicodeString strParamName = spCkeParam->Name();

			strParamName = GetRightParamName(strParamName);
			if (CATUnicodeString("机头架长") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerHeadLength->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("机头架底面距中心线距离") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerHeadDMJZXX->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("机头架顶面与中心线距离") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerHeadD1MJZXXX->GetValue();
				spCkeParam->Valuate(iValue);
			}
		}

		delete[] plistJTParamObj; plistJTParamObj = NULL;
	}

	CATLISTV(CATBaseUnknown_var)* plistJWParamObj = spJWParamSet->Parameters();//机尾参数
	if (NULL != plistJWParamObj)
	{
		for (int i = 1; i <= plistJWParamObj->Size(); i++)
		{
			CATICkeParm_var spCkeParam = (*plistJWParamObj)[i];
			CATUnicodeString strParamName = spCkeParam->Name();

			strParamName = GetRightParamName(strParamName);
			if (CATUnicodeString("机尾架长") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerTailLength->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("机尾架底面距中心线距离") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerTailD2MJZXX->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("机尾架底座高") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerTailDZG->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("机尾架基础长") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerTailJCC->GetValue();
				spCkeParam->Valuate(iValue);
			}
		}

		delete[] plistJWParamObj; plistJWParamObj = NULL;
	}

	CATLISTV(CATBaseUnknown_var)* plistDJParamObj = spDJParamSet->Parameters();//电机参数
	if (NULL != plistDJParamObj)
	{
		for (int i = 1; i <= plistDJParamObj->Size(); i++)
		{
			CATICkeParm_var spCkeParam = (*plistDJParamObj)[i];
			CATUnicodeString strParamName = spCkeParam->Name();

			strParamName = GetRightParamName(strParamName);
			if (CATUnicodeString("电机整体长度") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerDJZTCD->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("电机直径") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerDJZJ->GetValue();
				spCkeParam->Valuate(iValue);
			}
			else if (CATUnicodeString("减速机（宽）") == strParamName)
			{
				double iValue = _pCallTempalteDlg->_SpinnerJSJK->GetValue();
				spCkeParam->Valuate(iValue);
			}
		}

		delete[] plistDJParamObj; plistDJParamObj = NULL;
	}

	CAAUpdateObject(spPartObject);
	return S_OK;
}
//更新特征
HRESULT CallEngineeringTemplateCmd::CAAUpdateObject(CATBaseUnknown_var spUpdateObjectBU)
{
	if (NULL_var == spUpdateObjectBU)
	{
		cout << "ERROR:CAAUpdateObject() - spUpdateObjectBU is NULL!" << endl;
		return E_FAIL;
	}

	CATIUseEntity *piUseEntity = NULL;
	HRESULT rc = spUpdateObjectBU->QueryInterface(IID_CATIUseEntity, (void**)&piUseEntity);
	if (SUCCEEDED(rc))
	{
		rc = DataCommonProtocolServices::Update(piUseEntity);
		if (FAILED(rc))
		{
			CATError * pError = CATError::CATGetLastError(rc);
			if (NULL != pError)
			{
				cerr << "Error message is " << pError->GetNLSMessage() << endl;
				pError->Release();
				pError = NULL;
			}
		}
		piUseEntity->Release();
		piUseEntity = NULL;
	}

	return rc;
}
//获取正确的参数名称
CATUnicodeString CallEngineeringTemplateCmd::GetRightParamName(const CATUnicodeString &istrfullParamName)
{
	int iLength = istrfullParamName.GetLengthInChar();
	if (0 == iLength) return "";

	int iStartPos = 0;
	for (int i = iLength - 1; i >= 0; i--)
	{
		CATUnicodeChar iCurrentChar = istrfullParamName[i];
		if (iCurrentChar == CATUnicodeChar('\\'))
		{
			iStartPos = i+1;
			break;
		}
	}

	CATUnicodeString strValue("");
	strValue = istrfullParamName.SubString(iStartPos, iLength - iStartPos);
	return strValue;
}
//获取参数集下所有的参数集
HRESULT CallEngineeringTemplateCmd::GetDirectionParamSets(const CATICkeParameterSet_var &ispParentSet,
	                                                      CATLISTV(CATBaseUnknown_var) &olistParamSetObj)
{
	if (NULL_var == ispParentSet) return E_FAIL;

	CATIAParameterSet* piCATIAParamSet = NULL;
	HRESULT rc = ispParentSet->QueryInterface(IID_CATIAParameterSet, (void**)&piCATIAParamSet);
	if (FAILED(rc) && (NULL != piCATIAParamSet)) return E_FAIL;

	CATIAParameterSets* piParamsSets = NULL;
	piCATIAParamSet->get_ParameterSets(piParamsSets);
	if (NULL == piParamsSets) return E_FAIL;

	piCATIAParamSet->Release(); piCATIAParamSet = NULL;

	CATLong iCount = 0;
	piParamsSets->get_Count(iCount);
	for (long i = 1; i <= iCount; i++)
	{
		//Item
		CATVariant IndexVar;
		::BuildVariant(i,IndexVar);
		CATIAParameterSet* piCurrentParmSet = NULL;
		piParamsSets->Item(IndexVar, piCurrentParmSet);
		if (NULL != piCurrentParmSet)
		{
			olistParamSetObj.Append(piCurrentParmSet);
		}
	}
	piParamsSets->Release(); piParamsSets = NULL;

	return S_OK;
}
//返回Part节点
HRESULT CallEngineeringTemplateCmd::CAAMmrGetPartFromProduct(const CATIPLMNavReference_var &ispPLMNavRef,
	                                                         CATIPLMNavRepReference_var &ospPLMRepRef,
	                                                         CATIMmiMechanicalFeature_var &ospPartFeature)

{
	HRESULT rc = E_FAIL;

	if (NULL_var == ispPLMNavRef) return E_FAIL;
	// Retrieve the first inst rep ref
	CATIPLMNavRepInstance * pNavRepInst = NULL;

	CATListPtrCATIPLMNavEntity ListNavEntity = NULL;
	CATPLMCoreType TypeRepInstance = PLMCoreRepInstance;
	ispPLMNavRef->ListChildren(ListNavEntity, 1, &TypeRepInstance);

	if (ListNavEntity.Size() >= 1)
	{
		CATIPLMNavEntity *pCurrent = ListNavEntity[1];
		rc = pCurrent->QueryInterface(IID_CATIPLMNavRepInstance, (void**)& pNavRepInst);
	}

	// Retrieve the reference of the first inst rep ref
	CATIPLMNavRepReference *pNavRepRef = NULL;
	if (NULL != pNavRepInst)
	{
		rc = pNavRepInst->GetRepReferenceInstanceOf(pNavRepRef);
		pNavRepInst->Release(); pNavRepInst = NULL;
	}

	// change the loading mode
	if (NULL != pNavRepRef)
	{
		CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
		rc = pNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&piRepLoadMode);
		if (SUCCEEDED(rc) && NULL != piRepLoadMode)
		{
			rc = piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
			piRepLoadMode->Release();
			piRepLoadMode = NULL;
		}
	}

	//Retrieve the applicative container
	CATIMmiPrtContainer * pContainer = NULL;
	if (SUCCEEDED(rc) && (NULL != pNavRepRef))
	{
		ospPLMRepRef = pNavRepRef;
		rc = pNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&pContainer);
		pNavRepRef->Release();
		pNavRepRef = NULL;
	}

	if (SUCCEEDED(rc) && (NULL != pContainer))
	{
		pContainer->GetMechanicalPart(ospPartFeature);
		pContainer->Release();
		pContainer = NULL;
	}
	return rc;
}
//打印属性信息
HRESULT CallEngineeringTemplateCmd::PrintComponentAttrs(const CATIPLMComponent_var &ispPLMComponent)
{
	if (NULL_var == ispPLMComponent) return E_FAIL;

	CATICkeObject_var spCkeObject = ispPLMComponent;
	if (NULL_var == spCkeObject) return E_FAIL;

	CATLISTV(CATUnicodeString) listAttrName;
	CATLISTV(CATUnicodeString) listAttrValue;
	CATLISTV(CATICkeParm_var)  listParamObj;
	CATCkeObjectAttrReadServices::GetListOfAttributes(spCkeObject,listAttrName,listAttrValue,listParamObj);
	for (int i = 1; i <= listAttrName.Size(); i++)
	{
		CATUnicodeString strAttrName = listAttrName[i];
		CATUnicodeString strAttrValue = listAttrValue[i];
		cout << "strAttrName == "<<strAttrName<<",strAttrValue == "<< strAttrValue << endl;
	}
	return S_OK;
}
//获取当前工作视图
void CallEngineeringTemplateCmd::Get_current_viewer(CATViewer *& pCurrentViewer)
{
	CATFrmLayout * pCurrentLayout = CATFrmLayout::GetCurrentLayout();
	if (NULL != pCurrentLayout)
	{
		CATFrmWindow * pCurrentWindow = pCurrentLayout->GetCurrentWindow();

		if (NULL != pCurrentWindow)
		{
			pCurrentViewer = pCurrentWindow->GetViewer();
		}
	}

}
HRESULT CallEngineeringTemplateCmd::InitializeMainDialog()
{
	_pCallTempalteDlg = new CallEngineeringTemplateDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
		                                               "CallEngineeringTemplateDlg");
	_pCallTempalteDlg->Build();

	//机头参数
	_pCallTempalteDlg->_SpinnerHeadLength->SetValue(1.38f);
	_pCallTempalteDlg->_SpinnerHeadDMJZXX->SetValue(0.71f);
	_pCallTempalteDlg->_SpinnerHeadD1MJZXXX->SetValue(0.4f);

	//机尾参数
	_pCallTempalteDlg->_SpinnerTailLength->SetValue(1.38f);
	_pCallTempalteDlg->_SpinnerTailD2MJZXX->SetValue(0.71f);
	_pCallTempalteDlg->_SpinnerTailDZG->SetValue(0.2f);
	_pCallTempalteDlg->_SpinnerTailJCC->SetValue(1.9f);

	//电机参数
	_pCallTempalteDlg->_SpinnerDJZTCD->SetValue(1.0f);
	_pCallTempalteDlg->_SpinnerDJZJ->SetValue(0.45f);
	_pCallTempalteDlg->_SpinnerJSJK->SetValue(0.3f);

	//其它参数
	_pCallTempalteDlg->_SpinnerOtherZJCJTJL->SetValue(0.7f);
	_pCallTempalteDlg->_SpinnerZJCJWJL->SetValue(0.6f);
	_pCallTempalteDlg->_SpinnerOtherZJCK->SetValue(1.6f);
	_pCallTempalteDlg->_SpinnerOtherZJCG->SetValue(0.85f);
	_pCallTempalteDlg->_SpinnerOtherGZBJ->SetValue(0.2f);
	_pCallTempalteDlg->_SpinnerOtherZMZLSL->SetValue(4);

	_pCallTempalteDlg->_LabelLog->SetIconName("I_ZMXALog");
	_pCallTempalteDlg->SetVisibility(CATDlgShow);
	return S_OK;
}
//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
CallEngineeringTemplateCmd::~CallEngineeringTemplateCmd()
{
	if (NULL != _pCallTempalteDlg)
	{
		_pCallTempalteDlg->RequestDelayedDestruction();
		_pCallTempalteDlg = NULL;
	}

	if (NULL != _pSelPointPathElemAgent)
	{
		_pSelPointPathElemAgent->RequestDelayedDestruction();
		_pSelPointPathElemAgent = NULL;
	}

	if (NULL != _pSelHeadPointDlgAgent)
	{
		_pSelHeadPointDlgAgent->RequestDelayedDestruction();
		_pSelHeadPointDlgAgent = NULL;
	}

	if (NULL != _pSelTailPointDlgAgent)
	{
		_pSelTailPointDlgAgent->RequestDelayedDestruction();
		_pSelTailPointDlgAgent = NULL;
	}

	_ModelBag.RemoveAll();
}


//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void CallEngineeringTemplateCmd::BuildGraph()
{
	//选择参考点
	_pSelPointPathElemAgent = new CATPathElementAgent("SelectPoint");
	_pSelPointPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot | CATDlgEngWithTooltip);
	_pSelPointPathElemAgent->SetOrderedElementType("CATIMfZeroDimResult");

	//选择机头点对话框代理
	_pSelHeadPointDlgAgent = new CATDialogAgent("HeadPointDlg");
	_pSelHeadPointDlgAgent->AcceptOnNotify(_pCallTempalteDlg->_SelectorListHeadPoint,
		                                   _pCallTempalteDlg->_SelectorListHeadPoint->GetListSelectNotification());

	//选择机尾点对话框代理
	_pSelTailPointDlgAgent = new CATDialogAgent("TailPointDlg");
	_pSelTailPointDlgAgent->AcceptOnNotify(_pCallTempalteDlg->_SelectorListTailPoint,
		                                  _pCallTempalteDlg->_SelectorListTailPoint->GetListSelectNotification());

	CATDialogState * SelectHeadPointState = GetInitialState("Please select head point");
	SelectHeadPointState->AddDialogAgent(_pSelPointPathElemAgent);
	SelectHeadPointState->AddDialogAgent(_pSelTailPointDlgAgent);

	CATDialogState * SelectTailPointState = AddDialogState("Please select tail point");
	SelectTailPointState->AddDialogAgent(_pSelPointPathElemAgent);
	SelectTailPointState->AddDialogAgent(_pSelHeadPointDlgAgent);

	//选择机头点--->选择机头点
	AddTransition(SelectHeadPointState, SelectHeadPointState,
		          IsOutputSetCondition(_pSelPointPathElemAgent),
		          Action((ActionMethod)&CallEngineeringTemplateCmd::SelectHeadPointObj));
	//选择机头点--->选择机尾点
	AddTransition(SelectHeadPointState, SelectTailPointState,
		          IsOutputSetCondition(_pSelTailPointDlgAgent),
		          Action((ActionMethod)&CallEngineeringTemplateCmd::CleanDialogAgent));

	//选择机尾点--->选择机尾点
	AddTransition(SelectTailPointState, SelectTailPointState,
		          IsOutputSetCondition(_pSelPointPathElemAgent),
		          Action((ActionMethod)&CallEngineeringTemplateCmd::SelectTailPointObj));

	//选择机尾点--->选择机头点
	AddTransition(SelectTailPointState, SelectHeadPointState,
		          IsOutputSetCondition(_pSelHeadPointDlgAgent),
		          Action((ActionMethod)&CallEngineeringTemplateCmd::CleanDialogAgent));


	//click Wndclose buttion
	AddAnalyseNotificationCB(_pCallTempalteDlg, _pCallTempalteDlg->GetWindCloseNotification(),
		                     (CATCommandMethod)&CallEngineeringTemplateCmd::ExitCmd, NULL);
	//click cancel button
	AddAnalyseNotificationCB(_pCallTempalteDlg, _pCallTempalteDlg->GetDiaCANCELNotification(),
		                   (CATCommandMethod)&CallEngineeringTemplateCmd::ExitCmd, NULL);

	//click OK button
	AddAnalyseNotificationCB(_pCallTempalteDlg, _pCallTempalteDlg->GetDiaOKNotification(),
		                    (CATCommandMethod)&CallEngineeringTemplateCmd::OKAction, NULL);

}
//exti command
void CallEngineeringTemplateCmd::ExitCmd()
{
	this->RequestDelayedDestruction();
	return;
}
//清除对话框代理
void CallEngineeringTemplateCmd::CleanDialogAgent()
{
	if (_pSelHeadPointDlgAgent->IsOutputSet())
	{
		_pSelHeadPointDlgAgent->InitializeAcquisition();
		_pCallTempalteDlg->_SelectorListTailPoint->ClearSelect();
	}
	if (_pSelTailPointDlgAgent->IsOutputSet())
	{
		_pSelTailPointDlgAgent->InitializeAcquisition();
		_pCallTempalteDlg->_SelectorListHeadPoint->ClearSelect();
	}
}
//选择机头点
void CallEngineeringTemplateCmd::SelectHeadPointObj()
{
	CATBaseUnknown* pBaseUnknown = _pSelPointPathElemAgent->GetElementValue();
	CATPathElement* pPathElem = _pSelPointPathElemAgent->GetValue();
	_pSelPointPathElemAgent->InitializeAcquisition();

	_spHeadPointObject = pBaseUnknown;


	ClearSO();
	HighlightPathElemObj(pPathElem);

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pCallTempalteDlg->_SelectorListHeadPoint;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}

	int ArraySel[1] = { 0 };
	if (NULL_var == _spTailPointObject)
	{
		_pCallTempalteDlg->_SelectorListTailPoint->SetSelect(ArraySel, 1);
	}
}
//选择机头点
void CallEngineeringTemplateCmd::SelectTailPointObj()
{
	CATBaseUnknown* pBaseUnknown = _pSelPointPathElemAgent->GetElementValue();
	CATPathElement* pPathElem = _pSelPointPathElemAgent->GetValue();
	_pSelPointPathElemAgent->InitializeAcquisition();

	_spTailPointObject = pBaseUnknown;


	ClearSO();
	HighlightPathElemObj(pPathElem);

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pCallTempalteDlg->_SelectorListTailPoint;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}

	int ArraySel[1] = { 0 };
	if (NULL_var == _spHeadPointObject)
	{
		_pCallTempalteDlg->_SelectorListHeadPoint->SetSelect(ArraySel, 1);
	}
}
//清空所有高亮
void CallEngineeringTemplateCmd::ClearSO()
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL != pFrmEditor)
	{
		CATHSO* pHSO = pFrmEditor->GetHSO();
		pHSO->Empty();
	}
}
//高亮CATPathElement对象
void CallEngineeringTemplateCmd::HighlightPathElemObj(CATBaseUnknown* pObject)
{
	CATFrmEditor* pFrmEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL != pFrmEditor)
	{
		CATHSO* pHSO = pFrmEditor->GetHSO();
		pHSO->AddElements(pObject);
		pHSO->EndAddElements();
	}
}
//printf object fullpath
void CallEngineeringTemplateCmd::PathElementString(CATPathElement * ipPath, CATUnicodeString & oPathName)
{

	oPathName = "";
	if (NULL != ipPath)
	{
		int sizeOfThePath = ipPath->GetSize();

		for (int i = sizeOfThePath - 1; i >= 0; i--)
		{
			CATBaseUnknown * pElt = (*ipPath)[i];
			if (NULL != pElt)
			{
				CATIAlias * pIAliasOnElt = NULL;
				HRESULT rc = pElt->QueryInterface(IID_CATIAlias, (void**)&pIAliasOnElt);
				if (SUCCEEDED(rc))
				{
					CATUnicodeString Name = pIAliasOnElt->GetAlias();
					oPathName.Append(Name);

					if (i > 0)
					{
						oPathName.Append("/"); ;
					}

					pIAliasOnElt->Release();
					pIAliasOnElt = NULL;
				}
			}
		}
	}
}
HRESULT CallEngineeringTemplateCmd::GetPLMObjectsFromAttrAndFromType(const CATListOfCATString &listOfAttribute,
	const CATListOfCATUnicodeString &listOfValues,
	const CATUnicodeString &iStrPLMType,
	CATListPtrCATAdpQueryResult & opQueryResults)
{
	HRESULT hr = S_OK;
	//cout << "   GetPLMObjectsFromAttrAndFromType " << endl;

	if ((0 == listOfAttribute.Size()) || (0 == listOfValues.Size())) return E_INVALIDARG;
	if (listOfAttribute.Size() != listOfValues.Size()) return E_INVALIDARG;
	if (0 < opQueryResults.Size())return E_INVALIDARG;


	int iListSize = listOfAttribute.Size();

	CATAdpAttributeSet iAttributeSet;
	//cout << "   Build an Attribute set with inputs from user, for query into db" << endl;
	int i = 1;
	while ((i <= iListSize) && (SUCCEEDED(hr)))
	{
		CATUnicodeString Name = listOfAttribute[i].CastToCharPtr();
		const CATString AttributeINPUT = CATCkePLMNavPublicServices::RetrieveBasicAttributeNameFromPreviousOne(NULL_var, Name).CastToCharPtr();
		CATUnicodeString AttrValue = listOfValues[i];

		hr = iAttributeSet.AddAttribute(AttributeINPUT, AttrValue);
		i++;
	}

	CATIType_var spTypeObj = NULL_var;
	hr = RetrievePLMType(iStrPLMType, spTypeObj);
	if (FAILED(hr) || (NULL_var == spTypeObj))
	{
		cout << "ERROR:ClsPLMUtilities::GetPLMObjectsFromAttrAndFromType()-NULL_var == spTypeObj" << endl;
		return E_FAIL;
	}


	hr = CATAdpPLMQueryServices::GetElementsFromAttributes(spTypeObj,
		iAttributeSet,
		opQueryResults);

	return hr;
}

//-------------------------------------------------------------------------
// RetrievePLMType (for DS Types and Specialization Types)
//-------------------------------------------------------------------------
HRESULT CallEngineeringTemplateCmd::RetrievePLMType(const CATUnicodeString & isPLMType, 
	                                                CATIType_var & ospType)
{
	HRESULT rc = E_INVALIDARG;
	if (isPLMType != "")
	{
		// For DS type
		rc = CATCkePLMNavPublicServices::RetrieveKnowledgeType(isPLMType, ospType);
		// For Specialization Type
		if (FAILED(rc))  rc = CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType(isPLMType, ospType);
	}
	return rc;
}
HRESULT CallEngineeringTemplateCmd::OpenUniquePLMComponent(const CATUnicodeString &istrPLMType,
	                                                       const CATUnicodeString& iPLM_ExternalIDValue,
	                                                       const CATUnicodeString& iV_versionValue,
	                                                       const IID& iIID,
	                                                       void **opiPLMComp,
	                                                       CATOmbLifeCycleRootsBag &iBag,
	                                                       CATBoolean iExpandAll)
{
	// 1. Initialize the Return Value
	HRESULT hr = E_INVALIDARG;

	// 2. Build The Attribute Set
	CATAdpAttributeSet iAttributeSet;
	CATAdpPLMQueryAttributeSet iAttributeSetForFilter;

	CATUnicodeString V_versionName = CATCkePLMNavPublicServices::GetMajorRevisionAttributeName(NULL_var).CastToCharPtr();

	// CATAdpAttributeSet is formed for the query by GetElementFromAttributes
	hr = iAttributeSet.AddAttribute("PLM_ExternalID", iPLM_ExternalIDValue);
	hr = iAttributeSet.AddAttribute(V_versionName.ConvertToChar(), iV_versionValue);

	hr = iAttributeSetForFilter.AddStringAttribute("PLM_ExternalID", iPLM_ExternalIDValue);
	hr = iAttributeSetForFilter.AddStringAttribute(V_versionName.ConvertToChar(), iV_versionValue);


	// 3. Retrieve the Type by using the input String PLM Type
	CATIType_var spCATITypeOnPLMType;
	CATBoolean bPLMType = FALSE;
	if (SUCCEEDED(hr))
	{
		hr = CATCkePLMNavPublicServices::RetrieveKnowledgeType(istrPLMType, spCATITypeOnPLMType);
		if (NULL_var == spCATITypeOnPLMType)
		{
			hr = CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType(istrPLMType, spCATITypeOnPLMType);
			if (SUCCEEDED(hr) && (NULL_var != spCATITypeOnPLMType))
			{
				bPLMType = TRUE;
				cout << "   Success CATCkePLMNavSpecializationAccessPublicServices::RetrieveSpecializationType " << (spCATITypeOnPLMType->Name()).ConvertToChar() << endl;
			}
		}
		else
		{
			bPLMType = TRUE;
			cout << "   Success CATCkePLMNavPublicAccessServices ::RetrieveKnowledgeType non Specializatio type  " << (spCATITypeOnPLMType->Name()).ConvertToChar() << endl;
		}
	}
	if (bPLMType == FALSE)
		cout << "   RetrieveSpecializationType AND RetrieveKnowledgeType are Failed, Invalid PLMType : Identify the Correct PLMType in Modeler" << endl;


	// 4. Retrieve the Element From Database by using the PLM Type and Attribute Set
	CATBoolean bMultipleElementAttrSet = FALSE;
	CATBoolean bUniqueKeyDefOnObject = TRUE;
	CATBoolean bIsUnique = TRUE;
	CATBoolean bUniqueObjectFromKey = TRUE;
	CATBoolean bMultipleElementFromQuery = FALSE;
	CATAdpPLMComponentsInfos oComponentsInfos;

	CATIAdpPLMIdentificator *piIdentOnPLMComp = NULL;

	// 4.1. Create the Filter Consists of PLMType and Attribute Set
	CATAdpPLMQueryFilter iQueryFilter(spCATITypeOnPLMType, iAttributeSetForFilter);

	// 4.2. Retrieve the Element from Database By using Filter , If Multiple elements are retrieved then Query Fails
	if (SUCCEEDED(hr)) hr = CATAdpPLMExtendedQueryServices::GetElementsFromQueryFilter(iQueryFilter, oComponentsInfos);

	if (SUCCEEDED(hr) && oComponentsInfos.Size() != 0)
	{
		if (oComponentsInfos.Size() != 1)
		{
			cout << "\n\t GetElementsFromQueryFilter Returns Multiple Elements. Please Provide Attribute For Identifying the Unique object from Database. Use PLM_EXTERNAL ID + Version" << endl;
			bMultipleElementAttrSet = TRUE;
		}
		// 4.3. Retrieve the Iterator for Attribute Set
		CATAdpPLMComponentsInfosIter iterator = oComponentsInfos.GetIterator();
		CATIAdpPLMIdentificator *oComponent = NULL;
		CATAdpPLMComponentInfos oInfos;
		CATAdpPLMComponentUniqueKey oUniqueKey;
		// 4.4. Retrieve the Attributes from iterator : Identificator of First PLM Object
		hr = iterator.NextInfos(oComponent, oInfos);

		// 4.5. Retrieve the Unique Key for PLM Object from Identificator
		if (SUCCEEDED(hr) && NULL != oComponent)
			hr = CATAdpPLMQueryServices::GetUniqueKey(oComponent, oUniqueKey);

		if (NULL != oComponent)
		{
			oComponent->Release(); oComponent = NULL;
		}

		if (FAILED(hr)) bUniqueKeyDefOnObject = FALSE;

		// 4.6. Display the Value of Unique Key
		CATUnicodeString oDisplayed;
		if (SUCCEEDED(hr))  hr = oUniqueKey.Display(oDisplayed);
		if (S_OK == hr)	 cout << "\n\t Unique Key is :" << oDisplayed.ConvertToChar() << endl;

		// 4.7. Insure the Unicity of Unique Key
		if (SUCCEEDED(hr))  hr = oUniqueKey.UnicityGuarantee();

		if (S_OK == hr)   cout << "\n\t Unicity Guranteed" << endl;
		else
		{
			cout << "\n\t Unicity of Unique Key is not Guranteed" << endl;
			bIsUnique = FALSE;
		}

		if (TRUE == bIsUnique)
		{
			CATListPtrCATIAdpPLMIdentificator oComponentsIdentifiers;
			// 4.8. Retrieve the Elements from Database by using Unique Key
			if (SUCCEEDED(hr))  hr = CATAdpPLMQueryServices::GetElementsByUniqueKey(oUniqueKey, oComponentsIdentifiers);
			// 4.9. If single element is retrieved return it, if mulitple elements are retrieved then Query Fails.
			if (SUCCEEDED(hr) && oComponentsIdentifiers.Size() != 0)  piIdentOnPLMComp = oComponentsIdentifiers[1];
			else if (oComponentsIdentifiers.Size() != 1)
			{
				cout << "\n\t GetElementsByUniqueKey Returns Multiple Elements." << endl;
				bUniqueObjectFromKey = FALSE;
			}
		}

		// 4.10. If unique Key is not implemented on the Object then Retrieve the Object By using GetElementFromAttributes
		CATListPtrCATAdpQueryResult opQueryResults;
		if (bUniqueKeyDefOnObject == FALSE || bIsUnique == FALSE)
		{
			cout << "\n\t Unique Key is not Defined on PLM Object or Unique Key is not Unique Use GetElementFromAttributes" << endl;
			hr = CATAdpPLMQueryServices::GetElementsFromAttributes(spCATITypeOnPLMType, iAttributeSet, opQueryResults);
		}

		// 4.11. If multiple elements areretrieved by above query then Query Fails  Return the identifier for first Object only
		if (SUCCEEDED(hr) && opQueryResults.Size() != 0)
		{
			CATAdpQueryResult *res = opQueryResults[1];
			if (res)
			{
				res->GetIdentifier(piIdentOnPLMComp);
				delete res;
				res = NULL;
			}

			if (opQueryResults.Size() != 1)
			{
				cout << "\n\t\t GetElementFromAttributes Returns Mulitple Elements. Use Attributes which are unique" << endl;
				bMultipleElementFromQuery = TRUE;
			}
		}
	}

	// 5. Open the Element in Session
	if (NULL != piIdentOnPLMComp)
	{
		// 5.1. Create opener dpendening on the input mode
		if (TRUE == iExpandAll)
		{
			CATAdpOpenParameters params_Auth(CATAdpExpandParameters::Authoring);
			CATAdpOpener opener_Auth(iBag, params_Auth);
			// 5.2. Open the Retrieved Component by using CATAdpOpener
			hr = opener_Auth.CompleteAndOpen(piIdentOnPLMComp, iIID, opiPLMComp);
		}
		else
		{
			CATAdpOpenParameters params_Nav(CATAdpExpandParameters::Navigation);
			CATAdpOpener opener_Nav(iBag, params_Nav);
			hr = opener_Nav.CompleteAndOpen(piIdentOnPLMComp, iIID, opiPLMComp);
		}
		piIdentOnPLMComp->Release();
		piIdentOnPLMComp = NULL;
	}


	// 5. Check for the Conditional Variable 
	if (bPLMType == FALSE || bMultipleElementAttrSet == TRUE || bUniqueObjectFromKey == FALSE || bMultipleElementFromQuery == TRUE)
		hr = E_FAIL;

	return hr;
}

HRESULT CallEngineeringTemplateCmd::OpenPLMComponent(const CATUnicodeString &istrPLMType,
	const CATListOfCATString &listAttrName,
	const CATLISTV(CATUnicodeString) &ListAttrValue,
	const IID& iIID,
	void **opiPLMComp,
	CATOmbLifeCycleRootsBag &iBag,
	CATBoolean iExpandAll)
{
	HRESULT hr = S_OK;
	if (CATUnicodeString("") == istrPLMType) return E_FAIL;
	if (0 == listAttrName.Size()) return E_FAIL;
	if (0 == ListAttrValue.Size()) return E_FAIL;

	int iListSize = listAttrName.Size();

	CATListPtrCATAdpQueryResult listQueryResult = NULL;
	hr = GetPLMObjectsFromAttrAndFromType(listAttrName, ListAttrValue, istrPLMType, listQueryResult);
	if (FAILED(hr) || (0 == listQueryResult.Size()))
	{

		cout << "ERROR:ClsPLMUtilities::OpenPLMComponent()-0 == listQueryResult.Size()" << endl;
		return hr;
	}

	CATIAdpPLMIdentificator* piAdpPLMIdentificator = NULL;
	listQueryResult[1]->GetIdentifier(piAdpPLMIdentificator);
	if (NULL == piAdpPLMIdentificator)
	{
		cout << "ERROR:ClsPLMUtilities::OpenPLMComponent()-NULL == piAdpPLMIdentificator" << endl;
		return E_FAIL;
	}

	if (TRUE == iExpandAll)
	{
		CATAdpOpenParameters params_Auth(CATAdpExpandParameters::Authoring);
		CATAdpOpener opener_Auth(iBag, params_Auth);
		// 5.2. Open the Retrieved Component by using CATAdpOpener
		hr = opener_Auth.CompleteAndOpen(piAdpPLMIdentificator, iIID, opiPLMComp);
	}
	else
	{
		CATAdpOpenParameters params_Nav(CATAdpExpandParameters::OneLevelRepresentations);
		CATAdpOpener opener_Nav(iBag, params_Nav);
		hr = opener_Nav.CompleteAndOpen(piAdpPLMIdentificator, iIID, opiPLMComp);
	}
	piAdpPLMIdentificator->Release();
	piAdpPLMIdentificator = NULL;

	return S_OK;
}
//OK Action
void CallEngineeringTemplateCmd::OKAction()
{
	if (NULL_var == _spHeadPointObject)
	{
		DisplayMessage("Warning", "Please select head point!","Warning");
		return;
	}
	if (NULL_var == _spTailPointObject)
	{
		DisplayMessage("Warning", "Please select tail point!", "Warning");
		return;
	}
	if (NULL_var == _spParentOcurr)
	{
		DisplayMessage("Warning", "Get parent occurrence failed!", "Warning");
		return;
	}
	
	CATIPLMNavReference* piProdRef = NULL;
	_spParentOcurr->GetRelatedReference(piProdRef);
	if (NULL == piProdRef)
	{
		DisplayMessage("Error", "Get parent reference product failed!", "Error");
		return;
	}
	CATIPLMNavReference_var spProdRef = piProdRef;
	piProdRef->Release(); piProdRef = NULL;

	//1:打开EKL模板
	CATLISTV(CATString)        listAttrName;
	CATLISTV(CATUnicodeString) listAttrValue;
	listAttrName.Append("PLM_ExternalID");
	listAttrValue.Append(_strTemplateID);

	CATOmbLifeCycleRootsBag Bag;
	CATBoolean authoringMode = TRUE;
	CATIPLMNavReference* piProductRef = NULL;
	OpenPLMComponent("VPMReference", listAttrName, listAttrValue,
		IID_CATIPLMNavReference, (void**)&piProductRef, Bag, authoringMode);
	if (NULL == piProductRef)
	{
		DisplayMessage("Error","打开EKL模板失败,请检查配置文件!","ERROR");
		return;
	}

	//调用EKL action
	CATBaseUnknown_var spActionBUObj = NULL_var;
	GetKnowledgeAction(piProductRef, _strActionName, spActionBUObj);
	if (NULL_var == spActionBUObj)
	{
		DisplayMessage("Error","获取EKL模板中的Action失败!", "ERROR");
		return;
	}

	CATICkeFunction_var spCkeActionFunc = spActionBUObj;
	if (NULL_var == spCkeActionFunc)
	{
		cout << "ERROR:PSTCUPSCmd::OKAction()-NULL_var == spCkeActionFunc" << endl;
		return;
	}

	CATICkeParmFactory_var spCkeParmFactory = CATCkeGlobalFunctions::GetVolatileFactory();
	if (NULL_var == spCkeParmFactory)
	{
		cout << "ERROR:CallEngineeringTemplateCmd::OKAction()-NULL_var == spCkeParmFactory" << endl;
		return;
	}
	CATLISTV(CATBaseUnknown_var) listCkeParamObj = NULL;
	CATICkeParm_var spParentRefCkeParam = spCkeParmFactory->CreateObjectReference(spProdRef);
	if (NULL_var == spParentRefCkeParam)
	{
		cout << "ERROR:CallEngineeringTemplateCmd::OKAction()-NULL_var == spParentRefCkeParam" << endl;
		return;
	}
	CATICkeParm_var spHeadPtCkeParam = spCkeParmFactory->CreateObjectReference(_spHeadPointObject);
	if (NULL_var == spHeadPtCkeParam)
	{
		cout << "ERROR:CallEngineeringTemplateCmd::OKAction()-NULL_var == spHeadPtCkeParam" << endl;
		return;
	}
	CATICkeParm_var spTailPtCkeParam = spCkeParmFactory->CreateObjectReference(_spTailPointObject);
	if (NULL_var == spTailPtCkeParam)
	{
		cout << "ERROR:CallEngineeringTemplateCmd::OKAction()-NULL_var == spTailPtCkeParam" << endl;
		return;
	}
	listCkeParamObj.Append(spParentRefCkeParam);
	listCkeParamObj.Append(spHeadPtCkeParam);
	listCkeParamObj.Append(spTailPtCkeParam);

	CATIType_var hProductType = NULL_var;
	CATITypeDictionary_var hTypeDictionary = CATGlobalFunctions::GetTypeDictionary();
	if (NULL_var != hTypeDictionary)
	{
		CATUnicodeString TypeName = "VPMReference";
		hTypeDictionary->FindType(TypeName, hProductType);
	}

	CATICkeParm_var spResultParam = NULL_var;
	if (NULL_var != hProductType)
	{
		spResultParam = spCkeParmFactory->CreateObjectReference(hProductType,"VPMReference");
	}
	
	
	listCkeParamObj.Append(spResultParam);


	CATICkeParm_var spReturnedParm = NULL_var;	
	spCkeActionFunc->Run(&listCkeParamObj, spReturnedParm, NULL);

	spResultParam = listCkeParamObj[4];
	if (NULL_var != spResultParam)
	{
		CATICkeInst_var spCkeInstance = spResultParam->Value();
		if (NULL_var != spCkeInstance)
		{
			CATBaseUnknown_var spResultObject = spCkeInstance->AsObject();
			if (NULL_var != spResultObject)
			{
				ModifyPartParams(spResultObject);
			}
		}
	}

	this->RequestDelayedDestruction();
	return;

}
//获取EKL中的Action
HRESULT CallEngineeringTemplateCmd::GetKnowledgeAction(const CATIPLMNavReference_var &ispParentNavRef,
	                                                   const CATUnicodeString &istrActionName,
	                                                   CATBaseUnknown_var &ospActionBUObj)
{
	if (NULL_var == ispParentNavRef) return E_FAIL;

	CATIPLMNavRepReference_var spKnowledgeRepRef = NULL_var;

	CATPLMCoreType  FilterPLMType = PLMCoreRepInstance;
	CATLISTP(CATIPLMNavEntity)  listRepInsChild = NULL;
	ispParentNavRef->ListChildren(listRepInsChild, 1, &FilterPLMType);
	for (int i = 1; i <= listRepInsChild.Size(); i++)
	{
		CATIPLMNavRepInstance_var spRepInstance = listRepInsChild[i];
		if (NULL_var == spRepInstance) continue;

		CATIPLMNavRepReference* piRepReference = NULL;
		spRepInstance->GetRepReferenceInstanceOf(piRepReference);
		if (NULL != piRepReference)
		{
			CATIPLMComponent_var spPLMComponent = piRepReference;

			CATUnicodeString strPLMType("");
			RetrieveComponentType(spPLMComponent, strPLMType);
			if (CATUnicodeString("Knowledgeware") == strPLMType)
			{
				spKnowledgeRepRef = piRepReference;
			}
			piRepReference->Release(); piRepReference = NULL;
		}

		if (NULL_var != spKnowledgeRepRef) break;
	}

	if (NULL_var == spKnowledgeRepRef) return E_FAIL;

	CATIKweModelServices_var spKweModelServices = CATCkeGlobalFunctions::GetModelServices();
	if (NULL_var == spKweModelServices) return E_FAIL;

	HRESULT rc = E_FAIL;
	CATIParmPublisher_var spParmPublisher = spKnowledgeRepRef;
	if (NULL_var != spParmPublisher)
	{
		CATLISTV(CATBaseUnknown_var) listCkeFuncObjs = NULL;
		spKweModelServices->VisibleRelations(spParmPublisher, listCkeFuncObjs, 1);
		for (int i = 1; i <= listCkeFuncObjs.Size(); i++)
		{
			CATBaseUnknown_var spActionBUObj = listCkeFuncObjs[i];
			CATIAlias_var spAliasName = spActionBUObj;
			CATUnicodeString strAliasName = spAliasName->GetAlias();
			if (istrActionName == strAliasName)
			{
				rc = S_OK;
				ospActionBUObj = spActionBUObj;
				break;
			}
		}
	}

	return rc;
}

//get PLMComponent type
HRESULT CallEngineeringTemplateCmd::RetrieveComponentType(const CATBaseUnknown_var &ispPLMObject,
	                                                      CATUnicodeString &ostrType)
{
	if (NULL_var == ispPLMObject)
	{
		cout << "ERROR:RetrieveComponentType()-NULL_var == ispPLMObject" << endl;
		return E_FAIL;
	}

	CATIPLMComponent_var spPLMComponent = ispPLMObject;
	if (NULL_var == spPLMComponent)
	{
		cout << "ERROR:RetrieveComponentType()-NULL_var == spPLMComponent" << endl;
		return E_FAIL;
	}
	//Type
	CATIAdpType *piAdpType = NULL;
	HRESULT rc = spPLMComponent->GetAdpType(piAdpType);
	if (FAILED(rc) || NULL == piAdpType)
	{
		cout << "ERROR:RetrieveComponentType()-NULL == piAdpType" << endl;
		return E_FAIL;
	}
	CATUnicodeString strProductTypeValue("");
	CATIType *piCkeType = NULL;
	rc = CATPLMTypeServices::GetKweTypeFromAdpType(piAdpType, piCkeType);
	if (SUCCEEDED(rc))
	{
		CATUnicodeString CurrentCustoName = piCkeType->Name();
		//cout << "Current Type Name is :" << CurrentCustoName.ConvertToChar() << endl;

		//CATUnicodeString CurrentUserName = piCkeType->UserName();
		//cout << "Current User Name is :" << CurrentUserName.ConvertToChar() << endl;
		ostrType = CurrentCustoName;

		piAdpType->Release();
		piAdpType = NULL;

		piCkeType->Release();
		piCkeType = NULL;
	}

	return rc;
}