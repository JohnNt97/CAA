//===================================================================
// COPYRIGHT atoz 2021/02/04
//===================================================================
// ATOZPipeProjAnnoCmd.cpp
// Header definition of class ATOZPipeProjAnnoCmd
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2021/02/04 Creation: Code generated by the 3DS wizard
//===================================================================

#include "ATOZPipeProjAnnoCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( ATOZPipeProjAnnoCmd);


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
ATOZPipeProjAnnoCmd::ATOZPipeProjAnnoCmd() :
	CATStateCommand("ATOZPipeProjAnnoCmd", CATDlgEngOneShot, CATCommandModeShared)
	//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
	, _pATOZPipeProjAnnoDlg(NULL)
	, _pBrowserViewsDlg(NULL)
	, _pSelDrwPathElemAgent(NULL)
	, _pSelProdPathElemAgent(NULL)
	, _pSelLinePathElemAgent(NULL)
	, _pSelDrwObjDlgAgent(NULL)
	, _pSelPipeObjDlgAgent(NULL)
	, _pSelLine1ObjDlgAgent(NULL)
	, _pSelLine2ObjDlgAgent(NULL)
	, _spTargetDrwRef(NULL_var)
	, _spOnSheet(NULL_var)
	, _spPipeProd(NULL_var)
	, _spPipeProdRef(NULL_var)
	, _spMecFeatureLine1(NULL_var)
	, _spMecFeatureLine2(NULL_var)
	, _spRepOccur1(NULL_var)
	, _spRepOccur2(NULL_var)
	, _handled(false)
	, _viewcount(0)
{
	HRESULT rc = InitializeMainDialog();
	if (FAILED(rc))
	{
		this->RequestDelayedDestruction();
		return;
	}

	RetrieveRootProd(_spRootNavRef);
}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
ATOZPipeProjAnnoCmd::~ATOZPipeProjAnnoCmd()
{
	if (!_handled)
		HandleGSMSet();

	_listOfGSMTool.RemoveAll();

	if (NULL != _pSelLine2ObjDlgAgent)
	{
		_pSelLine2ObjDlgAgent->RequestDelayedDestruction();
		_pSelLine2ObjDlgAgent = NULL;
	}

	if (NULL != _pSelLine1ObjDlgAgent)
	{
		_pSelLine1ObjDlgAgent->RequestDelayedDestruction();
		_pSelLine1ObjDlgAgent = NULL;
	}
	if (NULL != _pSelPipeObjDlgAgent)
	{
		_pSelPipeObjDlgAgent->RequestDelayedDestruction();
		_pSelPipeObjDlgAgent = NULL;
	}

	if (NULL != _pSelDrwObjDlgAgent)
	{
		_pSelDrwObjDlgAgent->RequestDelayedDestruction();
		_pSelDrwObjDlgAgent = NULL;
	}

	if (NULL != _pSelLinePathElemAgent)
	{
		_pSelLinePathElemAgent->RequestDelayedDestruction();
		_pSelLinePathElemAgent = NULL;
	}

	if (NULL != _pSelProdPathElemAgent)
	{
		_pSelProdPathElemAgent->RequestDelayedDestruction();
		_pSelProdPathElemAgent = NULL;
	}

	if (NULL != _pSelDrwPathElemAgent)
	{
		_pSelDrwPathElemAgent->RequestDelayedDestruction();
		_pSelDrwPathElemAgent = NULL;
	}

	if (NULL != _pBrowserViewsDlg)
	{
		_pBrowserViewsDlg->RequestDelayedDestruction();
		_pBrowserViewsDlg = NULL;
	}

	if (NULL != _pATOZPipeProjAnnoDlg)
	{
		_pATOZPipeProjAnnoDlg->RequestDelayedDestruction();
		_pATOZPipeProjAnnoDlg = NULL;
	}
}

HRESULT ATOZPipeProjAnnoCmd::InitializeMainDialog()
{
	_pATOZPipeProjAnnoDlg = new ATOZPipeProjAnnoDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
		"ATOZPipeProjAnnoDlg");

	_pATOZPipeProjAnnoDlg->Build();

	_pATOZPipeProjAnnoDlg->_SelectorListDrw->SetLine("No Selection");
	_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->SetLine("No Selection");
	_pATOZPipeProjAnnoDlg->_SelectorListLine1->SetLine("No Selection");
	_pATOZPipeProjAnnoDlg->_SelectorListLine2->SetLine("No Selection");

	/*CATDlgMultiList* pDlgMultiSelList = _pATOZPipeProjAnnoDlg->_MultiListProds;

	pDlgMultiSelList->ClearLine();

	pDlgMultiSelList->SetColumnItem(1, "生成图纸");
	_pATOZPipeProjAnnoDlg->_MultiListProds->SetColumnItem(1, "序号");*/


	int ArraySel[1] = { 0 };
	_pATOZPipeProjAnnoDlg->_SelectorListDrw->SetSelect(ArraySel, 1);

	_pATOZPipeProjAnnoDlg->SetVisibility(CATDlgShow);
	return S_OK;

	//一定考虑内存清理 跳转时可能会强制关闭命令
}

//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void ATOZPipeProjAnnoCmd::BuildGraph()
{
	/*_pSelDrwPathElemAgent = new CATPathElementAgent("SelectDrw");
	_pSelDrwPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot | CATDlgEngWithTooltip);
	_pSelDrwPathElemAgent->AddElementType(IID_CATIPLMNavRepOccurrence);*/

	_pSelDrwPathElemAgent = new CATOtherDocumentAgent("SelectDrwRep", "CATBasicMultiDocumentCommand", "CATDialogEngine", NULL,
		CATDlgEngWithPrevaluation | CATDlgEngWithPSOHSO);
	_pSelDrwPathElemAgent->SetOrderedElementType("CATIPLMNavRepOccurrence");
	_pSelDrwPathElemAgent->AddOrderedElementType("CATIDftDrawing");

	CATAcquisitionFilter * pFilterForDrwRep = Filter((FilterMethod)&ATOZPipeProjAnnoCmd::SetFilterForDrwRep, (void*)NULL);
	_pSelDrwPathElemAgent->SetFilter(pFilterForDrwRep);

	_pSelProdPathElemAgent = new CATPathElementAgent("SelectProd");
	_pSelProdPathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot );
	_pSelProdPathElemAgent->AddElementType(IID_CATIPLMRepInstances);

	CATAcquisitionFilter * pFilterForProduct = Filter((FilterMethod)&ATOZPipeProjAnnoCmd::SetFilterForProduct, (void*)NULL);
	_pSelProdPathElemAgent->SetFilter(pFilterForProduct);

	_pSelLinePathElemAgent = new CATPathElementAgent("SelectProd");
	_pSelLinePathElemAgent->SetBehavior(CATDlgEngWithPSOHSO | CATDlgEngWithPrevaluation | CATDlgEngOneShot | CATDlgEngWithTooltip);
	_pSelLinePathElemAgent->AddElementType("CATIMfLine");



	_pSelDrwObjDlgAgent = new CATDialogAgent("SelDrwObjDlgAgent");
	_pSelDrwObjDlgAgent->AcceptOnNotify(_pATOZPipeProjAnnoDlg->_SelectorListDrw,
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->GetListSelectNotification());

	_pSelPipeObjDlgAgent = new CATDialogAgent("SelPipeDlgAgent");
	_pSelPipeObjDlgAgent->AcceptOnNotify(_pATOZPipeProjAnnoDlg->_SelectorListPipeProd,
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->GetListSelectNotification());

	_pSelLine1ObjDlgAgent = new CATDialogAgent("SelLine1DlgAgent");
	_pSelLine1ObjDlgAgent->AcceptOnNotify(_pATOZPipeProjAnnoDlg->_SelectorListLine1,
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->GetListSelectNotification());

	_pSelLine2ObjDlgAgent = new CATDialogAgent("SelLine2DlgAgent");
	_pSelLine2ObjDlgAgent->AcceptOnNotify(_pATOZPipeProjAnnoDlg->_SelectorListLine2,
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->GetListSelectNotification());


	CATDialogState * SelectDrwObjState = GetInitialState("SelDrwObjState");
	SelectDrwObjState->AddDialogAgent(_pSelDrwPathElemAgent);
	SelectDrwObjState->AddDialogAgent(_pSelPipeObjDlgAgent);
	SelectDrwObjState->AddDialogAgent(_pSelLine1ObjDlgAgent);
	SelectDrwObjState->AddDialogAgent(_pSelLine2ObjDlgAgent);

	CATDialogState * SelectPipeObjState = AddDialogState("SelectPipeObjState");
	SelectPipeObjState->AddDialogAgent(_pSelProdPathElemAgent);
	SelectPipeObjState->AddDialogAgent(_pSelDrwObjDlgAgent);
	SelectPipeObjState->AddDialogAgent(_pSelLine1ObjDlgAgent);
	SelectPipeObjState->AddDialogAgent(_pSelLine2ObjDlgAgent);

	CATDialogState * SelectLine1ObjState = AddDialogState("SelLine1State");
	SelectLine1ObjState->AddDialogAgent(_pSelLinePathElemAgent);
	SelectLine1ObjState->AddDialogAgent(_pSelDrwObjDlgAgent);
	SelectLine1ObjState->AddDialogAgent(_pSelPipeObjDlgAgent);
	SelectLine1ObjState->AddDialogAgent(_pSelLine2ObjDlgAgent);

	CATDialogState * SelectLine2ObjState = AddDialogState("SelLine2State");
	SelectLine2ObjState->AddDialogAgent(_pSelLinePathElemAgent);
	SelectLine2ObjState->AddDialogAgent(_pSelDrwObjDlgAgent);
	SelectLine2ObjState->AddDialogAgent(_pSelPipeObjDlgAgent);
	SelectLine2ObjState->AddDialogAgent(_pSelLine1ObjDlgAgent);

	//transition 1
	AddTransition(SelectDrwObjState, SelectDrwObjState,
		IsOutputSetCondition(_pSelDrwPathElemAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::SelectDrwObj));

	AddTransition(SelectDrwObjState, SelectPipeObjState,
		IsOutputSetCondition(_pSelPipeObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectDrwObjState, SelectLine1ObjState,
		IsOutputSetCondition(_pSelLine1ObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectDrwObjState, SelectLine2ObjState,
		IsOutputSetCondition(_pSelLine2ObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	//transition 2
	AddTransition(SelectPipeObjState, SelectPipeObjState,
		IsOutputSetCondition(_pSelProdPathElemAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::SelectPipeObj));

	AddTransition(SelectPipeObjState, SelectDrwObjState,
		IsOutputSetCondition(_pSelDrwObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectPipeObjState, SelectLine1ObjState,
		IsOutputSetCondition(_pSelLine1ObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectPipeObjState, SelectLine2ObjState,
		IsOutputSetCondition(_pSelLine2ObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	//transition 3
	AddTransition(SelectLine1ObjState, SelectLine1ObjState,
		IsOutputSetCondition(_pSelLinePathElemAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::SelectLine1));

	AddTransition(SelectLine1ObjState, SelectDrwObjState,
		IsOutputSetCondition(_pSelDrwObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectLine1ObjState, SelectPipeObjState,
		IsOutputSetCondition(_pSelPipeObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectLine1ObjState, SelectLine2ObjState,
		IsOutputSetCondition(_pSelLine2ObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	//transition 4
	AddTransition(SelectLine2ObjState, SelectLine2ObjState,
		IsOutputSetCondition(_pSelLinePathElemAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::SelectLine2));

	AddTransition(SelectLine2ObjState, SelectDrwObjState,
		IsOutputSetCondition(_pSelDrwObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectLine2ObjState, SelectPipeObjState,
		IsOutputSetCondition(_pSelPipeObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	AddTransition(SelectLine2ObjState, SelectLine1ObjState,
		IsOutputSetCondition(_pSelLine1ObjDlgAgent),
		Action((ActionMethod)&ATOZPipeProjAnnoCmd::CleanDialogAgent));

	//视图预览
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg->_PushButtonBrowseView,
		_pATOZPipeProjAnnoDlg->_PushButtonBrowseView->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::BroweView, NULL);


	//生成视图
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg->_ButtonGenView,
		_pATOZPipeProjAnnoDlg->_ButtonGenView->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::GenerateView, NULL);

	//打开工程图
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg->_ButtonOpen,
		_pATOZPipeProjAnnoDlg->_ButtonOpen->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::OpenDrwRef, NULL);

	//打开工程图
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg->_PushButtonDelete,
		_pATOZPipeProjAnnoDlg->_PushButtonDelete->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::BatDelete, NULL);


	//click OK button
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg,
		_pATOZPipeProjAnnoDlg->GetDiaOKNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::OKAction, NULL);

	//click Wndclose buttion
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg,
		_pATOZPipeProjAnnoDlg->GetWindCloseNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::ExitCmd, NULL);

	//click cancel button
	AddAnalyseNotificationCB(_pATOZPipeProjAnnoDlg,
		_pATOZPipeProjAnnoDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::ExitCmd, NULL);

}

CATBoolean ATOZPipeProjAnnoCmd::SetFilterForProduct(CATDialogAgent * iAgent, void * iUsefulData)
{
	CATBoolean ret = FALSE;
	if (NULL != iAgent)
	{
		CATBaseUnknown * pSelectedElt = ((CATPathElementAgent *)iAgent)->GetElementValue();
		if (NULL != pSelectedElt)
		{
			CATIPLMNavOccurrence* pIPrdOcc = NULL;
			HRESULT rc = pSelectedElt->QueryInterface(IID_CATIPLMNavOccurrence, (void **)& pIPrdOcc);
			if (SUCCEEDED(rc) && NULL != pIPrdOcc)
			{
				//cout << "is a CATIPLMNavOccurrence" << endl;
				CATIPLMNavReference* pRef(NULL);
				pIPrdOcc->GetRelatedReference(pRef);
				if (NULL != pRef)
				{
					CATBoolean IsPart(TRUE);
					Check3DPart(pRef, IsPart);
					if (!IsPart)
					{
						CATIPLMNavRepReference* pRepRef(NULL);
						if (FAILED(pRef->QueryInterface(IID_CATIPLMNavRepReference, (void**)&pRepRef)))
							ret = TRUE;
						else
							ret = FALSE;
					}
					else
						ret = FALSE;

					pRef->Release(); pRef = NULL;
				}
				//else cout << "can't get Ref" << endl;

				pIPrdOcc->Release();
				pIPrdOcc = NULL;
			}
			//else cout << "not a CATIPLMNavOccurrence" << endl;
		}
	}

	return ret;
}

CATBoolean ATOZPipeProjAnnoCmd::SetFilterForDrwRep(CATDialogAgent * iAgent, void * iUsefulData)
{
	CATBoolean ret = FALSE;
	if (NULL != iAgent)
	{
		CATBaseUnknown * pSelectedElt = ((CATPathElementAgent *)iAgent)->GetElementValue();
		if (NULL != pSelectedElt)
		{
			CATIPLMNavRepInstance* piRepIns(NULL);
			HRESULT rc = pSelectedElt->QueryInterface(IID_CATIPLMNavRepInstance, (void **)& piRepIns);
			if (SUCCEEDED(rc) && NULL != piRepIns)
			{
				CATIPLMNavRepReference* pRepRef(NULL);
				piRepIns->GetRepReferenceInstanceOf(pRepRef);
				if (NULL != pRepRef)
				{
					CATBoolean IsDrw(TRUE);

					CATIPsiRepresentationReference_var spRepRef = pRepRef;
					if (NULL_var != spRepRef)
					{
						CATUnicodeString type("");
						spRepRef->GetMainDataType(type);
						//cout << "GetMainDataType is " << type << endl;

						if(CATUnicodeString("CATDrawing") == type)
							ret = TRUE;
						/*else
							ret = FALSE;*/

					}

					pRepRef->Release(); pRepRef = NULL;
				}


				piRepIns->Release();
				piRepIns = NULL;
			}
			else{
				cout << "not instance" << endl;
				CATIDftDrawing* piDrawing(NULL);
				rc = pSelectedElt->QueryInterface(IID_CATIDftDrawing, (void **)& piDrawing);
				if (SUCCEEDED(rc) && NULL != piDrawing) {
					ret = TRUE;
					piDrawing->Release(); piDrawing = NULL;
				}
					
			}

		}
	}

	return ret;
}

void ATOZPipeProjAnnoCmd::CleanDialogAgent()
{
	if (_pSelDrwObjDlgAgent->IsOutputSet())
	{
		_pSelDrwObjDlgAgent->InitializeAcquisition();
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->ClearSelect();

	}
	if (_pSelPipeObjDlgAgent->IsOutputSet())
	{
		_pSelPipeObjDlgAgent->InitializeAcquisition();
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->ClearSelect();
	}

	if (_pSelLine1ObjDlgAgent->IsOutputSet())
	{
		_pSelLine1ObjDlgAgent->InitializeAcquisition();
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->ClearSelect();
	}

	if (_pSelLine2ObjDlgAgent->IsOutputSet())
	{
		_pSelLine2ObjDlgAgent->InitializeAcquisition();
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->ClearSelect();
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->ClearSelect();
	}

}

void ATOZPipeProjAnnoCmd::OKAction()
{
	this->RequestDelayedDestruction();
	return;
}

void ATOZPipeProjAnnoCmd::ExitCmd()
{
	this->RequestDelayedDestruction();
	return;
}

void ATOZPipeProjAnnoCmd::SelectDrwObj()
{

	CATPathElement* pPathElem = _pSelDrwPathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = pPathElem->GetCurrentObject();
	_pSelDrwPathElemAgent->InitializeAcquisition();

	ClearSO();
	HighlightPathElemObj(pPathElem);

	CATIPLMNavRepOccurrence_var spTargetDrw = pBaseUnknown;

	CATIDftDrawing *pDrwRoot(NULL);

	if (NULL_var != spTargetDrw) {

		//获取工程图
		CATIPLMNavRepReference* opRepReference(NULL);
		spTargetDrw->GetRelatedRepReference(opRepReference);

		_spTargetDrwRef = opRepReference;
		opRepReference->Release(); opRepReference = NULL;


		CATIPsiRepresentationReference* pPsiRepRef(NULL);
		_spTargetDrwRef->QueryInterface(IID_CATIPsiRepresentationReference, (void**)&pPsiRepRef);
		if (NULL != pPsiRepRef)
		{
			CATIPsiRepresentationLoadMode *piRepLoadMode = NULL;
			if (pPsiRepRef &&SUCCEEDED(pPsiRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)& piRepLoadMode)))
			{
				piRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
				piRepLoadMode->Release(); piRepLoadMode = NULL;
			}

			CATDftDrawingPLMServices::GetDrawingRoot(pPsiRepRef, &pDrwRoot);
			pPsiRepRef->Release(); pPsiRepRef = NULL;

			if (NULL == pDrwRoot)
			{
				cout << "获取CATIDftDrawing 失败" << endl;
				return;
			}
			else
				cout << "获取到CATIDftDrawing" << endl;
		}

	}
	else if (CATIDftDrawing_var(pBaseUnknown) != NULL_var) {
		pBaseUnknown->QueryInterface(IID_CATIDftDrawing, (void**)&pDrwRoot);
		CATIPsiRepresentationReference* pPsiRepRef(NULL);
		CATDftDrawingPLMServices::GetDrawingRepresentation(pDrwRoot, &pPsiRepRef);
		_spTargetDrwRef = pPsiRepRef;
		pPsiRepRef->Release(); pPsiRepRef = NULL;
	}
	else
		return;


	CATUnicodeString strSelectedDrwName("");
	strSelectedDrwName = CATIAlias_var(_spTargetDrwRef)->GetAlias();

	CATDlgSelectorList* pDlgSelList = _pATOZPipeProjAnnoDlg->_SelectorListDrw;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strSelectedDrwName);
	}
	

	CATIDftSheet *piSheet(NULL);
	pDrwRoot->GetActiveSheet(&piSheet);
	if (NULL != piSheet) {
		cout << "使用默认图纸" << endl;
		_spOnSheet = piSheet;
		piSheet->Release(); piSheet = NULL;
	}

	if (NULL_var == _spOnSheet) {
		//获取第一张图纸并打开
		CATIUnknownList* pUnknownList = NULL;
		pDrwRoot->GetSheets(&pUnknownList);
		if (NULL == pUnknownList) {
			cout << "GetSheets NULL == pUnknownList" << endl;
			return;
		}

		unsigned int iSheetCounts(0);
		pUnknownList->Count(&iSheetCounts);
		if (0 == iSheetCounts) {
			::DisplayMessage("Error", "工程图未找到图纸!", "ERROR");
			return;
		}

		for (int i = 0; i < iSheetCounts; i++)
		{
			IUnknown* pSheetUnknown = NULL;
			pUnknownList->Item(i, &pSheetUnknown);
			if (NULL == pSheetUnknown) continue;

			CATIDftSheet* piDftSheet = NULL;
			pSheetUnknown->QueryInterface(IID_CATIDftSheet, (void**)&piDftSheet);
			if (NULL != piDftSheet)
			{
				_spOnSheet = piDftSheet;
				piDftSheet->Release(); piDftSheet = NULL;
				break;
			}
			pSheetUnknown->Release(); pSheetUnknown = NULL;
		}
		pUnknownList->Release(); pUnknownList = NULL;
		pDrwRoot->Release(); pDrwRoot = NULL;

		if (NULL_var != _spOnSheet)
			cout << "获取图纸成功" << endl;
		else
			::DisplayMessage("Error", "获取图纸失败!", "ERROR");
	}
	else
		cout << "使用当前工作图纸" << endl;

	

	
	if (NULL_var == _spPipeProd)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spMecFeatureLine1)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spMecFeatureLine2)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->SetSelect(ArraySel, 1);
	}
}

void ATOZPipeProjAnnoCmd::SelectPipeObj()
{
	CATPathElement* pPathElem = _pSelProdPathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = pPathElem->GetCurrentObject();
	_pSelProdPathElemAgent->InitializeAcquisition();

	ClearSO();
	HighlightPathElemObj(pPathElem);

	_spPipeProd = pBaseUnknown;
	if (NULL_var == _spPipeProd)
	{
		::DisplayMessage("Error", "未获取装配体!", "ERROR");
		return;
	}

	CATIPLMNavReference *piProdRef(NULL);
	_spPipeProd->GetRelatedReference(piProdRef);
	if (NULL != piProdRef) {
		_spPipeProdRef = piProdRef;
		piProdRef->Release(); piProdRef = NULL;
	}

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZPipeProjAnnoDlg->_SelectorListPipeProd;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}

	//遍历装配体，生成管道中心线
	CATListPtrCATIPLMNavOccurrence ChildrenList; //装配体下的管道实例列表

	BrowseOccurrences(_spPipeProd, ChildrenList);

	const int SIZE = ChildrenList.Size();
	CATIPLMNavOccurrence_var spChildOuc(NULL_var);
	for (int i = 1; i <= SIZE; i++) //遍历处理管道实例
	{
		spChildOuc = ChildrenList[i];

		//获取管道实例
		CATIPipPipeInstance_var spPipeInstance = spChildOuc;
		if(NULL_var == spPipeInstance){
			cout << "spPipeInstance null" << endl;
			continue;
		}

		//获取管道所属reference
		CATIPLMNavReference* pPartRef(NULL);
		spChildOuc->GetRelatedReference(pPartRef);
		CATIPLMNavReference_var spPiePartRef(NULL_var);
		spPiePartRef = pPartRef;
		if (NULL_var == spPiePartRef){
			cout << "spPiePartRef null" << endl;
			return;
		}
		pPartRef->Release(); pPartRef = NULL;

		//创建几何图形集、中心线 并添加到几何图形集列表中
		CrtLinesPtsUnderPipe(spPipeInstance, spPiePartRef, _listOfGSMTool);

	}
	


	//对话框跳转
	if (NULL_var == _spTargetDrwRef)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spMecFeatureLine1)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spMecFeatureLine2)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->SetSelect(ArraySel, 1);
	}
}

//递归遍历所有occurrence
HRESULT ATOZPipeProjAnnoCmd::BrowseOccurrences(CATIPLMNavOccurrence_var &spPLMNavOccOnCurrentNode, CATListPtrCATIPLMNavOccurrence &ChildrenList)
{

	if (NULL_var == spPLMNavOccOnCurrentNode)
	{
		return E_INVALIDARG;
	}

	//
	// Now browse the child components
	//
	CATListPtrCATIPLMNavOccurrence ListChildOccurrences;
	HRESULT rc = spPLMNavOccOnCurrentNode->ListChildren(ListChildOccurrences);
	if (SUCCEEDED(rc))
	{
		int i = 1;
		while (SUCCEEDED(rc) && (i <= ListChildOccurrences.Size()))
		{
			CATIPLMNavOccurrence_var spCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL_var != spCurrentChildOccurrence)
			{
				cout << "BrowseOccurrences :" << CATIAlias_var(spCurrentChildOccurrence)->GetAlias() << endl;
				CATIPLMNavInstance *piInstance(NULL);

				if (NULL_var != CATIPipPipeInstance_var(spCurrentChildOccurrence))
					ChildrenList.Append(spCurrentChildOccurrence);
				
				rc = BrowseOccurrences(spCurrentChildOccurrence, ChildrenList);
			}

			CATIPLMNavOccurrence * pCurrentChildOccurrence = ListChildOccurrences[i];
			if (NULL != pCurrentChildOccurrence)
			{
				pCurrentChildOccurrence->Release();
				pCurrentChildOccurrence = NULL;
			}

			i++;
		}
	}

	return rc;
}


void ATOZPipeProjAnnoCmd::SelectLine1()
{
	CATPathElement* pPathElem = _pSelLinePathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = pPathElem->GetCurrentObject();
	_pSelLinePathElemAgent->InitializeAcquisition();

	ClearSO();
	HighlightPathElemObj(pPathElem);

	_spMecFeatureLine1 = pBaseUnknown;

	//获取所属RepIns
	_spRepOccur1 = pPathElem->FindElement(IID_CATIPLMNavRepOccurrence);
	
	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZPipeProjAnnoDlg->_SelectorListLine1;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}


	if (NULL_var == _spTargetDrwRef)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spPipeProd)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spMecFeatureLine2)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->SetSelect(ArraySel, 1);
	}
	else
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine2->SetSelect(ArraySel, 1);
	}
}

void ATOZPipeProjAnnoCmd::SelectLine2()
{
	CATPathElement* pPathElem = _pSelLinePathElemAgent->GetValue();
	CATBaseUnknown* pBaseUnknown = pPathElem->GetCurrentObject();
	_pSelLinePathElemAgent->InitializeAcquisition();

	ClearSO();
	HighlightPathElemObj(pPathElem);

	_spMecFeatureLine2 = pBaseUnknown;

	//获取所属RepIns
	_spRepOccur2 = pPathElem->FindElement(IID_CATIPLMNavRepOccurrence);

	CATUnicodeString strFullPath("");
	PathElementString(pPathElem, strFullPath);

	CATDlgSelectorList* pDlgSelList = _pATOZPipeProjAnnoDlg->_SelectorListLine2;
	if (NULL != pDlgSelList)
	{
		pDlgSelList->ClearLine();
		pDlgSelList->SetLine(strFullPath);
	}


	if (NULL_var == _spTargetDrwRef)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListDrw->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spPipeProd)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListPipeProd->SetSelect(ArraySel, 1);
	}
	else if (NULL_var == _spMecFeatureLine1)
	{
		int ArraySel[1] = { 0 };
		_pATOZPipeProjAnnoDlg->_SelectorListLine1->SetSelect(ArraySel, 1);
	}
}

void ATOZPipeProjAnnoCmd::GenerateView()
{
	if (NULL_var == _spTargetDrwRef) {
		::DisplayMessage("Error", "请选择工程图!", "ERROR");
		return;
	}
	if (NULL_var == _spOnSheet) {
		::DisplayMessage("Error", "未获取图纸!", "ERROR");
		return;
	}
	if (NULL_var == _spPipeProd) {
		::DisplayMessage("Error", "请选择管路装配体!", "ERROR");
		return;
	}

	if (NULL_var == _spMecFeatureLine1) {
		::DisplayMessage("Error", "请选择管段线1!", "ERROR");
		return;
	}
	if (NULL_var == _spMecFeatureLine2) {
		::DisplayMessage("Error", "请选择管段线2!", "ERROR");
		return;
	}
	HRESULT rc(S_OK);


	//投影
	CATIPrdObject_var spTest = _spPipeProd;
	CATBaseUnknown_var _spBUProd(NULL_var);
	if (NULL_var != spTest)
	{
		CATBaseUnknown* result(NULL);
		if (SUCCEEDED(spTest->GetReferenceObject(result)))
		{
			_spBUProd = result;
			result->Release(); result = NULL;
		}
	}

	CATOmbObjectInContext * OmbObjCtx = NULL;
	CATIPrdObject_var spPrdObjOnRoot(_spBUProd);
	if (NULL_var != spPrdObjOnRoot)
	{
		CATListPtrCATIPLMComponent ComponentList; //empty list, Product is a 3D Part, not several levels
		if (FAILED(CATOmbObjectInContext::CreateObjectInContext(ComponentList, NULL, spPrdObjOnRoot, OmbObjCtx)))
			cout << "CreateObjectInContext rc failed" << endl;
	}

	//投影前隐藏
	/*const int SIZE = _listOfGSMTool.Size();
	for (int i = 1; i <= SIZE; i++) {
		CATIMmiMechanicalFeature_var spGSMTool = _listOfGSMTool[i];
		rc = HideSpecGeoTool(spGSMTool, true);
	}*/


	//创建投影
	if (OmbObjCtx) {
		cout << "OIC创建成功" << endl;
		
		CATIUnknownListImpl * ListImpl = new CATIUnknownListImpl();
		CATIUnknownList* ListOmbLink = NULL;

		ListOmbLink = ListImpl;
		if (ListOmbLink == NULL)
		{
			cout << "ListOmbLink == NULL" << endl;
			return;
		}
		ListOmbLink->Add(0, (IUnknown*)OmbObjCtx);  //ListOmbLink->Add(0, (IUnknown*)OmbObjCtx);


		CATIDftGenViewFactory_var spDftGenViewFact = _spOnSheet;
		CATIDftView *piDftFrontView = NULL;
		if (ListOmbLink)
		{
			// Defines the view anchor point
			double ptOrigin[2] = { 350.0,250.0 };

			// Defines the view style
			CATUnicodeString  viewStyle = " ";
			rc = spDftGenViewFact->CreateFrontView(ptOrigin, _FrontviewPlane, ListOmbLink, &piDftFrontView, viewStyle);
			if (piDftFrontView)
			{
				++_viewcount;
				cout << "The Front view is correclty created" << endl;
				piDftFrontView->Release(); piDftFrontView = NULL;
			}
			ListOmbLink->Release(); ListOmbLink = NULL;
		}
	}

	//重新显示中心线
	/*for (int i = 1; i <= SIZE; i++) {
		CATIMmiMechanicalFeature_var spGSMTool = _listOfGSMTool[i];
		rc = HideSpecGeoTool(spGSMTool, false);
	}
	*/


}

void ATOZPipeProjAnnoCmd::OpenDrwRef()
{
	//打开工程图并关闭命令
	if (NULL_var == _spTargetDrwRef)
	{
		::DisplayMessage("Error", "未选择目标工程图!", "ERROR");
		return;
	}

	//对几何图形集进行删除或隐藏
	if (!_handled)
	{
		HandleGSMSet();
		_listOfGSMTool.RemoveAll();
		_handled = true;
	}

	::OpenObjInSession(_spTargetDrwRef);

	CAAUpdateObject(_spTargetDrwRef);

	this->RequestDelayedDestruction();
	return;
}

//===================================================管道中心线生成即处理===================================================================

void ATOZPipeProjAnnoCmd::HandleGSMSet()
{
	return; //目前关闭批量隐藏几何图形集
	const int SIZE = _listOfGSMTool.Size();
	for (int i = 1; i <= SIZE; i++) {
		CATBaseUnknown_var spGSMTool = _listOfGSMTool[i];
		DeleteAnything(spGSMTool);
	}
}

//创建线段（中心线）
HRESULT ATOZPipeProjAnnoCmd::CreateCenterLines(CATIGSMUseFactory_var &spGSMFactory, CATLISTV(CATIMmiMechanicalFeature_var) &iGuidePoints, CATIMmiMechanicalFeature_var &ispGSMTool)
{
	HRESULT rc(S_OK);

	const int SIZE = iGuidePoints.Size();
	CATIMmiMechanicalFeature_var spStrPoint(NULL_var);
	CATIMmiMechanicalFeature_var spEndPoint(NULL_var);
	for (int i = 1; i <= SIZE - 1; i++)
	{
		spStrPoint = iGuidePoints[i];
		spEndPoint = iGuidePoints[i + 1];
		CATIGSMUseLinePtPt_var spOnLine = spGSMFactory->CreateLine(spStrPoint, spEndPoint);


		CATIGSMUseProceduralView_var ispProcView = spOnLine;
		if (NULL_var != ispProcView)
		{
			rc = ispProcView->InsertInProceduralView(ispGSMTool);
			if (FAILED(rc))
			{
				cout << "\nERROR Problem append the extrude surface feature in the part body set!!" << endl;
				return  E_FAIL;
			}

			CATIUseEntity_var hUseEnt(spOnLine);
			if (!!hUseEnt)
			{
				// update the extrude surface feature
				rc = DataCommonProtocolServices::Update(hUseEnt);
				if (FAILED(rc))
				{
					cout << "\nERROR Problem to update the extrude surface feature : DataCommonProtocolServices::Update KO!" << endl;
					return  E_FAIL;
				}

				// Display the name of extruded surface feature 
				// --------------------------------------------
				CATIAlias_var spAliasExtrudeFeature = spOnLine;

				CATIVisProperties_var spLineProp = spOnLine;
				if (NULL_var != spLineProp)
				{
					CATVisPropertiesValues iValues;
					iValues.SetLineType(4);
					iValues.SetColor(0, 255, 0);
					//CATVisPropertyType iPropertyType = CATVPLineType;
					//CATVisGeomType  iGeomType = CATVPGlobalType;
					//如果无效就只改变颜色

					rc = spLineProp->SetPropertiesAtt(iValues, CATVPAllPropertyType, CATVPLine);
				}
			}
		}
		else return E_FAIL;

	}

	return S_OK;
}


//Copy 

HRESULT ATOZPipeProjAnnoCmd::CopyObjectIntoSpecGeoTool(CATIMmiMechanicalFeature_var  spGeometryTool, CATBaseUnknown_var ispSelSketchReferPlaneBU, CATIMmiMechanicalFeature_var &ospResult)
{
	HRESULT rc(E_FAIL);
	CATIMmiUseCreateImport* pCreateImport = NULL;
	CATMmiUseServicesFactory::CreateMmiUseCreateImport(pCreateImport);

	pCreateImport->SetObject(ispSelSketchReferPlaneBU);
	pCreateImport->SetLinkMode(FALSE);
	pCreateImport->SetTarget(spGeometryTool);//a mechanical part, solid or surfacic feature set 

	CATIMmiMechanicalFeature_var spResult(NULL_var);
	pCreateImport->Run(spResult);
	if (NULL_var == spResult)
	{
		return E_FAIL;
	}
	ospResult = spResult;

	return S_OK;
}

//隐藏或显示几何图形集
HRESULT ATOZPipeProjAnnoCmd::HideSpecGeoTool(CATIMmiMechanicalFeature_var &spGeometryTool, bool hide)
{
	HRESULT rc(S_OK);
	CATIVisProperties *piVisP(NULL);
	rc = spGeometryTool->QueryInterface(IID_CATIVisProperties, (void**)&piVisP);
	if (FAILED(rc) || piVisP == NULL)
	{
		return E_FAIL;
	}

	CATVisPropertiesValues Attribut;

	if(hide)
		Attribut.SetShowAttr(CATNoShowAttr);
	else
		Attribut.SetShowAttr(CATShowAttr);

	rc = piVisP->SetPropertiesAtt(Attribut, CATVPShow, CATVPGlobalType, 0, 0);
	if (FAILED(rc))
	{
		return E_FAIL;
	}
	piVisP->Release();
	piVisP = NULL;
	CATIModelEvents *piME(NULL);
	rc = spGeometryTool->QueryInterface(IID_CATIModelEvents, (void **)&piME);
	if (FAILED(rc) || piME == NULL)
	{
		return E_FAIL;
	}
	CATModifyVisProperties notif(spGeometryTool, CATPathElement(spGeometryTool), CATVPGlobalType, CATVPShow, Attribut);
	piME->Dispatch(notif);

	//Redraw
	CATIRedrawEvent_var pRedraw(NULL_var);
	rc = piME->QueryInterface(IID_CATIRedrawEvent, (void **)&pRedraw);
	if (FAILED(rc) || NULL_var == pRedraw)
	{
		return E_FAIL;
	}
	pRedraw->Redraw();
	piME->Release();
	piME = NULL;


	return rc;
}



//在管道inst下创建中心线
HRESULT ATOZPipeProjAnnoCmd::CrtLinesPtsUnderPipe(CATIPipPipeInstance_var &ispPipeInst, 
			CATIPLMNavReference_var &ispPipeRef,
			CATLISTV(CATIMmiMechanicalFeature_var) &_ilistOfGSMTool)
{
	if (NULL_var == ispPipeInst || NULL_var == ispPipeRef)
	{
		cout << "NULL_var == ispPipeInst || NULL_var == ispPipeRef" << endl;
		return E_FAIL;
	}


	CATIMmiMechanicalFeature_var spGSMTool; //几何图形集 每个管道零件下各有一个
	CATLISTV(CATIMmiMechanicalFeature_var) guidePoints;
	CATIGSMUseFactory_var spGSMFactory(NULL_var);

	CATIPLMNavRepReference_var spRepRef(NULL_var);
	::GetPartRepRef(ispPipeRef, spRepRef);
	if (NULL_var == spRepRef)
	{
		cout << "GetPartRepRef failed, CATIPLMNavRepReference_var NULL" << endl;
		return E_FAIL;
	}

	//获取CATIMmiPrtContainer 用于创建图形集
	CATIMmiPrtContainer_var spPrtCont(NULL_var);
	CATIMmiPrtContainer *piPrtCont = NULL;
	spRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void**)&piPrtCont);
	if (NULL == piPrtCont)
	{
		cout << "RetrieveApplicativeContainer failed: CATIMmiPrtContainer null" << endl;
		return E_FAIL;
	}
	spPrtCont = piPrtCont;
	piPrtCont->Release(); piPrtCont = NULL;
	spGSMFactory = spPrtCont;

	CATIMmiMechanicalFeature_var spMechFeatOnMainTool = NULL_var;
	spPrtCont->GetMechanicalPart(spMechFeatOnMainTool);
	CATIMmiUseSetFactory_var spMechanicalRootFactory = spPrtCont;

	//判断是否已经存在几何图形集，若存在，跳过
	CATIMmiUsePrtPart_var spPrtPart = spMechFeatOnMainTool;
	CATIMmiMechanicalFeature_var spGsmToolTag(NULL_var);
	::CAAGsiGetGeometricFeatureSets(spPrtPart, "管道中心线", spGsmToolTag);
	if (NULL_var != spGsmToolTag) {
		cout << "已存在中心线几何图形集" << endl;
		return S_OK;
	}

	//创建几何图形集
	spMechanicalRootFactory->CreateGeometricalSet("管道中心线", spMechFeatOnMainTool, spGSMTool);
	_ilistOfGSMTool.Append(spGSMTool);

	//获取几何工厂
	if (NULL_var == spGSMFactory)
	{
		cout << "NULL_var == spGSMFactory" << endl;
		return E_FAIL;
	}

	//生成中心点与中心线
	//CATBaseUnknown *pIUnkPipeRef = NULL;
	//ispPipeInst->GetReference(pIUnkPipeRef);
	//if (NULL != pIUnkPipeRef)
	//{
	//	CATIPipRigidPipeReference_var hPipRigidRef;
	//	hPipRigidRef = pIUnkPipeRef;
	//	if (NULL_var != hPipRigidRef)
	//	{
	//		//引导点
	//		CATLISTV(CATIMmiMechanicalFeature_var) listOfFeat;
	//		hPipRigidRef->GetAllPoints(listOfFeat);
	//		const int SIZE = listOfFeat.Size();
	//		CATIMmiMechanicalFeature_var spPoint(NULL_var);
	//		for (int i = 1; i <= SIZE; i++)
	//		{
	//			spPoint = listOfFeat[i];
	//			CATIMmiMechanicalFeature_var spcopied(NULL_var);
	//			ATOZPipeProjAnnoCmd::CopyObjectIntoSpecGeoTool(spGSMTool, spPoint, spcopied);
	//			guidePoints.Append(spcopied);
	//		}

	//		CreateCenterLines(spGSMFactory, guidePoints, spGSMTool);

	//	}

	//	pIUnkPipeRef->Release(); pIUnkPipeRef = NULL;
	//}

	if (NULL_var != ispPipeRef)
	{
		CATIPipRigidPipeReference_var hPipRigidRef;
		hPipRigidRef = ispPipeRef;
		if (NULL_var != hPipRigidRef)
		{
			//引导点
			CATLISTV(CATIMmiMechanicalFeature_var) listOfFeat;
			hPipRigidRef->GetAllPoints(listOfFeat);
			const int SIZE = listOfFeat.Size();
			CATIMmiMechanicalFeature_var spPoint(NULL_var);
			for (int i = 1; i <= SIZE; i++)
			{
				spPoint = listOfFeat[i];
				CATIMmiMechanicalFeature_var spcopied(NULL_var);
				ATOZPipeProjAnnoCmd::CopyObjectIntoSpecGeoTool(spGSMTool, spPoint, spcopied);
				guidePoints.Append(spcopied);
			}

			CreateCenterLines(spGSMFactory, guidePoints, spGSMTool);

		}

	}

	return S_OK;

}



//===========================================================获取平面投影================================================

//通过两个线来找到三个点来创建投影平面
HRESULT ATOZPipeProjAnnoCmd::GetProjectionPoints(CATIMmiMechanicalFeature_var &iline1,
												CATIMmiMechanicalFeature_var &iline2,
												vector<CATMathPoint> &ovecMathPts)
{
	if (NULL_var == iline1 || NULL_var == iline2)
	{
		cout << "NULL_var == iline1 || NULL_var == iline2" << endl;
		return E_FAIL;
	}

	CATIGSMUseLinePtPt_var line1 = iline1;
	CATIGSMUseLinePtPt_var line2 = iline2;
	if (iline1 == NULL_var || line2 == NULL_var) {
		cout << "CATIGSMUseLinePtPt_var null" << endl;
		return E_FAIL;
	}

	//管段线1处理
	CATIMmiMechanicalFeature_var spLine1Pt1(NULL_var), spLine1Pt2(NULL_var);
	line1->GetFirstPoint(spLine1Pt1);
	line1->GetSecondPoint(spLine1Pt2);
	CATPoint_var spPt11 = spLine1Pt1;
	CATPoint_var spPt12 = spLine1Pt2;
	
	//转化为全局坐标
	CATMathTransformation oAbsTransMatric1;

	CATIPLMNavOccurrence  *opFather1(NULL);
	_spRepOccur1->GetFather(opFather1);
	CATIMovable_var spMovable(NULL_var);
	spMovable = opFather1;
	if (NULL_var != spMovable)
		spMovable->GetAbsPosition(oAbsTransMatric1);

	CATMathPoint mathPt11, mathPt12;
	mathPt11 = spPt11->GetMathPoint();
	mathPt12 = spPt12->GetMathPoint();

	CATMathPoint translated11 = oAbsTransMatric1*mathPt11;
	CATMathPoint translated12 = oAbsTransMatric1*mathPt12;

	if (NULL != opFather1){
		opFather1->Release(); opFather1 = NULL;
	}

	//管段线2处理
	CATIMmiMechanicalFeature_var spLine2Pt1(NULL_var), spLine2Pt2(NULL_var);
	line2->GetFirstPoint(spLine2Pt1);
	line2->GetSecondPoint(spLine2Pt2);
	CATPoint_var spPt21 = spLine2Pt1;
	CATPoint_var spPt22 = spLine2Pt2;
	
	//转化为全局坐标
	CATMathTransformation oAbsTransMatric2;

	CATIPLMNavOccurrence  *opFather2(NULL);
	_spRepOccur2->GetFather(opFather2);
	CATIMovable_var spMovable2(NULL_var);
	spMovable2 = opFather2;
	if (NULL_var != spMovable2)
		spMovable2->GetAbsPosition(oAbsTransMatric2);

	CATMathPoint mathPt21, mathPt22;
	mathPt21 = spPt21->GetMathPoint();
	mathPt22 = spPt22->GetMathPoint();

	CATMathPoint translated21 = oAbsTransMatric2*mathPt21;
	CATMathPoint translated22 = oAbsTransMatric2*mathPt22;

	if (NULL != opFather2) {
		opFather2->Release(); opFather2 = NULL;
	}


	//找出三点
	vector<CATMathPoint> vecMathPts{ translated11, translated12, translated21, translated22 };

	if (FAILED(FindThreePoints(vecMathPts, ovecMathPts)))
	{
		cout << "FindThreePoints failed" << endl;
		return E_FAIL;
	}
	
	return S_OK;

	//必须确保选中的两条线段存在交点

}

//判断点是否重合
bool ATOZPipeProjAnnoCmd::isSamePt(const CATMathPoint &mathPt1, const CATMathPoint &mathPt2)
{

	double Cord1[3]{};
	double Cord2[3]{};
	mathPt1.GetCoord(Cord1);
	mathPt2.GetCoord(Cord2);
	
	for (int i = 0; i < 3; i++) {
			if (!dequals(Cord1[i], Cord2[i]))
				return false;
	}
	
	return true;
}

//找到可创建平面的3个点
HRESULT ATOZPipeProjAnnoCmd::FindThreePoints(vector<CATMathPoint> &ivecAbsMathPts, //输入4个点
	vector<CATMathPoint> &ovecMathPts)
{
	//注意，此函数未处理四点不在同一平面的情况

	//找到三个不同的点
	int ThirdPoint(0);

	for (int i = 2; i < 4; i++) 
		//找到第三个点
		if ((!isSamePt(ivecAbsMathPts[i], ivecAbsMathPts[0])) && (!isSamePt(ivecAbsMathPts[i], ivecAbsMathPts[1])))
			if (NotInLine(ivecAbsMathPts[0], ivecAbsMathPts[1], ivecAbsMathPts[i]))
				ThirdPoint = i;
	
	//没有找到第三个点
	if (0 == ThirdPoint) {
		cout << "未找到第三个点" << endl;
		return E_FAIL;
	}
	
	ovecMathPts.push_back(ivecAbsMathPts[0]);
	ovecMathPts.push_back(ivecAbsMathPts[1]);
	ovecMathPts.push_back(ivecAbsMathPts[ThirdPoint]);

	int fourthPoint(0);
	//测试第四点
	if (ThirdPoint == 2) 
		fourthPoint = 3;
	else 
		fourthPoint = 2;
	

	CATMathPlane testPlane(ivecAbsMathPts[0], ivecAbsMathPts[1], ivecAbsMathPts[ThirdPoint]);
	
	const double distance = testPlane.DistanceTo(ivecAbsMathPts[fourthPoint]);

	const double EPS = 1e-5;
	if(distance < EPS)
		return S_OK;
	else {
		::DisplayMessage("Error", "两条中心线不能组成一个平面!", "ERROR");
		return E_FAIL;
	}
}

//判断三点是否在同一直线上
bool ATOZPipeProjAnnoCmd::NotInLine(CATMathPoint &iMathPt1, CATMathPoint &iMathPt2, CATMathPoint &iMathPt3)
{
	cout << "point 1" << iMathPt1.GetX() << " " << iMathPt1.GetY() << " " << iMathPt1.GetZ() << endl;
	cout << "point 2" << iMathPt2.GetX() << " " << iMathPt2.GetY() << " " << iMathPt2.GetZ() << endl;
	cout << "point 3" << iMathPt3.GetX() << " " << iMathPt3.GetY() << " " << iMathPt3.GetZ() << endl;

	CATBoolean isPara =
		CATMathVector(iMathPt2.GetX() - iMathPt1.GetX(), iMathPt2.GetY() - iMathPt1.GetY(), iMathPt2.GetZ() - iMathPt1.GetZ()).IsParallel(CATMathVector(iMathPt3.GetX() - iMathPt1.GetX(), iMathPt3.GetY() - iMathPt1.GetY(), iMathPt3.GetZ() - iMathPt1.GetZ()));
	if (isPara) {
		cout << "三点为一直线" << endl;
		return false;
	}
	else {
		cout << "三点不在一条直线" << endl;
		return true;
	}
		
}

//===========================================================视图预览================================================
void ATOZPipeProjAnnoCmd::BroweView()
{
	if (NULL_var == _spTargetDrwRef) {
		::DisplayMessage("Error", "请选择工程图!", "ERROR");
		return;
	}
	if (NULL_var == _spOnSheet) {
		::DisplayMessage("Error", "未获取图纸!", "ERROR");
		return;
	}

	if (NULL_var == _spMecFeatureLine1) {
		::DisplayMessage("Error", "请选择管段线1!", "ERROR");
		return;
	}
	if (NULL_var == _spMecFeatureLine2) {
		::DisplayMessage("Error", "请选择管段线2!", "ERROR");
		return;
	}

	//获取投影平面
	vector<CATMathPoint> vecMathPts;
	if (FAILED(GetProjectionPoints(_spMecFeatureLine1, _spMecFeatureLine2, vecMathPts)))
	{
		::DisplayMessage("Error", "获取平面失败!", "ERROR");
		return;
	}

	_FrontviewPlane = CATMathPlane(vecMathPts[0], vecMathPts[1], vecMathPts[2]);

	//_BrowserViewsDlg
	if (NULL == _pBrowserViewsDlg)
	{
		_pBrowserViewsDlg = new BrowserViewsDlg((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
			"BrowserViewsDlg");
		_pBrowserViewsDlg->Build();
		_pBrowserViewsDlg->SetFather(this);
		_pBrowserViewsDlg->SetVisibility(CATDlgShow);
	}

	//_pBrowserViewsDlg->_Navi3DViewer->GetMain3DViewpoint();
	
	if (NULL_var != _spPipeProdRef)
	{

		CATIPrdOccurrenceMngt* piOccurrMngt = NULL;
		if (SUCCEEDED(CATPrdGetOccurrenceMngt(piOccurrMngt)) && piOccurrMngt)
		{
			CATIPLMNavOccurrence_var spPrdOccurr = NULL_var;
			piOccurrMngt->GetOrCreateRootOccurrence(_spPipeProdRef, spPrdOccurr);
			if (NULL_var != spPrdOccurr)
			{
				CATFrmEditor * pEditor = CATFrmEditor::GetCurrentEditor();
				CATVisManager * pVisuManager = CATVisManager::GetVisManager();
				CATCommand * pCommandSelector = (CATCommand*)pEditor->GetCommandSelector();
				list<IID> ListIVisu3d;
				IID visu3d = IID_CATI3DGeoVisu;
				ListIVisu3d.fastadd(&visu3d);
				CATPathElement*  pRootObjectPath = new CATPathElement(spPrdOccurr);
				CATViewpoint*  pModelViewPoint = (CATViewpoint*)&(_pBrowserViewsDlg->_Navi3DViewer->GetMain3DViewpoint());
				HRESULT rc = pVisuManager->AttachTo(pRootObjectPath, pModelViewPoint, ListIVisu3d, pCommandSelector);

				_pBrowserViewsDlg->_Navi3DViewer->Draw();
				_pBrowserViewsDlg->_Navi3DViewer->Reframe();
			}

			piOccurrMngt->Release(); piOccurrMngt = NULL;
		}
	}

	ModifyViewPoint(_pBrowserViewsDlg->_Navi3DViewer,_FrontviewPlane);


	//反转视图
	AddAnalyseNotificationCB(_pBrowserViewsDlg->_PushButtonReverse,
		_pBrowserViewsDlg->_PushButtonReverse->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::ReverseView,
		NULL);

	//顺15
	AddAnalyseNotificationCB(_pBrowserViewsDlg->_PushButtonR30,
		_pBrowserViewsDlg->_PushButtonR30->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::RightHandRotation,
		NULL);

	//顺90
	AddAnalyseNotificationCB(_pBrowserViewsDlg->_PushButtonR90,
		_pBrowserViewsDlg->_PushButtonR90->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::RightHandRotation_90Degrees,
		NULL);

	//逆15
	AddAnalyseNotificationCB(_pBrowserViewsDlg->_PushButtonL30,
		_pBrowserViewsDlg->_PushButtonL30->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::LeftHandRotation,
		NULL);

	//逆90
	AddAnalyseNotificationCB(_pBrowserViewsDlg->_PushButtonL90,
		_pBrowserViewsDlg->_PushButtonL90->GetPushBActivateNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::LeftHandRotation_90Degrees,
		NULL);

	AddAnalyseNotificationCB(_pBrowserViewsDlg,
		_pBrowserViewsDlg->GetDiaCLOSENotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::ExitBrowserDlg,
		NULL);
	AddAnalyseNotificationCB(_pBrowserViewsDlg,
		_pBrowserViewsDlg->GetWindCloseNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::ExitBrowserDlg,
		NULL);
	AddAnalyseNotificationCB(_pBrowserViewsDlg,
		_pBrowserViewsDlg->GetDiaOKNotification(),
		(CATCommandMethod)&ATOZPipeProjAnnoCmd::ClickOKOnBrowserDlg,
		NULL);

}

void ATOZPipeProjAnnoCmd::ModifyViewPoint(CAT3DViewer* p3DViewer, CATMathPlane ProjectMathPlane)
{
	if (NULL == p3DViewer) return;

	CATMathVector XMathVector;
	CATMathVector YMathVector;
	CATMathVector ZMathVector;
	CATMathPoint OriginMathPt(0, 0, 0);

	OriginMathPt = ProjectMathPlane.GetOrigin();
	XMathVector = ProjectMathPlane.GetFirstDirection();
	YMathVector = ProjectMathPlane.GetSecondDirection();
	ZMathVector = ProjectMathPlane.GetNormal();


	CAT3DViewpoint &vp3d = p3DViewer->GetMain3DViewpoint();

	CATMathVector SightVector = -ZMathVector;
	vp3d.SetSightDirection(CATMathDirectionf(SightVector.GetX(),
		SightVector.GetY(),
		SightVector.GetZ()));
	vp3d.SetUpDirection(CATMathDirectionf(YMathVector.GetX(),
		YMathVector.GetY(),
		YMathVector.GetZ()));

	vp3d.SetProjectionType(CYLINDRIC);

	p3DViewer->Reframe();

	_FrontviewPlane = ProjectMathPlane;

}

void ATOZPipeProjAnnoCmd::ReverseView()
{
	CATMathPlane FrontProjPlane;
	RetrieveProjectPlane(_pBrowserViewsDlg->_Navi3DViewer, FrontProjPlane);

	CATMathVector XMathVector;
	CATMathVector YMathVector;
	CATMathVector ZMathVector;
	CATMathPoint OriginMathPt(0, 0, 0);

	OriginMathPt = FrontProjPlane.GetOrigin();
	XMathVector = FrontProjPlane.GetFirstDirection();
	YMathVector = FrontProjPlane.GetSecondDirection();
	ZMathVector = FrontProjPlane.GetNormal();

	CATMathVector NewYMathVector = -YMathVector;
	CATMathPlane NewFrontPlane(OriginMathPt, XMathVector, NewYMathVector);

	ModifyViewPoint(_pBrowserViewsDlg->_Navi3DViewer, NewFrontPlane);
}

//获取viewpoint的投影平面
HRESULT ATOZPipeProjAnnoCmd::RetrieveProjectPlane(CAT3DViewer* p3DViewer,
	CATMathPlane &oProjectPlane)
{
	if (NULL == p3DViewer) return E_FAIL;

	//获取正视图信息
	CAT3DViewpoint &vp3d = p3DViewer->GetMain3DViewpoint();
	CATMathPointf OriginMathPtf = vp3d.GetOrigin();
	const CATMathDirectionf &vpSightDirection = vp3d.GetSightDirection();
	const CATMathDirectionf &vpUpDirection = vp3d.GetUpDirection();

	CATMathPoint OriginMathPt;
	OriginMathPtf.GetValue(OriginMathPt);

	CATMathDirection SecondMathDir;
	vpUpDirection.GetValue(SecondMathDir);

	CATMathDirection ZAxisMathDir;
	vpSightDirection.GetValue(ZAxisMathDir);
	ZAxisMathDir = -ZAxisMathDir;

	CATMathDirection FristMathDir = SecondMathDir^ZAxisMathDir;

	CATMathPlane ComputedMathPlane(OriginMathPt, FristMathDir, SecondMathDir);

	oProjectPlane = ComputedMathPlane;
	return S_OK;
}

void ATOZPipeProjAnnoCmd::RightHandRotation_90Degrees()
{
	double iAngle = CATPI / 2;
	RightRotationByDegree(iAngle);
}
//顺时针旋转
void ATOZPipeProjAnnoCmd::RightHandRotation()
{
	double iAngle = CATPI / 12;
	RightRotationByDegree(iAngle);
}
void ATOZPipeProjAnnoCmd::RightRotationByDegree(double RotateAngle)
{
	CATMathPlane FrontProjPlane;
	RetrieveProjectPlane(_pBrowserViewsDlg->_Navi3DViewer, FrontProjPlane);

	CATMathVector XMathVector;
	CATMathVector YMathVector;
	CATMathVector ZMathVector;
	CATMathPoint OriginMathPt(0, 0, 0);

	OriginMathPt = FrontProjPlane.GetOrigin();
	XMathVector = FrontProjPlane.GetFirstDirection();
	YMathVector = FrontProjPlane.GetSecondDirection();
	ZMathVector = FrontProjPlane.GetNormal();

	CATMathLine ZAxisMathLine(OriginMathPt, ZMathVector);
	CATMathTransformation TransRotate(RotateAngle, ZAxisMathLine);
	XMathVector = TransRotate*XMathVector;
	YMathVector = TransRotate*YMathVector;

	CATMathPlane NewFrontPlane(OriginMathPt, XMathVector, YMathVector);
	ModifyViewPoint(_pBrowserViewsDlg->_Navi3DViewer, NewFrontPlane);

}

void ATOZPipeProjAnnoCmd::LeftHandRotation()
{
	double iAngle = -CATPI / 12;
	LeftRotationByDegree(iAngle);

}
void ATOZPipeProjAnnoCmd::LeftHandRotation_90Degrees()
{
	double iAngle = -CATPI / 2;
	LeftRotationByDegree(iAngle);

}
void ATOZPipeProjAnnoCmd::LeftRotationByDegree(double RotateAngle)
{
	CATMathPlane FrontProjPlane;
	RetrieveProjectPlane(_pBrowserViewsDlg->_Navi3DViewer, FrontProjPlane);

	CATMathVector XMathVector;
	CATMathVector YMathVector;
	CATMathVector ZMathVector;
	CATMathPoint OriginMathPt(0, 0, 0);

	OriginMathPt = FrontProjPlane.GetOrigin();
	XMathVector = FrontProjPlane.GetFirstDirection();
	YMathVector = FrontProjPlane.GetSecondDirection();
	ZMathVector = FrontProjPlane.GetNormal();

	CATMathLine ZAxisMathLine(OriginMathPt, ZMathVector);
	CATMathTransformation TransRotate(RotateAngle, ZAxisMathLine);
	XMathVector = TransRotate*XMathVector;
	YMathVector = TransRotate*YMathVector;

	CATMathPlane NewFrontPlane(OriginMathPt, XMathVector, YMathVector);
	ModifyViewPoint(_pBrowserViewsDlg->_Navi3DViewer, NewFrontPlane);

}


void ATOZPipeProjAnnoCmd::ExitBrowserDlg()
{
	_pBrowserViewsDlg->RequestDelayedDestruction();
	_pBrowserViewsDlg = NULL;
}
void ATOZPipeProjAnnoCmd::ClickOKOnBrowserDlg()
{


	_pBrowserViewsDlg->RequestDelayedDestruction();
	_pBrowserViewsDlg = NULL;
}


//
void ATOZPipeProjAnnoCmd::BatDelete()
{
	RecursiveDelete(_spRootNavRef);
}

HRESULT ATOZPipeProjAnnoCmd::RecursiveDelete(CATIPLMNavReference *ipNavRef)
{
	HRESULT hr = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			hr = S_OK;
			CATIPLMNavEntity * pChild = NULL;
			for (int j = 1; j <= nbChildren; j++)
			{
				CATBaseUnknown_var spNavEntity = childrenList[j];
				if (NULL_var != spNavEntity)
				{

					CATIPrdObject_var spPrd(childrenList[j]);
					if (NULL_var != spPrd)
					{
						CATIPLMNavReference * oReference = NULL;
						if (SUCCEEDED(spPrd->GetReferenceObject((CATBaseUnknown*&)oReference, IID_CATIPLMNavReference)))
						{

							if (FAILED(FindAndDeleteGSM(oReference)))
							{
								hr = E_FAIL;
							}
							else
							{
								RecursiveDelete(oReference);
							}
							oReference->Release(); oReference = NULL;
						}
					}
				}
				else
					hr = E_FAIL;

				pChild = childrenList[j];
				if (NULL != pChild)
				{
					pChild->Release();
					pChild = NULL;
				}
			}
		}
	}
	return hr;
}

HRESULT ATOZPipeProjAnnoCmd::FindAndDeleteGSM(CATIPLMNavReference *ipNavRef)
{
	HRESULT rc = E_INVALIDARG;

	if (NULL != ipNavRef)
	{
		rc = E_FAIL;

		CATListPtrCATIPLMNavEntity childrenList;
		CATPLMCoreType coreType = PLMCoreRepInstance;
		if (SUCCEEDED(ipNavRef->ListChildren(childrenList, 1, &coreType)))
		{
			int nbChildren = childrenList.Size();
			HRESULT hr = E_FAIL;
			rc = S_OK;
			for (int j = 1; j <= nbChildren; j++)
			{
				hr = E_FAIL;
				CATIPLMNavEntity * pNavEntity = childrenList[j];
				if (NULL != pNavEntity)
				{
					CATIPLMNavRepInstance * pNavRepInst = NULL;
					if (SUCCEEDED(pNavEntity->QueryInterface(IID_CATIPLMNavRepInstance, (void **)&pNavRepInst)))
					{
						CATIPLMNavRepReference * pNavRepRef = NULL;
						if (SUCCEEDED(pNavRepInst->GetRepReferenceInstanceOf(pNavRepRef)))
						{
							CATIPsiRepresentationLoadMode * pRepLoadMode = NULL;
							if (SUCCEEDED(pNavRepRef->QueryInterface(IID_CATIPsiRepresentationLoadMode, (void **)&pRepLoadMode)))
							{
								cout << "加载的3DShape 为" << CATIAlias_var(pRepLoadMode)->GetAlias() << endl;
								hr = pRepLoadMode->ChangeLoadingMode(CATIPsiRepresentationLoadMode::EditMode);
								pRepLoadMode->Release();
								pRepLoadMode = NULL;
							}
							CATIMmiPrtContainer * piPrtContainer = NULL;
							rc = pNavRepRef->RetrieveApplicativeContainer("CATPrtCont", IID_CATIMmiPrtContainer, (void **)&piPrtContainer);
							if (SUCCEEDED(rc) && (NULL != piPrtContainer))
							{
								CATIMmiMechanicalFeature_var spMechFeature = NULL_var;
								piPrtContainer->GetMechanicalPart(spMechFeature);
								piPrtContainer->Release();
								piPrtContainer = NULL;

								CATIMmiUsePrtPart_var spPartFeature = spMechFeature;
								CATIMmiMechanicalFeature_var spGsmTool(NULL_var);
								CAAGsiGetGeometricFeatureSets(spPartFeature, "管道中心线", spGsmTool);
								if (NULL_var != spGsmTool) {
									cout << "找到几何图形集" << endl;
									::DeleteAnything(spGsmTool);
									spGsmTool = NULL_var;
								}
							}
							pNavRepRef->Release();
							pNavRepRef = NULL;
						}
						pNavRepInst->Release();
						pNavRepInst = NULL;
					}

					pNavEntity->Release();
					pNavEntity = NULL;
				}
				if (FAILED(hr))    rc = hr;
			}
		}
	}

	return rc;
}